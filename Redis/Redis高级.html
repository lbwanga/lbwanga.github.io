
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="个人笔记，博客">
      
      
        <meta name="author" content="wang">
      
      
        <link rel="canonical" href="https://lbwanga.github.io/Redis/Redis%E9%AB%98%E7%BA%A7.html">
      
      
        <link rel="prev" href="%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html">
      
      
        <link rel="next" href="%E5%BA%94%E7%94%A8.html">
      
      
      <link rel="icon" href="../assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Redis高级 - WNotes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XXXXXXXXXX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#redis高级" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../index.html" title="WNotes" class="md-header__button md-logo" aria-label="WNotes" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            WNotes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Redis高级
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/lbwanga/lbwanga.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    lbwanga
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../index.html" class="md-tabs__link">
        
  
  
    
  
  简介

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../Java/Java.html" class="md-tabs__link">
          
  
  
  Java

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../JUC/JUC.html" class="md-tabs__link">
        
  
  
    
  
  JUC

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../JVM/JVM.html" class="md-tabs__link">
        
  
  
    
  
  JVM

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../MySQL/MySQL.html" class="md-tabs__link">
        
  
  
    
  
  MySQL

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="Redis%E5%9F%BA%E7%A1%80.html" class="md-tabs__link">
          
  
  
  Redis

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../ES/ES.html" class="md-tabs__link">
        
  
  
    
  
  ES

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html" class="md-tabs__link">
        
  
  
    
  
  设计模式

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../Spring/Spring6.html" class="md-tabs__link">
        
  
  
    
  
  Spring

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../SpringMVC/SpringMVC.html" class="md-tabs__link">
        
  
  
    
  
  SpringMVC

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../SpringBoot/SpringBoot.html" class="md-tabs__link">
        
  
  
    
  
  SpringBoot

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../RocketMQ/RocketMQ.html" class="md-tabs__link">
        
  
  
    
  
  RocketMQ

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.html" class="md-tabs__link">
        
  
  
    
  
  计算机网络

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.html" class="md-tabs__link">
        
  
  
    
  
  操作系统

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/DDD.html" class="md-tabs__link">
        
  
  
    
  
  DDD

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../%E5%90%8E%E7%AB%AF%E5%9C%BA%E6%99%AF/%E5%9C%BA%E6%99%AF.html" class="md-tabs__link">
        
  
  
    
  
  后端场景

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="WNotes" class="md-nav__button md-logo" aria-label="WNotes" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    WNotes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lbwanga/lbwanga.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    lbwanga
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    简介
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Java
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Java/Java.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Java/Java%E9%9B%86%E5%90%88.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java集合
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../JUC/JUC.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JUC
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../JVM/JVM.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JVM
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../MySQL/MySQL.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MySQL
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Redis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Redis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="Redis%E5%9F%BA%E7%A1%80.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Redis基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Redis数据结构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Redis高级
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="Redis%E9%AB%98%E7%BA%A7.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Redis高级
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#redis高级" class="md-nav__link">
    <span class="md-ellipsis">
      Redis高级
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Redis高级">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redis单线程" class="md-nav__link">
    <span class="md-ellipsis">
      Redis单线程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Redis单线程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redis-采用单线程为什么还这么快" class="md-nav__link">
    <span class="md-ellipsis">
      Redis 采用单线程为什么还这么快？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis60之前一直采用单线程的主要原因" class="md-nav__link">
    <span class="md-ellipsis">
      Redis6.0之前一直采用单线程的主要原因
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#为什么逐渐加入多线程特性" class="md-nav__link">
    <span class="md-ellipsis">
      为什么逐渐加入多线程特性？
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bigkey" class="md-nav__link">
    <span class="md-ellipsis">
      BigKey
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#热点key" class="md-nav__link">
    <span class="md-ellipsis">
      热点key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#缓存双写一致性缓存更新策略" class="md-nav__link">
    <span class="md-ellipsis">
      缓存双写一致性（缓存更新策略）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="缓存双写一致性（缓存更新策略）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#常见的缓存更新策略" class="md-nav__link">
    <span class="md-ellipsis">
      常见的缓存更新策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#数据库和缓存一致性的几种更新策略" class="md-nav__link">
    <span class="md-ellipsis">
      数据库和缓存一致性的几种更新策略
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#缓存雪崩缓存击穿缓存穿透" class="md-nav__link">
    <span class="md-ellipsis">
      缓存雪崩/缓存击穿/缓存穿透
    </span>
  </a>
  
    <nav class="md-nav" aria-label="缓存雪崩/缓存击穿/缓存穿透">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#缓存雪崩" class="md-nav__link">
    <span class="md-ellipsis">
      缓存雪崩
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#缓存穿透" class="md-nav__link">
    <span class="md-ellipsis">
      缓存穿透
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#缓存击穿" class="md-nav__link">
    <span class="md-ellipsis">
      缓存击穿
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#缓存过期删除内存淘汰策略" class="md-nav__link">
    <span class="md-ellipsis">
      缓存过期删除/内存淘汰策略
    </span>
  </a>
  
    <nav class="md-nav" aria-label="缓存过期删除/内存淘汰策略">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#过期删除策略" class="md-nav__link">
    <span class="md-ellipsis">
      过期删除策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#内存淘汰策略" class="md-nav__link">
    <span class="md-ellipsis">
      内存淘汰策略
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#布隆过滤器" class="md-nav__link">
    <span class="md-ellipsis">
      布隆过滤器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#分布式锁" class="md-nav__link">
    <span class="md-ellipsis">
      分布式锁
    </span>
  </a>
  
    <nav class="md-nav" aria-label="分布式锁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redisson" class="md-nav__link">
    <span class="md-ellipsis">
      Redisson
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redlock" class="md-nav__link">
    <span class="md-ellipsis">
      RedLock
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#过期键" class="md-nav__link">
    <span class="md-ellipsis">
      过期键
    </span>
  </a>
  
    <nav class="md-nav" aria-label="过期键">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redis-持久化时对过期键会如何处理的" class="md-nav__link">
    <span class="md-ellipsis">
      Redis 持久化时，对过期键会如何处理的？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis-主从模式中对过期键会如何处理" class="md-nav__link">
    <span class="md-ellipsis">
      Redis 主从模式中，对过期键会如何处理？
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="%E5%BA%94%E7%94%A8.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Redis应用
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ES/ES.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ES
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    设计模式
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Spring/Spring6.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Spring
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../SpringMVC/SpringMVC.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SpringMVC
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../SpringBoot/SpringBoot.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SpringBoot
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../RocketMQ/RocketMQ.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RocketMQ
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    计算机网络
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    操作系统
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/DDD.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DDD
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%90%8E%E7%AB%AF%E5%9C%BA%E6%99%AF/%E5%9C%BA%E6%99%AF.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    后端场景
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#redis高级" class="md-nav__link">
    <span class="md-ellipsis">
      Redis高级
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Redis高级">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redis单线程" class="md-nav__link">
    <span class="md-ellipsis">
      Redis单线程
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Redis单线程">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redis-采用单线程为什么还这么快" class="md-nav__link">
    <span class="md-ellipsis">
      Redis 采用单线程为什么还这么快？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis60之前一直采用单线程的主要原因" class="md-nav__link">
    <span class="md-ellipsis">
      Redis6.0之前一直采用单线程的主要原因
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#为什么逐渐加入多线程特性" class="md-nav__link">
    <span class="md-ellipsis">
      为什么逐渐加入多线程特性？
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bigkey" class="md-nav__link">
    <span class="md-ellipsis">
      BigKey
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#热点key" class="md-nav__link">
    <span class="md-ellipsis">
      热点key
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#缓存双写一致性缓存更新策略" class="md-nav__link">
    <span class="md-ellipsis">
      缓存双写一致性（缓存更新策略）
    </span>
  </a>
  
    <nav class="md-nav" aria-label="缓存双写一致性（缓存更新策略）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#常见的缓存更新策略" class="md-nav__link">
    <span class="md-ellipsis">
      常见的缓存更新策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#数据库和缓存一致性的几种更新策略" class="md-nav__link">
    <span class="md-ellipsis">
      数据库和缓存一致性的几种更新策略
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#缓存雪崩缓存击穿缓存穿透" class="md-nav__link">
    <span class="md-ellipsis">
      缓存雪崩/缓存击穿/缓存穿透
    </span>
  </a>
  
    <nav class="md-nav" aria-label="缓存雪崩/缓存击穿/缓存穿透">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#缓存雪崩" class="md-nav__link">
    <span class="md-ellipsis">
      缓存雪崩
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#缓存穿透" class="md-nav__link">
    <span class="md-ellipsis">
      缓存穿透
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#缓存击穿" class="md-nav__link">
    <span class="md-ellipsis">
      缓存击穿
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#缓存过期删除内存淘汰策略" class="md-nav__link">
    <span class="md-ellipsis">
      缓存过期删除/内存淘汰策略
    </span>
  </a>
  
    <nav class="md-nav" aria-label="缓存过期删除/内存淘汰策略">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#过期删除策略" class="md-nav__link">
    <span class="md-ellipsis">
      过期删除策略
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#内存淘汰策略" class="md-nav__link">
    <span class="md-ellipsis">
      内存淘汰策略
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#布隆过滤器" class="md-nav__link">
    <span class="md-ellipsis">
      布隆过滤器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#分布式锁" class="md-nav__link">
    <span class="md-ellipsis">
      分布式锁
    </span>
  </a>
  
    <nav class="md-nav" aria-label="分布式锁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redisson" class="md-nav__link">
    <span class="md-ellipsis">
      Redisson
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redlock" class="md-nav__link">
    <span class="md-ellipsis">
      RedLock
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#过期键" class="md-nav__link">
    <span class="md-ellipsis">
      过期键
    </span>
  </a>
  
    <nav class="md-nav" aria-label="过期键">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#redis-持久化时对过期键会如何处理的" class="md-nav__link">
    <span class="md-ellipsis">
      Redis 持久化时，对过期键会如何处理的？
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis-主从模式中对过期键会如何处理" class="md-nav__link">
    <span class="md-ellipsis">
      Redis 主从模式中，对过期键会如何处理？
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
    <a href="https://github.com/lbwanga/lbwanga.github.io/edit/master/docs/Redis/Redis高级.md" title="编辑此页" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


  <h1>Redis高级</h1>

<h2 id="redis高级">Redis高级<a class="headerlink" href="#redis高级" title="Permanent link"></a></h2>
<h3 id="redis单线程">Redis单线程<a class="headerlink" href="#redis单线程" title="Permanent link"></a></h3>
<p><strong>Redis 单线程指的是「接收客户端请求-&gt;解析请求 -&gt;进行数据读写等操作-&gt;发送数据给客户端」这个过程是由一个线程（主线程）来完成的</strong>。</p>
<p>但Redis的其他功能，比如<strong>关闭文件、AOF 刷盘、释放内存</strong>等，其实是由额外的线程执行的。例如执行 unlink key / flushdb async/ flushall async 等命令，会把这些删除操作交给后台线程来执行，好处是不会导致 Redis 主线程卡顿。</p>
<p><strong>Redis命令工作线程是单线程的，但是，整个Redis来说，是多线程的；</strong></p>
<p>之所以 Redis 为「关闭文件、AOF 刷盘、释放内存」这些任务创建单独的线程来处理，是因为这些任务的操作都是很耗时的，如果把这些任务都放在主线程来处理，那么 Redis 主线程就很容易发生阻塞，这样就无法处理后续的请求了。</p>
<h4 id="redis-采用单线程为什么还这么快">Redis 采用单线程为什么还这么快？<a class="headerlink" href="#redis-采用单线程为什么还这么快" title="Permanent link"></a></h4>
<ol>
<li><strong>基于内存操作</strong>: Redis 的所有数据都存在内存中，因此所有的运算都是内存级别的，所以他的性能比较高； </li>
<li><strong>数据结构简单</strong>: Redis 的数据结构是专门设计的，而这些简单的数据结构的查找和操作的时间大部分复杂度都是 0(1)，因此性能比较高；</li>
<li>Redis <strong>采用单线程模型可以避免了多线程之间的竞争</strong>，省去了多线程切换带来的时间和性能上的开销，而且也不会导致死锁问题。</li>
<li><strong>多路复用和非阻塞 I/O</strong>: Redis使用 I/O多路复用功能来监听多个 socket连接客户端，这样就可以使用一个线程来检查多个 Socket 的就绪状态，在单个线程中通过记录跟踪每一个 socket（I/O流）的状态来管理处理多个 I/O 流，减少线程切换带来的开销，同时也避免了 I/O 阻塞操作；</li>
</ol>
<h4 id="redis60之前一直采用单线程的主要原因">Redis6.0之前一直采用单线程的主要原因<a class="headerlink" href="#redis60之前一直采用单线程的主要原因" title="Permanent link"></a></h4>
<ol>
<li>使用单线程模型是 Redis 的开发和维护更简单，因为单线程模型方便开发和调试；</li>
<li>即使使用单线程模型也并发的处理多客户端的请求，主要使用的是IO多路复用和非阻塞IO；</li>
<li>对于Redis系统来说，主要的性能瓶颈是内存或者网络带宽而并非 CPU。</li>
</ol>
<h4 id="为什么逐渐加入多线程特性">为什么逐渐加入多线程特性？<a class="headerlink" href="#为什么逐渐加入多线程特性" title="Permanent link"></a></h4>
<p>删除一个很大的数据时，因为是单线程原子命令操作，这就会导致 Redis 服务卡顿，于是在 Redis 4.0 中就新增了多线程的模块，主要是为了解决删除数据效率比较低的问题的。</p>
<p>使用惰性删除可以有效的解决性能问题, 在Redis4.0就引入了多个线程来实现数据的异步惰性删除等功能</p>
<div class="language-sh highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a>unlink<span class="w"> </span>key<span class="w">     </span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2"></a>flushdb<span class="w"> </span>async<span class="w">  </span>
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3"></a>flushall<span class="w"> </span>async<span class="w"> </span>
</span></code></pre></div></td></tr></table></div>
<p><strong>但是其处理读写请求的仍然只有一个线程</strong>，所以仍然算是狭义上的单线程。</p>
<p>在Redis6/7中引入了I/0多线程的读写，这样就可以更加高效的处理更多的任务了，Redis只是将I/O读写变成了多线程，而命令的执行依旧是由主线程串行执行的，因此在多线程下操作 Redis不会出现线程安全的问题。</p>
<p>多线程开启:</p>
<ol>
<li>设置<code>io-thread-do-reads</code>配置项为yes，表示启动多线程。</li>
<li>设置线程个数 <code>io-threads</code>。关于线程数的设置，官方的建议是如果为4核的CPU，建议线程数设置为2或3，如果为8核CPU建议线程数设置为6，安程数一定要小于机器核数，线程数并不是越大越好。</li>
</ol>
<p>因此， Redis 6.0 版本之后，Redis 在启动的时候，默认情况下会<strong>额外创建 6 个线程</strong>（<em>这里的线程数不包括主线程</em>）：</p>
<ul>
<li>Redis-server ： Redis的主线程，主要负责执行命令；</li>
<li>bio_close_file、bio_aof_fsync、bio_lazy_free：三个后台线程，分别异步处理关闭文件任务、AOF刷盘任务、释放内存任务；</li>
<li>io_thd_1、io_thd_2、io_thd_3：三个 I/O 线程，io-threads 默认是 4 ，所以会启动 3（4-1）个 I/O 多线程，用来分担 Redis 网络 I/O 的压力。</li>
</ul>
<h3 id="_1"><a class="headerlink" href="#_1" title="Permanent link"></a></h3>
<h3 id="bigkey">BigKey<a class="headerlink" href="#bigkey" title="Permanent link"></a></h3>
<p><strong>多大算BigKey？</strong></p>
<p>bigkey是指key对应的value所占的内存空间比较大</p>
<p><a class="glightbox" href="Redis\阿里云Redis开发规范.jpg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Redis\阿里云Redis开发规范.jpg" /></a></p>
<p><strong>大 key 会带来的影响：</strong></p>
<ol>
<li><strong>内存占用过高</strong>。大Key占用过多的内存空间，可能导致可用内存不足，从而触发内存淘汰策略。</li>
<li><strong>性能下降</strong>。对于大Key的操作，如读取、写入、删除等，都会消耗更多的CPU时间和内存资源，进一步降低系统性能。</li>
<li><strong>阻塞工作线程</strong>。如果使用 del 删除大 key 时，会阻塞工作线程，这样就没办法处理后续的命令。</li>
<li><strong>引发网络阻塞</strong>。每次获取大 key 产生的网络流量较大，如果一个 key 的大小是 1 MB，每秒访问量为 1000，那么每秒会产生 1000MB 的流量，这对于普通千兆网卡的服务器来说是灾难性的。</li>
<li><strong>主从同步延迟</strong>。由于大Key占用较多内存，同步过程中需要传输大量数据，这会导致主从之间的网络传输延迟增加，进而影响数据一致性。</li>
<li><strong>数据倾斜</strong>。在Redis集群模式中，某个数据分片的内存使用率远超其他数据分片，无法使数据分片的内存资源达到均衡。</li>
</ol>
<p><strong>如何发现BigKey？</strong></p>
<p>redis-cli --bigkey</p>
<div class="language-sh highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1"># 加上 -i 参数，每隔100 条 scan指令就会休眠0.1s. ops就不会剧烈抬升，但是扫描的时间会变长</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a>redis-cli<span class="w"> </span>-h<span class="w"> </span><span class="m">127</span>.0.0.1<span class="w"> </span>-p<span class="w"> </span><span class="m">6379</span><span class="w"> </span>--bigkeys<span class="w"> </span>-i<span class="w"> </span><span class="m">0</span>.1
</span></code></pre></div></td></tr></table></div>
<p>最好选择在从节点上执行该命令。因为主节点上执行时，会阻塞主节点；</p>
<p>如果没有从节点，那么可以选择在 Redis 实例业务压力的低峰阶段进行扫描查询，以免影响到实例的正常运行；或者可以使用 -i 参数控制扫描间隔，避免长时间扫描降低 Redis 实例的性能。</p>
<p><strong>BigKey如何删除？</strong></p>
<p>分批次删除和异步删除</p>
<ul>
<li>
<p>String：一般用del，如果过于庞大使用unlink key 删除</p>
</li>
<li>
<p>hash</p>
</li>
</ul>
<p>使用 hscan 每次获取部分field-value，再使用 hdel 删除每个field， 最后删除field-value</p>
<ul>
<li>list</li>
</ul>
<p>使用 ltrim 渐进式逐步删除，直到全部删除完成</p>
<ul>
<li>set</li>
</ul>
<p>使用 sscan 每次获取部分元素，再使用 srem 命令删除每个元素</p>
<ul>
<li>zset</li>
</ul>
<p>使用 zscan 每次获取部分元素，在使用 zremrangebyrank 命令删除每个元素</p>
<p><strong>生产上限制 keys * /flushdb/flushall等危险命令以防止误删误用？</strong></p>
<p>通过配置设置禁用这些命令，redis.conf在SECURITY这一项中</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a>rename-command keys &quot;&quot;
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a>rename-command flushdb &quot;&quot;
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a>rename-command flushall &quot;&quot;
</span></code></pre></div></td></tr></table></div>
<p><strong>不用keys *避免卡顿，那该用什么?</strong> <code>scan, sscan, hscan, zscan</code></p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a>scan cursor [MATCH pattern] [COUNT count]
</span></code></pre></div></td></tr></table></div>
<ul>
<li>cursor : 游标</li>
<li>pattern：匹配的模式</li>
<li>count：指定数据集返回多少数据，默认10</li>
</ul>
<p>SCAN 命令是一个基于游标的迭代器，每次被调用之后， 都会向用户返回一个新的游标， 用户在下次迭代时需要使用这个新游标作为 SCAN 命令的游标参数， 以此来延续之前的迭代过程。</p>
<p>SCAN的遍历顺序非常特别，它不是从第一维数组的第零位一直遍历到末尾，而是采用了高位进位加法来遍历。之所以使用这样特殊的方式进行遍历，是考虑到字典的扩容和缩容时避免槽位的遍历重复和遗漏。</p>
<p><strong>分别说说三种写回策略，在持久化 BigKey 的时候，会影响什么？</strong></p>
<ul>
<li>Always 策略就是每次写入 AOF 文件数据后，就执行 fsync() 函数；</li>
<li>Everysec 策略就会创建一个异步任务来执行 fsync() 函数；</li>
<li>No 策略就是永不执行 fsync() 函数;</li>
</ul>
<p>当使用 Always 策略的时候，如果写入是一个大 Key，主线程在执行 fsync() 函数的时候，阻塞的时间会比较久，因为当写入的数据量很大的时候，数据同步到硬盘这个过程是很耗时的。</p>
<p>当使用 Everysec 策略的时候，由于是异步执行 fsync() 函数，所以大 Key 持久化的过程（数据同步磁盘）不会影响主线程。</p>
<p>当使用 No 策略的时候，由于永不执行 fsync() 函数，所以大 Key 持久化的过程不会影响主线程</p>
<p>AOF 重写机制和 RDB 快照（bgsave 命令）的过程，都会分别通过 <code>fork()</code> 函数创建一个子进程来处理任务。会有两个阶段会导致阻塞父进程（主线程）：</p>
<ul>
<li>创建子进程的途中，由于要复制父进程的页表等数据结构，阻塞的时间跟页表的大小有关，页表越大，阻塞的时间也越长；</li>
<li>创建完子进程后，如果父进程修改了共享数据中的大 Key，就会发生写时复制，这期间会拷贝物理内存，由于大 Key 占用的物理内存会很大，那么在复制物理内存这一过程，就会比较耗时，所以有可能会阻塞父进程。</li>
</ul>
<h3 id="热点key">热点key<a class="headerlink" href="#热点key" title="Permanent link"></a></h3>
<p>如果一个key的访问频率占比过大，或带宽占比过大，都属于热点key。</p>
<p><strong>如何发现热点key？</strong></p>
<ol>
<li>根据业务经验进行分析</li>
<li>redis集群监控</li>
<li>使用 <code>hotkey</code> 监控：<code>redis-cli --hotkeys</code></li>
<li>客户端收集：操作redis时加上统计查询频次的逻辑</li>
<li>代理层收集</li>
</ol>
<p><strong>如何解决热点key问题？</strong></p>
<ol>
<li>热点key拆分：将热点数据拆分到多个key中，例如通过引入随机前缀，使不同用户请求分散到多个key，多个key分布在多实例中，避免集中访问单一key。</li>
<li>多级缓存：增加本地缓存分担redis压力</li>
<li>读写分离：通过主从复制，将读请求分散到多个从节点</li>
<li>限流和降级：热点key访问过高时，应用限流策略，减少redis请求，或者必要时返回降级的数据或空值。</li>
</ol>
<h3 id="缓存双写一致性缓存更新策略">缓存双写一致性（缓存更新策略）<a class="headerlink" href="#缓存双写一致性缓存更新策略" title="Permanent link"></a></h3>
<p>对于读数据，选择旁路缓存策略，如果 cache 不命中，会从 db 加载数据到 cache。对于写数据，选择更新 db 后，再删除缓存。</p>
<h4 id="常见的缓存更新策略">常见的缓存更新策略<a class="headerlink" href="#常见的缓存更新策略" title="Permanent link"></a></h4>
<ul>
<li>Cache Aside（旁路缓存）策略；</li>
<li>Read/Write Through（读穿 / 写穿）策略；</li>
<li>Write Back（写回）策略；</li>
</ul>
<p><strong>Cache Aside（旁路缓存）</strong></p>
<p>Cache Aside（旁路缓存）策略是最常用的，应用程序直接与「数据库、缓存」交互，并负责对缓存的维护，该策略又可以细分为「读策略」和「写策略」。</p>
<p>写策略的步骤：</p>
<ul>
<li>先更新数据库中的数据，再删除缓存中的数据。</li>
</ul>
<p>读策略的步骤：</p>
<ul>
<li>如果读取的数据命中了缓存，则直接返回数据；</li>
<li>如果读取的数据没有命中缓存，则从数据库中读取数据，然后将数据写入到缓存，并且返回给用户。</li>
</ul>
<p><strong>Read/Write Through（读穿 / 写穿）策略</strong></p>
<p>Read/Write Through（读穿 / 写穿）策略原则是应用程序只和缓存交互，不再和数据库交互，而是由缓存和数据库交互，相当于更新数据库的操作由缓存自己代理了。</p>
<p>Read Through 策略：</p>
<p>先查询缓存中数据是否存在，如果存在则直接返回，如果不存在，则由缓存组件负责从数据库查询数据，并将结果写入到缓存组件，最后缓存组件将数据返回给应用。</p>
<p>Write Through 策略：</p>
<p>当有数据更新的时候，先查询要写入的数据在缓存中是否已经存在：</p>
<ul>
<li>如果缓存中数据已经存在，则更新缓存中的数据，并且由缓存组件同步更新到数据库中，然后缓存组件告知应用程序更新完成。</li>
<li>如果缓存中数据不存在，直接更新数据库，然后返回；</li>
</ul>
<p><strong>Write Back（写回）策略</strong></p>
<p>Write Back（写回）策略在更新数据的时候，只更新缓存，同时将缓存数据设置为脏的，然后立马返回，并不会更新数据库。对于数据库的更新，会通过批量异步更新的方式进行。</p>
<p>Write Back 是计算机体系结构中的设计，比如 CPU 的缓存、操作系统中文件系统的缓存都采用了 Write Back（写回）策略。</p>
<p><strong>Write Back 策略特别适合写多的场景</strong>，因为发生写操作的时候， 只需要更新缓存，就立马返回了。比如，写文件的时候，实际上是写入到文件系统的缓存就返回了，并不会写磁盘。<strong>但是带来的问题是，数据不是强一致性的，而且会有数据丢失的风险</strong>。</p>
<h4 id="数据库和缓存一致性的几种更新策略"><strong>数据库和缓存一致性的几种更新策略</strong><a class="headerlink" href="#数据库和缓存一致性的几种更新策略" title="Permanent link"></a></h4>
<p><strong>1. 先更新数据库，再更新缓存</strong></p>
<p>问题：数据不一致</p>
<p>多线程下</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a>【正常逻辑】
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2"></a>1 A update mysql 100
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3"></a>2 A update redis 100
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4"></a>3 B update mysql 80
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5"></a>4 B update redis 80
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6"></a>=============================
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7"></a>【异常逻辑】多线程环境下，A、B两个线程有快有慢，有前有后有并行
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8"></a>1 A update mysql 100
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9"></a>3 B update mysql 80
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10"></a>4 B update redis 80
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11"></a>2 A update redis 100
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12"></a>=============================
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13"></a>最终结果，mysql和redis数据不一致: mysql80,redis100
</span></code></pre></div></td></tr></table></div>
<p><strong>2. 先更新缓存，再更新数据库</strong></p>
<p>问题：数据不一致</p>
<p>多线程下</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a>【正常逻辑】
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2"></a>1 A update redis 100
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3"></a>2 A update mysql 100
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4"></a>3 B update redis 80
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5"></a>4 B update mysql 80
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6"></a>====================================
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7"></a>【异常逻辑】多线程环境下，A、B两个线程有快有慢有并行
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8"></a>A update redis  100
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9"></a>B update redis  80
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10"></a>B update mysql 80
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11"></a>A update mysql 100
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12"></a>====================================
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13"></a>----mysql100,redis80
</span></code></pre></div></td></tr></table></div>
<p><strong>3. 先删除缓存，再更新数据库</strong></p>
<p>问题：数据不一致</p>
<p>多线程下</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1">1</a></span>
<span class="normal"><a href="#__codelineno-6-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a>A删除缓存后，B查询操作没有命中缓存，B先把老数据读出来后放到缓存中，然后A更新操作更新了数据库。
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a>于是，在缓存中的数据还是老的数据，数据库的数据是新数据
</span></code></pre></div></td></tr></table></div>
<p>解决方案：</p>
<ol>
<li>延时双删策略：</li>
</ol>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a># 1.删除缓存
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a>redis.delKey(X)
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a># 2.更新数据库
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4"></a>db.update(X)
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5"></a># 3.一段时间后再删除缓存
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6"></a>Thread.sleep(N)
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7"></a>redis.delKey(X)
</span><span id="__span-7-8"><a id="__codelineno-7-8" name="__codelineno-7-8"></a>
</span><span id="__span-7-9"><a id="__codelineno-7-9" name="__codelineno-7-9"></a>线程A删除并更新数据库后等待一段时间，B将数据库数据写入缓存后，A再删除。
</span><span id="__span-7-10"><a id="__codelineno-7-10" name="__codelineno-7-10"></a>等待时间大于B读取并写入时间。如何获取？评估耗时；后台监控程序（WatchDog）
</span><span id="__span-7-11"><a id="__codelineno-7-11" name="__codelineno-7-11"></a>第二次删除可以使用异步删除，可以增加吞吐量
</span></code></pre></div></td></tr></table></div>
<p><strong>4. 先更新数据库，再删除缓存</strong></p>
<p>问题：数据不一致</p>
<p>多线程下</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a>假如某个用户数据在缓存中不存在，请求 A 读取数据时从数据库中查询到年龄为 20，在未写入缓存中时另一个请求 B 更新数据。它更新数据库中的年龄为 21，并且清空缓存。这时请求 A 把从数据库中读到的年龄为 20 的数据写入到缓存中。
</span></code></pre></div></td></tr></table></div>
<p>但是在实际中，这个问题出现的概率并不高。因为缓存的写入通常要远远快于数据库的写入</p>
<p>针对删除缓存异常的情况，解决方案：</p>
<ol>
<li>重试机制：引入消息队列把删除缓存要操作的数据加入消息队列，删除缓存失败则从队列中重新读取数据再次删除，删除成功就从队列中移除</li>
<li>订阅MySql binlog，再操作缓存：更新数据库成功，就会产生一条变更日志，记录在 binlog 里。订阅 binlog 日志，拿到具体要操作的数据，然后再执行缓存删除。Canal。</li>
</ol>
<h3 id="缓存雪崩缓存击穿缓存穿透">缓存雪崩/缓存击穿/缓存穿透<a class="headerlink" href="#缓存雪崩缓存击穿缓存穿透" title="Permanent link"></a></h3>
<h4 id="缓存雪崩">缓存雪崩<a class="headerlink" href="#缓存雪崩" title="Permanent link"></a></h4>
<p>redis故障或者redis中大量的缓存数据同时失效，导致大量的请求直接打到数据库或其他后端系统，造成系统性能急剧下降甚至宕机的现象。</p>
<p>解决：</p>
<ol>
<li>
<p>大量数据同时过期：</p>
</li>
<li>
<p>均匀设置过期时间或不过期：设置过期时间时可以加上一个随机数</p>
</li>
<li>
<p>互斥锁：保证同一时间只有一个请求访问数据库来构建缓存</p>
</li>
<li>
<p>后台更新缓存：业务线程不再负责更新缓存，缓存也不设置有效期，而是让缓存“永久有效”，并将更新缓存的工作交由后台线程定时更新。</p>
</li>
<li>
<p>redis故障</p>
</li>
<li>
<p>缓存集群高可用：哨兵、集群</p>
</li>
<li>
<p>服务降级、熔断</p>
</li>
</ol>
<h4 id="缓存穿透">缓存穿透<a class="headerlink" href="#缓存穿透" title="Permanent link"></a></h4>
<p>缓存穿透是指查询一个根本不存在的数据，缓存层和存储层都不会命中。缓存穿透将导致不存在的数据每次请求都要到存储层去查询，失去了缓存保护后端存储的意义，可能会使后端存储负载加大，甚至可能造成后端存储宕掉。</p>
<p>造成缓存穿透的基本原因有两个。第一，自身业务代码或者数据出现问题，第二，一些恶意攻击、爬虫等造成大量空命中。</p>
<p>解决：</p>
<ol>
<li>缓存空对象或缺省值：存储层不命中后，仍然将空对象或缺省值保留到缓存层中，之后再访问这个数据将会从缓存中获取。</li>
</ol>
<blockquote>
<p>缓存空对象会有两个问题：第一，空值做了缓存，意味着缓存层中存了更多的键，需要更多的内存空间（如果是攻击，问题更严重），比较有效的方法是针对这类数据设置一个较短的过期时间，让其自动剔除。第二，缓存层和存储层的数据会有一段时间窗口的不一致，可能会对业务有一定影响。</p>
</blockquote>
<ol>
<li>
<p>布隆过滤器：Google布隆过滤器Guava解决缓存穿透 <a href="https://github.com/google/guava/blob/master/guava/src/com/google/common/hash/BloomFilter.java">guava</a></p>
</li>
<li>
<p>参数校验：在接口层对请求参数进行严格校验，过滤掉明显不合法的请求</p>
</li>
<li>
<p>增强id复杂度，避免被猜测id规律（可以采用雪花算法）</p>
</li>
<li>
<p>做好数据的基础格式校验</p>
</li>
<li>
<p>加强用户权限校验</p>
</li>
<li>
<p>做好热点参数的限流</p>
</li>
</ol>
<h4 id="缓存击穿">缓存击穿<a class="headerlink" href="#缓存击穿" title="Permanent link"></a></h4>
<p>缓存击穿是指某些热点数据由于访问量大，且该数据的缓存刚好在某一时刻失效，导致大量并发请求同时击中数据库，从而造成数据库瞬时压力过大甚至宕机的现象。</p>
<p>与缓存雪崩不同，缓存击穿主要集中在某一条或少量几条缓存失效的热点数据上。</p>
<p>解决：</p>
<ol>
<li>差异失效时间：开辟两块缓存，设置不同的缓存过期时间，主A从B，先更新B再更新A，先查询A没有再查询B</li>
<li>加锁策略，保证同一时间只有一个业务线程更新缓存</li>
<li>不给热点数据设置过期时间，后台更新缓存</li>
<li>接口限流、熔断与降级</li>
</ol>
<h3 id="缓存过期删除内存淘汰策略">缓存过期删除/内存淘汰策略<a class="headerlink" href="#缓存过期删除内存淘汰策略" title="Permanent link"></a></h3>
<p><strong>redis默认内存多少可用？</strong></p>
<p>如果不设置最大内存或者设置最大内存大小为0，在64位操作系统下不限制内存大小，在32位操作系统下最多使用3GB内存</p>
<p>注意：在64bit系统下，maxmemory设置为0表示不限制redis内存使用</p>
<p>一般推荐Redis设置内存为最大物理内存的&frac34;</p>
<p><strong>如何修改redis内存设置</strong>？</p>
<ol>
<li>
<p>通过修改文件配置 <code>maxmemory</code></p>
</li>
<li>
<p>通过命令修改，但是redis重启后会失效 <code>config set maxmemory SIZE</code></p>
</li>
</ol>
<p>什么命令查看redis内存使用情况：</p>
<p>info memory</p>
<p>config get maxmemory</p>
<h4 id="过期删除策略">过期删除策略<a class="headerlink" href="#过期删除策略" title="Permanent link"></a></h4>
<ol>
<li><strong>立即/定时删除</strong>：在设置 key 的过期时间时，同时创建一个定时事件，当时间到达时，由事件处理器自动执行 key 的删除操作。</li>
<li><strong>惰性删除</strong>：不主动删除过期键，每次从数据库访问 key 时，都检测 key 是否过期，如果过期则删除该 key。节省CPU成本，但存在内存泄露。</li>
<li><strong>定期删除</strong>：每隔一段时间「随机」从数据库中取出一定数量的 key 进行检查，并删除其中的过期key。超过一定比例则重复此操作。Redis 为了保证定期删除不会出现循环过度，导致线程卡死现象，为此增加了定期删除循环流程的时间上限，默认不会超过 25ms。缺点是难以确定删除操作执行的时长和频率。</li>
</ol>
<p><a class="glightbox" href="Redis/%E5%AE%9A%E6%9C%9F%E5%88%A0%E9%99%A4.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Redis/%E5%AE%9A%E6%9C%9F%E5%88%A0%E9%99%A4.png" /></a></p>
<ol>
<li>定时任务在每个数据库空间随机检查20个键，当发现过期时删除对应的键。</li>
<li>如果超过检查数25%的键过期，循环执行回收逻辑直到不足25%或运行超时为止，慢模式下超时时间为25毫秒。</li>
<li>如果之前回收键逻辑超时，则在Redis触发内部事件之前再次以快模式运行回收过期键任务，快模式下超时时间为1毫秒且2秒内只能运行1次。</li>
<li>快慢两种模式内部删除逻辑相同，只是执行的超时时间不同。</li>
</ol>
<p><strong>Redis 选择「惰性删除+定期删除」这两种策略配和使用</strong>，以求在合理使用 CPU 时间和避免内存浪费之间取得平衡。</p>
<h4 id="内存淘汰策略">内存淘汰策略<a class="headerlink" href="#内存淘汰策略" title="Permanent link"></a></h4>
<p>超过redis设置的最大内存，就会使用内存淘汰策略删除符合条件的key</p>
<p>LRU：最近最少使用页面置换算法，淘汰<strong>最长时间未被使用</strong>的页面，看页面最后一次被使用到发生调度的时间长短，首先淘汰最长时间未被使用的页面。</p>
<p>LFU：最近最不常用页面置换算法，淘汰<strong>一定时期内被访问次数最少</strong>的页面，看一定时间段内页面被使用的频率，淘汰一定时期内被访问次数最少的页</p>
<p>淘汰策略有哪些(Redis7版本)：</p>
<ol>
<li>noeviction：默认策略，不会删除任何数据，拒绝所有写入操作并返回客户端错误信息</li>
<li>对设置了过期时间的数据中进行淘汰</li>
<li>LRU</li>
<li>LFU</li>
<li>random</li>
<li>TTL：优先淘汰更早过期的key</li>
<li>全部数据进行淘汰</li>
<li>LRU</li>
<li>LFU</li>
<li>random</li>
</ol>
<p><strong>如何修改 Redis 内存淘汰策略？</strong></p>
<ol>
<li>
<p><code>config set maxmemory-policy &lt;策略&gt;</code> 设置之后立即生效，不需要重启 Redis 服务，重启 Redis 之后，设置就会失效。</p>
</li>
<li>
<p>通过修改 Redis 配置文件修改，设置“<code>maxmemory-policy &lt;策略&gt;</code>”，它的优点是重启 Redis 服务后配置不会丢失，缺点是必须重启 Redis 服务，设置才能生效。</p>
</li>
</ol>
<p><strong>Redis 是如何实现 LRU 算法的？</strong></p>
<p>传统 LRU 算法的实现是基于「链表」结构，链表中的元素按照操作顺序从前往后排列，最新操作的键会被移动到表头，当需要内存淘汰时，只需要删除链表尾部的元素即可，因为链表尾部的元素就代表最久未被使用的元素。</p>
<p>Redis 并没有使用这样的方式实现 LRU 算法，因为传统的 LRU 算法存在两个问题：</p>
<ul>
<li>需要用链表管理所有的缓存数据，这会带来额外的空间开销；</li>
<li>当有数据被访问时，需要在链表上把该数据移动到头端，如果有大量数据被访问，就会带来很多链表移动操作，会很耗时，进而会降低 Redis 缓存性能。</li>
</ul>
<p>Redis 实现的是一种<strong>近似 LRU 算法</strong>，目的是为了更好的节约内存，它的<strong>实现方式是在 Redis 的对象结构体中添加一个额外的字段，用于记录此数据的最后一次访问时间</strong>。</p>
<p>当 Redis 进行内存淘汰时，会使用<strong>随机采样的方式来淘汰数据</strong>，它是随机取 N 个值，然后<strong>淘汰最久没有使用的那个</strong>。</p>
<p>Redis 实现的 LRU 算法的优点：</p>
<ul>
<li>不用为所有的数据维护一个大链表，节省了空间占用；</li>
<li>不用在每次数据访问时都移动链表项，提升了缓存的性能；</li>
</ul>
<p><strong>Redis 是如何实现 LFU 算法的？</strong></p>
<p>LFU 算法相比于 LRU 算法的实现，多记录了「数据的访问频次」的信息。</p>
<div class="language-c highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span>
<span class="normal"><a href="#__codelineno-9-6">6</a></span>
<span class="normal"><a href="#__codelineno-9-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">redisObject</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="c1">// 24 bits，用于记录对象的访问信息</span>
</span><span id="__span-9-5"><a id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="n">lru</span><span class="o">:</span><span class="mi">24</span><span class="p">;</span><span class="w">  </span>
</span><span id="__span-9-6"><a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="p">...</span>
</span><span id="__span-9-7"><a id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="p">}</span><span class="w"> </span><span class="n">robj</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<p>Redis 对象头中的 lru 字段，在 LRU 算法下和 LFU 算法下使用方式并不相同。</p>
<p><strong>在 LRU 算法中</strong>，Redis 对象头的 24 bits 的 lru 字段是用来记录 key 的访问时间戳，因此在 LRU 模式下，Redis可以根据对象头中的 lru 字段记录的值，来比较最后一次 key 的访问时间长，从而淘汰最久未被使用的 key。</p>
<p><strong>在 LFU 算法中</strong>，Redis对象头的 24 bits 的 lru 字段被分成两段来存储，高 16bit 存储 ldt(Last Decrement Time)，用来记录 key 的访问时间戳；低 8bit 存储 logc(Logistic Counter)，用来记录 key 的访问频次。</p>
<h3 id="布隆过滤器">布隆过滤器<a class="headerlink" href="#布隆过滤器" title="Permanent link"></a></h3>
<p>布隆过滤器由「初始值都为 0 的 bit 数组」和「 N 个哈希函数」两部分组成，用来快速判断集合是否存在某个元素。</p>
<p>当我们在写入数据库数据时，在布隆过滤器里做个标记，这样下次查询数据是否在数据库时，只需要查询布隆过滤器，如果查询到数据没有被标记，说明不在数据库中。</p>
<p>布隆过滤器会通过 3 个操作完成标记：</p>
<ul>
<li>第一步，使用 N 个哈希函数分别对数据做哈希计算，得到 N 个哈希值；</li>
<li>第二步，将第一步得到的 N 个哈希值对位图数组的长度取模，得到每个哈希值在位图数组的对应位置。</li>
<li>第三步，将每个哈希值在位图数组的对应位置的值设置为 1；</li>
</ul>
<p>一个元素如果判断结果：存在&rarr;元素可能存在；不存在&rarr;元素一定不存在</p>
<p>布隆过滤器只能添加元素，不能删除元素，因为布隆过滤器的bit位可能是共享的，删掉元素会影响其他元素导致误判率增加</p>
<p>应用场景：</p>
<ol>
<li>解决缓存穿透问题</li>
<li>黑白名单校验</li>
</ol>
<p>为了解决布隆过滤器不能删除元素的问题，布谷鸟过滤器横空出世。<a href="https://www.cs.cmu.edu/~binfan/papers/conext14_cuckoofilter.pdf#:~:text=Cuckoo%20%EF%AC%81lters%20support%20adding%20and%20removing%20items%20dynamically,have%20lower%20space%20overhead%20than%20space-optimized%20Bloom%20%EF%AC%81lters">https://www.cs.cmu.edu/~binfan/papers/conext14_cuckoofilter.pdf#:~:text=Cuckoo%20%EF%AC%81lters%20support%20adding%20and%20removing%20items%20dynamically,have%20lower%20space%20overhead%20than%20space-optimized%20Bloom%20%EF%AC%81lters</a>.</p>
<h3 id="分布式锁">分布式锁<a class="headerlink" href="#分布式锁" title="Permanent link"></a></h3>
<p><a href="https://redis.io/docs/latest/develop/use/patterns/distributed-locks/#implementations">https://redis.io/docs/latest/develop/use/patterns/distributed-locks/#implementations</a></p>
<p>基于 Redis 节点实现分布式锁时，对于加锁操作，我们需要满足三个条件。</p>
<ul>
<li>加锁包括了读取锁变量、检查锁变量值和设置锁变量值三个操作，但需要以原子操作的方式完成，所以，我们使用 SET 命令带上 NX 选项来实现加锁；</li>
<li>锁变量需要设置过期时间，以免客户端拿到锁后发生异常，导致锁一直无法释放，所以，我们在 SET 命令执行时加上 EX/PX 选项，设置其过期时间；</li>
<li>锁变量的值需要能区分来自不同客户端的加锁操作，以免在释放锁时，出现误释放操作，所以，我们使用 SET 命令设置锁变量值时，每个客户端设置的值是一个唯一值，用于标识客户端；</li>
</ul>
<p>满足这三个条件的分布式命令如下：</p>
<div class="language-sh highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a>SET<span class="w"> </span>lock_key<span class="w"> </span>unique_value<span class="w"> </span>NX<span class="w"> </span>PX<span class="w"> </span><span class="m">10000</span><span class="w"> </span>
</span></code></pre></div></td></tr></table></div>
<p>而解锁的过程就是将 lock_key 键删除（del lock_key），但不能乱删，要保证执行操作的客户端就是加锁的客户端。所以，解锁的时候，我们要先判断锁的 unique_value 是否为加锁客户端，是的话，才将 lock_key 键删除。</p>
<p>可以看到，解锁是有两个操作，这时就需要 Lua 脚本来保证解锁的原子性，因为 Redis 在执行 Lua 脚本时，可以以原子性的方式执行，保证了锁释放操作的原子性。</p>
<div class="language-lua highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span>
<span class="normal"><a href="#__codelineno-11-5">5</a></span>
<span class="normal"><a href="#__codelineno-11-6">6</a></span>
<span class="normal"><a href="#__codelineno-11-7">7</a></span>
<span class="normal"><a href="#__codelineno-11-8">8</a></span>
<span class="normal"><a href="#__codelineno-11-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1">-- 这里的 KEYS[1] 就是锁的key，这里的ARGV[1] 就是当前线程标示</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="c1">-- 获取锁中的标示，判断是否与当前线程标示一致</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nv">ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span><span class="c1">-- 一致，则删除锁</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">  </span><span class="kr">return</span><span class="w"> </span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;DEL&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="kr">else</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="w">  </span><span class="c1">-- 不一致，则直接返回</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">  </span><span class="kr">return</span><span class="w"> </span><span class="mi">0</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="kr">end</span>
</span></code></pre></div></td></tr></table></div>
<p>基于 Redis 实现分布式锁的<strong>优点</strong>：</p>
<ol>
<li>性能高效（这是选择缓存实现分布式锁最核心的出发点）。</li>
<li>实现方便。因为 Redis 提供了 setnx 方法，实现分布式锁很方便。</li>
</ol>
<p>基于 Redis 实现分布式锁的<strong>缺点</strong>：</p>
<ol>
<li>锁的可重入问题。</li>
<li>
<p>没有重试机制。</p>
</li>
<li>
<p>超时时间不好设置。可以基于续约的方式设置超时时间：先给锁设置一个超时时间，然后启动一个守护线程，让守护线程在一段时间后，重新设置这个锁的超时时间</p>
</li>
<li>
<p>Redis 主从复制模式中的数据是异步复制的，这样导致分布式锁的不可靠性。如果在 Redis 主节点获取到锁后，在没有同步到其他节点时，Redis 主节点宕机了，此时新的 Redis 主节点依然可以获取锁，所以多个应用服务就可以同时获取到锁。</p>
</li>
</ol>
<h4 id="redisson">Redisson<a class="headerlink" href="#redisson" title="Permanent link"></a></h4>
<p><strong>Redisson分布式锁原理</strong></p>
<p>可重入：利用hash结构记录线程id和重入次数</p>
<p>可重试：利用信号量和Pub/Sub功能实现等待、唤醒，获取锁失败的重试机制</p>
<p>超时续约：利用watchDog，每个一段时间（releaseTime），重置超时时间。</p>
<p><strong>Redisson可重入锁原理</strong></p>
<p>在分布式锁中，采用hash结构来存储锁，其中外层key表示这把锁是否存在，内层key则记录当前这把锁被哪个线程持有。</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a>lockKey -&gt; {thread: state} #如果持有这把锁的人(同一线程下)再次持有这把锁，那么state会+1
</span></code></pre></div></td></tr></table></div>
<p><strong>获取锁</strong>：</p>
<p>使用lua脚本，通过 <code>exists + hexists + hincrby</code> 保证只有一个线程成功设置键。</p>
<div class="language-lua highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span>
<span class="normal"><a href="#__codelineno-13-20">20</a></span>
<span class="normal"><a href="#__codelineno-13-21">21</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="kd">local</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="c1">-- 锁的key</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="kd">local</span><span class="w"> </span><span class="nv">threadId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span><span class="w"> </span><span class="c1">-- 线程唯一标识</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="kd">local</span><span class="w"> </span><span class="nv">releaseTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ARGV</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w"> </span><span class="c1">-- 锁的自动释放时间</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="c1">-- 锁不存在</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;exists&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">  </span><span class="c1">-- 获取锁并添加线程标识，state设为1</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">  </span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;hset&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">threadId</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">);</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">  </span><span class="c1">-- 设置锁有效期</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">  </span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;expire&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">releaseTime</span><span class="p">);</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">  </span><span class="kr">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- 返回结果</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="kr">end</span><span class="p">;</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="c1">-- 锁存在，判断threadId是否为自己</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;hexists&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">threadId</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="w">  </span><span class="c1">-- 锁存在，重入次数 +1，这里用的是hash结构的incrby增长</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">  </span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;hincrby&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">thread</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="w">  </span><span class="c1">-- 设置锁的有效期</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="w">  </span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;expire&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">releaseTime</span><span class="p">);</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="w">  </span><span class="kr">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">-- 返回结果</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="kr">end</span><span class="p">;</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="c1">-- 若锁存在，但唯一标识不匹配：表明锁是被其他线程占用，当前线程无权解他人的锁，直接返回锁剩余过期时间</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="kr">return</span><span class="w"> </span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;pttl&#39;</span><span class="p">,</span><span class="nv">key</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>释放锁</strong>：</p>
<div class="language-lua highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-14-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-14-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-14-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-14-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-14-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-14-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-14-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-14-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-14-10">10</a></span>
<span class="normal"><a href="#__codelineno-14-11">11</a></span>
<span class="normal"><a href="#__codelineno-14-12">12</a></span>
<span class="normal"><a href="#__codelineno-14-13">13</a></span>
<span class="normal"><a href="#__codelineno-14-14">14</a></span>
<span class="normal"><a href="#__codelineno-14-15">15</a></span>
<span class="normal"><a href="#__codelineno-14-16">16</a></span>
<span class="normal"><a href="#__codelineno-14-17">17</a></span>
<span class="normal"><a href="#__codelineno-14-18">18</a></span>
<span class="normal"><a href="#__codelineno-14-19">19</a></span>
<span class="normal"><a href="#__codelineno-14-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="kd">local</span><span class="w"> </span><span class="nv">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">KEYS</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="kd">local</span><span class="w"> </span><span class="nv">threadId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ARGV</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="kd">local</span><span class="w"> </span><span class="nv">releaseTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">ARGV</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="c1">-- 如果锁不是自己的</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;HEXISTS&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">threadId</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">;</span><span class="w"> </span><span class="c1">-- 直接返回</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="kr">end</span><span class="p">;</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="c1">-- 锁是自己的，锁计数-1，还是用hincrby，不过自增长的值为-1</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="kd">local</span><span class="w"> </span><span class="nv">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;hincrby&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">threadId</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="c1">-- 判断重入次数为多少</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="kr">if</span><span class="w"> </span><span class="p">(</span><span class="nv">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="kr">then</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">    </span><span class="c1">-- 大于0，重置有效期</span>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13"></a><span class="w">    </span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;expire&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">,</span><span class="w"> </span><span class="nv">releaseTime</span><span class="p">);</span>
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">;</span>
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="kr">else</span>
</span><span id="__span-14-16"><a id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="w">    </span><span class="c1">-- 否则直接释放锁 并广播解锁消息，去唤醒那些争抢过锁但还处于阻塞中的线程</span>
</span><span id="__span-14-17"><a id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">    </span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;del&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">key</span><span class="p">);</span>
</span><span id="__span-14-18"><a id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">    </span><span class="nv">redis</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="s1">&#39;publish&#39;</span><span class="p">,</span><span class="w"> </span><span class="nv">lockChannel</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-14-19"><a id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="w">    </span><span class="kr">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">;</span>
</span><span id="__span-14-20"><a id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="kr">end</span><span class="p">;</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>watchdog</strong></p>
<p>主要用来避免锁在超时后业务逻辑还未执行完，锁被自动释放的情况，通过定期刷新锁的过期时间来实现自动续期。</p>
<ul>
<li>如果当前分布式锁<strong>未设置过期时间</strong>，Redisson基于Netty时间轮启动一个定时任务，定期向redis发送命令更新锁的过期时间，默认每10s发送一次请求，每次续期30s</li>
<li>当客户端主动释放锁时，Redisson会取消看门狗刷新操作。如果客户端宕机了，定时任务无法执行，等超时时间到锁自动释放。</li>
</ul>
<h4 id="redlock">RedLock<a class="headerlink" href="#redlock" title="Permanent link"></a></h4>
<p>基本思想：部署多个redis实例（&gt;=5），客户端向多个实例上申请加锁，如果客户端能够和半数以上的节点成功地完成加锁操作，就认为客户端成功地获得分布式锁，否则加锁失败。</p>
<p>这样一来，即使有某个 Redis 节点发生故障，因为锁的数据在其他节点上也有保存，所以客户端仍然可以正常地进行锁操作，锁的数据也不会丢失。</p>
<p>客户端只有在满足下面的这<strong>两个条件</strong>时，才能认为是加锁成功：</p>
<ol>
<li>
<p>客户端从超过半数（大于等于N/2+1）的Redis节点上成功获取到了锁；</p>
</li>
<li>
<p>客户端获取锁的总耗时没有超过锁的过期时间。</p>
</li>
</ol>
<p>缺点：</p>
<ol>
<li>复杂性：需要多个redis实例，增加了系统的复杂性和维护成本</li>
<li>不适用于高并发：需要访问多个实例同时尝试获取锁，可能导致锁性能下降</li>
<li>锁的续期问题</li>
</ol>
<h3 id="过期键">过期键<a class="headerlink" href="#过期键" title="Permanent link"></a></h3>
<h4 id="redis-持久化时对过期键会如何处理的">Redis 持久化时，对过期键会如何处理的？<a class="headerlink" href="#redis-持久化时对过期键会如何处理的" title="Permanent link"></a></h4>
<p>Redis 持久化文件有两种格式：RDB（Redis Database）和 AOF（Append Only File）。</p>
<p>RDB：</p>
<ul>
<li>
<p><strong>RDB 文件生成阶段</strong>：从内存状态持久化成 RDB文件的时候，会对 key 进行过期检查，过期的键不会被保存到新的 RDB 文件中，因此 Redis 中的过期键不会对生成新 RDB 文件产生任何影响。</p>
</li>
<li>
<p><strong>RDB 文件加载阶段</strong>：</p>
</li>
<li><strong>主服务器模式运行</strong>：在载入 RDB 文件时，程序会对文件中保存的键进行检查，过期键不会被载入到数据库中。所以过期键不会对载入 RDB 文件的主服务器造成影响；</li>
<li><strong>从服务器模式运行</strong>：在载入 RDB 文件时，不论键是否过期都会被载入到数据库中。但由于主从服务器在进行数据同步时，从服务器的数据会被清空。所以一般来说，过期键对载入 RDB 文件的从服务器也不会造成影响。</li>
</ul>
<p>AOF：</p>
<ul>
<li><strong>AOF 文件写入阶段</strong>：当 Redis 以 AOF 模式持久化时，如果数据库某个过期键还没被删除，那么 AOF 文件会保留此过期键，当此过期键被删除后，Redis 会向 AOF 文件追加一条 DEL 命令来显式地删除该键值。</li>
<li><strong>AOF 重写阶段</strong>：执行 AOF 重写时，会对 Redis 中的键值对进行检查，已过期的键不会被保存到重写后的 AOF 文件中，因此不会对 AOF 重写造成任何影响。</li>
</ul>
<h4 id="redis-主从模式中对过期键会如何处理">Redis 主从模式中，对过期键会如何处理？<a class="headerlink" href="#redis-主从模式中对过期键会如何处理" title="Permanent link"></a></h4>
<p>服务器运行在复制模式下时，从服务器的过期键删除动作由主服务器控制：</p>
<ul>
<li>主服务器删除一个过期键后，会向从服务器发送DEL命令告知删除过期键。</li>
<li>从服务器在执行客户端发送的读命令时，即使碰到过期键也不会删除，而是像处理未过期键一样处理过期键。</li>
<li>从服务器只有接收到主服务器的DEL命令后，才会删除过期键。</li>
</ul>









  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback! Help us improve this page by using our <a href="..." target="_blank" rel="noopener">feedback form</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2019 - 2024 wang
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.action.edit", "content.code.copy", "content.code.select", "content.tabs.link", "navigation.tabs", "navigation.instant", "navigation.path", "toc.follow"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>