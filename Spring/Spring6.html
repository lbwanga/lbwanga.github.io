
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="个人笔记，博客">
      
      
        <meta name="author" content="wang">
      
      
        <link rel="canonical" href="https://lbwanga.github.io/Spring/Spring6.html">
      
      
        <link rel="prev" href="../%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html">
      
      
        <link rel="next" href="../SpringMVC/SpringMVC.html">
      
      
      <link rel="icon" href="../assets/logo.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Spring - WNotes</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  

<script id="__analytics">function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config","G-XXXXXXXXXX"),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","G-XXXXXXXXXX",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script>
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
   <link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#模块" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../index.html" title="WNotes" class="md-header__button md-logo" aria-label="WNotes" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            WNotes
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Spring
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/lbwanga/lbwanga.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    lbwanga
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../index.html" class="md-tabs__link">
        
  
  
    
  
  简介

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../Java/Java.html" class="md-tabs__link">
          
  
  
  Java

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../JUC/JUC.html" class="md-tabs__link">
        
  
  
    
  
  JUC

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../JVM/JVM.html" class="md-tabs__link">
        
  
  
    
  
  JVM

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../MySQL/MySQL.html" class="md-tabs__link">
        
  
  
    
  
  MySQL

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../Redis/Redis%E5%9F%BA%E7%A1%80.html" class="md-tabs__link">
          
  
  
  Redis

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../ES/ES.html" class="md-tabs__link">
        
  
  
    
  
  ES

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html" class="md-tabs__link">
        
  
  
    
  
  设计模式

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="Spring6.html" class="md-tabs__link">
        
  
  
    
  
  Spring

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../SpringMVC/SpringMVC.html" class="md-tabs__link">
        
  
  
    
  
  SpringMVC

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../SpringBoot/SpringBoot.html" class="md-tabs__link">
        
  
  
    
  
  SpringBoot

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../RocketMQ/RocketMQ.html" class="md-tabs__link">
        
  
  
    
  
  RocketMQ

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.html" class="md-tabs__link">
        
  
  
    
  
  计算机网络

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.html" class="md-tabs__link">
        
  
  
    
  
  操作系统

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/DDD.html" class="md-tabs__link">
        
  
  
    
  
  DDD

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../%E5%90%8E%E7%AB%AF%E5%9C%BA%E6%99%AF/%E5%9C%BA%E6%99%AF.html" class="md-tabs__link">
        
  
  
    
  
  后端场景

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
                
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" hidden>
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../index.html" title="WNotes" class="md-nav__button md-logo" aria-label="WNotes" data-md-component="logo">
      
  <img src="../assets/logo.png" alt="logo">

    </a>
    WNotes
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lbwanga/lbwanga.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    lbwanga
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    简介
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Java
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Java
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Java/Java.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Java/Java%E9%9B%86%E5%90%88.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Java集合
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../JUC/JUC.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JUC
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../JVM/JVM.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    JVM
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../MySQL/MySQL.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    MySQL
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Redis
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Redis
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Redis/Redis%E5%9F%BA%E7%A1%80.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Redis基础
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Redis/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Redis数据结构
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Redis/Redis%E9%AB%98%E7%BA%A7.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Redis高级
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Redis/%E5%BA%94%E7%94%A8.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Redis应用
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../ES/ES.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ES
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    设计模式
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Spring
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="Spring6.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Spring
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#模块" class="md-nav__link">
    <span class="md-ellipsis">
      模块
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iocdi和aop思想提出" class="md-nav__link">
    <span class="md-ellipsis">
      IoC、DI和AOP思想提出
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ioc" class="md-nav__link">
    <span class="md-ellipsis">
      IoC
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IoC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#beanfactory" class="md-nav__link">
    <span class="md-ellipsis">
      BeanFactory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applicationcontext" class="md-nav__link">
    <span class="md-ellipsis">
      ApplicationContext
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#基于xml的spring应用" class="md-nav__link">
    <span class="md-ellipsis">
      基于XML的Spring应用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基于XML的Spring应用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#springbean-的配置" class="md-nav__link">
    <span class="md-ellipsis">
      SpringBean 的配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpringBean 的配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bean的常用配置" class="md-nav__link">
    <span class="md-ellipsis">
      Bean的常用配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean的实例化配置" class="md-nav__link">
    <span class="md-ellipsis">
      Bean的实例化配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean的依赖注入配置" class="md-nav__link">
    <span class="md-ellipsis">
      Bean的依赖注入配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#自动装配方式" class="md-nav__link">
    <span class="md-ellipsis">
      自动装配方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring的其他配置标签" class="md-nav__link">
    <span class="md-ellipsis">
      Spring的其他配置标签
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring-的get方法" class="md-nav__link">
    <span class="md-ellipsis">
      Spring 的get方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring-配置非自定义bean" class="md-nav__link">
    <span class="md-ellipsis">
      Spring 配置非自定义Bean
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean-实例化的基本流程" class="md-nav__link">
    <span class="md-ellipsis">
      Bean 实例化的基本流程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring的后处理器" class="md-nav__link">
    <span class="md-ellipsis">
      Spring的后处理器
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Spring的后处理器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#beanfactorypostprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      BeanFactoryPostProcessor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#beanpostprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      BeanPostProcessor
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean的生命周期" class="md-nav__link">
    <span class="md-ellipsis">
      Bean的生命周期
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#循环依赖" class="md-nav__link">
    <span class="md-ellipsis">
      循环依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring-ioc-整体流程总结" class="md-nav__link">
    <span class="md-ellipsis">
      Spring IoC 整体流程总结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring-xml方式整合第三方框架" class="md-nav__link">
    <span class="md-ellipsis">
      Spring xml方式整合第三方框架
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Spring xml方式整合第三方框架">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#不需要自定义名空间" class="md-nav__link">
    <span class="md-ellipsis">
      不需要自定义名空间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#需要引入第三方框架命名空间" class="md-nav__link">
    <span class="md-ellipsis">
      需要引入第三方框架命名空间
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#基于注解的spring应用" class="md-nav__link">
    <span class="md-ellipsis">
      基于注解的Spring应用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基于注解的Spring应用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bean基本注解开发" class="md-nav__link">
    <span class="md-ellipsis">
      Bean基本注解开发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean依赖注入注解开发" class="md-nav__link">
    <span class="md-ellipsis">
      Bean依赖注入注解开发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#非自定义bean注解开发" class="md-nav__link">
    <span class="md-ellipsis">
      非自定义Bean注解开发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean配置类的注解开发" class="md-nav__link">
    <span class="md-ellipsis">
      Bean配置类的注解开发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring-配置其他注解" class="md-nav__link">
    <span class="md-ellipsis">
      Spring 配置其他注解
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring注解的解析原理" class="md-nav__link">
    <span class="md-ellipsis">
      Spring注解的解析原理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring注解方式整合第三方框架" class="md-nav__link">
    <span class="md-ellipsis">
      Spring注解方式整合第三方框架
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aop" class="md-nav__link">
    <span class="md-ellipsis">
      AOP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AOP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#基于xml配置的aop" class="md-nav__link">
    <span class="md-ellipsis">
      基于xml配置的AOP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基于xml配置的AOP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#切入点表达式" class="md-nav__link">
    <span class="md-ellipsis">
      切入点表达式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#通知类型" class="md-nav__link">
    <span class="md-ellipsis">
      通知类型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advice配置方式" class="md-nav__link">
    <span class="md-ellipsis">
      Advice配置方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xml方式aop原理" class="md-nav__link">
    <span class="md-ellipsis">
      xml方式AOP原理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#基于注解配置的aop" class="md-nav__link">
    <span class="md-ellipsis">
      基于注解配置的AOP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基于注解配置的AOP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#注解方式aop原理" class="md-nav__link">
    <span class="md-ellipsis">
      注解方式AOP原理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#基于aop的声明式事务控制" class="md-nav__link">
    <span class="md-ellipsis">
      基于AOP的声明式事务控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基于AOP的声明式事务控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#基于xml声明式事务控制" class="md-nav__link">
    <span class="md-ellipsis">
      基于xml声明式事务控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#基于注解声明式事务控制" class="md-nav__link">
    <span class="md-ellipsis">
      基于注解声明式事务控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#原理" class="md-nav__link">
    <span class="md-ellipsis">
      原理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#其他" class="md-nav__link">
    <span class="md-ellipsis">
      其他
    </span>
  </a>
  
    <nav class="md-nav" aria-label="其他">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autowired-失效" class="md-nav__link">
    <span class="md-ellipsis">
      @Autowired 失效
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scope-失效" class="md-nav__link">
    <span class="md-ellipsis">
      @Scope 失效
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#设计模式" class="md-nav__link">
    <span class="md-ellipsis">
      设计模式
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../SpringMVC/SpringMVC.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SpringMVC
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../SpringBoot/SpringBoot.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SpringBoot
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../RocketMQ/RocketMQ.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    RocketMQ
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    计算机网络
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    操作系统
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E9%A2%86%E5%9F%9F%E9%A9%B1%E5%8A%A8%E8%AE%BE%E8%AE%A1/DDD.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DDD
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../%E5%90%8E%E7%AB%AF%E5%9C%BA%E6%99%AF/%E5%9C%BA%E6%99%AF.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    后端场景
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
                
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#模块" class="md-nav__link">
    <span class="md-ellipsis">
      模块
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#iocdi和aop思想提出" class="md-nav__link">
    <span class="md-ellipsis">
      IoC、DI和AOP思想提出
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ioc" class="md-nav__link">
    <span class="md-ellipsis">
      IoC
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IoC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#beanfactory" class="md-nav__link">
    <span class="md-ellipsis">
      BeanFactory
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applicationcontext" class="md-nav__link">
    <span class="md-ellipsis">
      ApplicationContext
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#基于xml的spring应用" class="md-nav__link">
    <span class="md-ellipsis">
      基于XML的Spring应用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基于XML的Spring应用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#springbean-的配置" class="md-nav__link">
    <span class="md-ellipsis">
      SpringBean 的配置
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpringBean 的配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bean的常用配置" class="md-nav__link">
    <span class="md-ellipsis">
      Bean的常用配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean的实例化配置" class="md-nav__link">
    <span class="md-ellipsis">
      Bean的实例化配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean的依赖注入配置" class="md-nav__link">
    <span class="md-ellipsis">
      Bean的依赖注入配置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#自动装配方式" class="md-nav__link">
    <span class="md-ellipsis">
      自动装配方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring的其他配置标签" class="md-nav__link">
    <span class="md-ellipsis">
      Spring的其他配置标签
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring-的get方法" class="md-nav__link">
    <span class="md-ellipsis">
      Spring 的get方法
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring-配置非自定义bean" class="md-nav__link">
    <span class="md-ellipsis">
      Spring 配置非自定义Bean
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean-实例化的基本流程" class="md-nav__link">
    <span class="md-ellipsis">
      Bean 实例化的基本流程
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring的后处理器" class="md-nav__link">
    <span class="md-ellipsis">
      Spring的后处理器
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Spring的后处理器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#beanfactorypostprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      BeanFactoryPostProcessor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#beanpostprocessor" class="md-nav__link">
    <span class="md-ellipsis">
      BeanPostProcessor
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean的生命周期" class="md-nav__link">
    <span class="md-ellipsis">
      Bean的生命周期
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#循环依赖" class="md-nav__link">
    <span class="md-ellipsis">
      循环依赖
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring-ioc-整体流程总结" class="md-nav__link">
    <span class="md-ellipsis">
      Spring IoC 整体流程总结
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring-xml方式整合第三方框架" class="md-nav__link">
    <span class="md-ellipsis">
      Spring xml方式整合第三方框架
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Spring xml方式整合第三方框架">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#不需要自定义名空间" class="md-nav__link">
    <span class="md-ellipsis">
      不需要自定义名空间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#需要引入第三方框架命名空间" class="md-nav__link">
    <span class="md-ellipsis">
      需要引入第三方框架命名空间
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#基于注解的spring应用" class="md-nav__link">
    <span class="md-ellipsis">
      基于注解的Spring应用
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基于注解的Spring应用">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bean基本注解开发" class="md-nav__link">
    <span class="md-ellipsis">
      Bean基本注解开发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean依赖注入注解开发" class="md-nav__link">
    <span class="md-ellipsis">
      Bean依赖注入注解开发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#非自定义bean注解开发" class="md-nav__link">
    <span class="md-ellipsis">
      非自定义Bean注解开发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#bean配置类的注解开发" class="md-nav__link">
    <span class="md-ellipsis">
      Bean配置类的注解开发
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring-配置其他注解" class="md-nav__link">
    <span class="md-ellipsis">
      Spring 配置其他注解
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring注解的解析原理" class="md-nav__link">
    <span class="md-ellipsis">
      Spring注解的解析原理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#spring注解方式整合第三方框架" class="md-nav__link">
    <span class="md-ellipsis">
      Spring注解方式整合第三方框架
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aop" class="md-nav__link">
    <span class="md-ellipsis">
      AOP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AOP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#基于xml配置的aop" class="md-nav__link">
    <span class="md-ellipsis">
      基于xml配置的AOP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基于xml配置的AOP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#切入点表达式" class="md-nav__link">
    <span class="md-ellipsis">
      切入点表达式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#通知类型" class="md-nav__link">
    <span class="md-ellipsis">
      通知类型
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#advice配置方式" class="md-nav__link">
    <span class="md-ellipsis">
      Advice配置方式
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#xml方式aop原理" class="md-nav__link">
    <span class="md-ellipsis">
      xml方式AOP原理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#基于注解配置的aop" class="md-nav__link">
    <span class="md-ellipsis">
      基于注解配置的AOP
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基于注解配置的AOP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#注解方式aop原理" class="md-nav__link">
    <span class="md-ellipsis">
      注解方式AOP原理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#基于aop的声明式事务控制" class="md-nav__link">
    <span class="md-ellipsis">
      基于AOP的声明式事务控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="基于AOP的声明式事务控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#基于xml声明式事务控制" class="md-nav__link">
    <span class="md-ellipsis">
      基于xml声明式事务控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#基于注解声明式事务控制" class="md-nav__link">
    <span class="md-ellipsis">
      基于注解声明式事务控制
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#原理" class="md-nav__link">
    <span class="md-ellipsis">
      原理
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#其他" class="md-nav__link">
    <span class="md-ellipsis">
      其他
    </span>
  </a>
  
    <nav class="md-nav" aria-label="其他">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autowired-失效" class="md-nav__link">
    <span class="md-ellipsis">
      @Autowired 失效
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scope-失效" class="md-nav__link">
    <span class="md-ellipsis">
      @Scope 失效
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#设计模式" class="md-nav__link">
    <span class="md-ellipsis">
      设计模式
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  
  



  
    <a href="https://github.com/lbwanga/lbwanga.github.io/edit/master/docs/Spring/Spring6.md" title="编辑此页" class="md-content__button md-icon" rel="edit">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg>
    </a>
  
  


  <h1>Spring</h1>

<h2 id="模块">模块<a class="headerlink" href="#模块" title="Permanent link"></a></h2>
<p><strong>Core Container</strong>：</p>
<p>Spring 框架的核心模块，也可以说是基础模块，主要提供 IoC 依赖注入功能的支持。Spring 其他所有的功能基本都需要依赖于该模块。</p>
<ul>
<li><strong>spring-core</strong>：Spring 框架基本的核心工具类。</li>
<li><strong>spring-beans</strong>：提供对 bean 的创建、配置和管理等功能的支持。</li>
<li><strong>spring-context</strong>：提供对国际化、事件传播、资源加载等功能的支持。</li>
<li><strong>spring-expression</strong>：提供对表达式语言（Spring Expression Language） SpEL 的支持，只依赖于 core 模块，不依赖于其他模块，可以单独使用。</li>
</ul>
<p><strong>AOP</strong>：</p>
<ul>
<li>
<p><strong>spring-aspects</strong>：该模块为与 AspectJ 的集成提供支持。</p>
</li>
<li>
<p><strong>spring-aop</strong>：提供了面向切面的编程实现。</p>
</li>
<li>
<p><strong>spring-instrument</strong>：提供了为 JVM 添加代理（agent）的功能。 具体来讲，它为 Tomcat 提供了一个织入代理，能够为 Tomcat 传递类文 件，就像这些文件是被类加载器加载的一样。没有理解也没关系，这个模块的使用场景非常有限。</p>
</li>
</ul>
<p><strong>Data Access/Integration</strong></p>
<ul>
<li><strong>spring-jdbc</strong>：提供了对数据库访问的抽象 JDBC。不同的数据库都有自己独立的 API 用于操作数据库，而 Java 程序只需要和 JDBC API 交互，这样就屏蔽了数据库的影响。</li>
<li><strong>spring-tx</strong>：提供对事务的支持。</li>
<li><strong>spring-orm</strong>：提供对 Hibernate、JPA、iBatis 等 ORM 框架的支持。</li>
<li><strong>spring-oxm</strong>：提供一个抽象层支撑 OXM(Object-to-XML-Mapping)，例如：JAXB、Castor、XMLBeans、JiBX 和 XStream 等。</li>
<li><strong>spring-jms</strong> : 消息服务。自 Spring Framework 4.1 以后，它还提供了对 spring-messaging 模块的继承。</li>
</ul>
<p><strong>Spring Web</strong></p>
<ul>
<li><strong>spring-web</strong>：对 Web 功能的实现提供一些最基础的支持。</li>
<li><strong>spring-webmvc</strong>：提供对 Spring MVC 的实现。</li>
<li><strong>spring-websocket</strong>：提供了对 WebSocket 的支持，WebSocket 可以让客户端和服务端进行双向通信。</li>
<li><strong>spring-webflux</strong>：提供对 WebFlux 的支持。WebFlux 是 Spring Framework 5.0 中引入的新的响应式框架。与 Spring MVC 不同，它不需要 Servlet API，是完全异步。</li>
</ul>
<p><strong>Spring Test</strong></p>
<p>Spring 团队提倡测试驱动开发（TDD）。有了控制反转 (IoC)的帮助，单元测试和集成测试变得更简单。</p>
<p>Spring 的测试模块对 JUnit（单元测试框架）、TestNG（类似 JUnit）、Mockito（主要用来 Mock 对象）、PowerMock（解决 Mockito 的问题比如无法模拟 final, static， private 方法）等等常用的测试框架支持的都比较好</p>
<h2 id="iocdi和aop思想提出">IoC、DI和AOP思想提出<a class="headerlink" href="#iocdi和aop思想提出" title="Permanent link"></a></h2>
<p><strong>IoC 控制反转思想的提出</strong>：</p>
<p>IoC思想： Inversion of Control，控制反转，强调的是原来在程序中创建Bean的权利反转给第三方。例如：原来在程序中手动的去 new UserServiceImpl()，手动的去new UserDaoImpl()，而根据IoC思想的指导， 寻求一个第三方去创建UserServiceImpl对象和UserDaoImpl对象。</p>
<p>工厂设计模式，BeanFactory来充当第三方的角色，以使用配置文件配置Bean的基本信息，来产生Bean实例。</p>
<p>Spring通过控制反转实现了对象的创建和对象间的依赖关系管理。开发者只需要定义好Bean及其依赖关系，Spring容器负责创建和组装这些对象。</p>
<p>好处：</p>
<ol>
<li>降低耦合性：减少代码之间的直接依赖，代码更容易维护和扩展</li>
<li>增强灵活性：依赖关系可以通过配置文件或注解更改，更灵活</li>
<li>简化管理：容器管理对象的创建和生命周期</li>
</ol>
<p><strong>DI 依赖注入思想的提出</strong>：</p>
<p>DI：Dependency Injection，依赖注入，某个Bean的完整创建依赖于其他Bean（或普通参数）的注入</p>
<p>IoC和DI的关系：</p>
<ul>
<li>IoC强调的是Bean创建权的反转，而DI强调的是Bean的依赖关系</li>
<li>IoC强调的是Bean创建权的反转，而DI强调的是通过注入的方式反转Bean的创建权，认为DI 是IoC的其中一种实现方式</li>
</ul>
<p><strong>AOP 面向切面思想的提出</strong>：</p>
<p>AOP，Aspect Oriented Programming，面向切面编程，能够将那些与业务无关，却为业务模块所共同调用的逻辑封装起来，以减少系统的重复代码，降低模块间的耦合度。通过声明的方式动态地应用到业务方法上，而不是将这些代码直接嵌入到业务代码中。</p>
<h2 id="ioc">IoC<a class="headerlink" href="#ioc" title="Permanent link"></a></h2>
<h3 id="beanfactory">BeanFactory<a class="headerlink" href="#beanfactory" title="Permanent link"></a></h3>
<p>BeanFactory为IoC功能提供了底层基础，是Spring的核心容器。</p>
<p>BeanFacroty功能：控制反转、依赖注入、Bean的生命周期的各种功能，都由他的实现类 DefaultListableBeanFactory 提供</p>
<p>BeanFatory：</p>
<ol>
<li>不会主动调用 BeanFactory 后处理器</li>
<li>不会主动添加 Bean 后处理器</li>
<li>不会主动初始化单例，调用getBean时才初始化。<strong>延迟加载</strong></li>
<li>不会解析BeanFactory，不会解析 <code>#{} 和 ${}</code></li>
</ol>
<p>使用步骤：</p>
<p>1）导入Spring的jar包或Maven坐标；</p>
<p>2）定义UserService接口及其UserServiceImpl实现类； </p>
<p>3）创建beans.xml配置文件，将UserServiceImpl的信息配置到该xml中；</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userService&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.itheima.service.impl.UserServiceImpl&quot;</span><span class="nt">&gt;&lt;/bean&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>4）编写测试代码，创建BeanFactory，加载配置文件，获取UserService实例对象。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span>
<span class="normal"><a href="#__codelineno-1-5">5</a></span>
<span class="normal"><a href="#__codelineno-1-6">6</a></span>
<span class="normal"><a href="#__codelineno-1-7">7</a></span>
<span class="normal"><a href="#__codelineno-1-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="c1">//创建BeanFactory</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="n">DefaultListableBeanFactory</span><span class="w"> </span><span class="n">beanFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DefaultListableBeanFactory</span><span class="p">();</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="c1">//创建读取器</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="n">XmlBeanDefinitionReader</span><span class="w"> </span><span class="n">reader</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">XmlBeanDefinitionReader</span><span class="p">(</span><span class="n">beanFactory</span><span class="p">);</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="c1">//加载配置文件</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="n">reader</span><span class="p">.</span><span class="na">loadBeanDefinitions</span><span class="p">(</span><span class="s">&quot;beans.xml&quot;</span><span class="p">);</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="c1">//获取Bean实例对象</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="n">UserDao</span><span class="w"> </span><span class="n">userService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UserService</span><span class="p">)</span><span class="w"> </span><span class="n">beanFactory</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;userService&quot;</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="applicationcontext">ApplicationContext<a class="headerlink" href="#applicationcontext" title="Permanent link"></a></h3>
<p>ApplicationContext 称为Spring容器，内部封装了BeanFactory，比BeanFactory功能更丰富更强大，使用 ApplicationContext 进行开发时，xml配置文件的名称习惯写成applicationContext.xml</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1">1</a></span>
<span class="normal"><a href="#__codelineno-2-2">2</a></span>
<span class="normal"><a href="#__codelineno-2-3">3</a></span>
<span class="normal"><a href="#__codelineno-2-4">4</a></span>
<span class="normal"><a href="#__codelineno-2-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span class="c1">//创建ApplicationContext,加载配置文件，实例化容器</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2"></a><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassPathxmlApplicationContext</span><span class="p">(</span><span class="err">“</span><span class="n">applicationContext</span><span class="p">.</span><span class="na">xml</span><span class="s">&quot;);</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3"></a><span class="s">//根据beanName获得容器中的Bean实例</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4"></a><span class="s">UserService userService = (UserService) applicationContext.getBean(&quot;</span><span class="n">userService</span><span class="s">&quot;);</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5"></a><span class="s">System.out.println(userService);</span>
</span></code></pre></div></td></tr></table></div>
<p>BeanFactory与ApplicationContext的关系:</p>
<ol>
<li>BeanFactory是Spring的早期接口，称为Spring的Bean工厂，ApplicationContext是后期更高级接口，称之为 Spring 容器；</li>
<li>ApplicationContext在BeanFactory基础上对功能进行了扩展，例如：监听功能、国际化功能等。BeanFactory的 API更偏向底层，ApplicationContext的API大多数是对这些底层API的封装；</li>
<li>Bean创建的主要逻辑和功能都被封装在BeanFactory中，ApplicationContext不仅继承了BeanFactory，而且 ApplicationContext内部还维护着BeanFactory的引用，所以，ApplicationContext与BeanFactory既有继承关系，又有组合关系。 </li>
<li>Bean的初始化时机不同，原始BeanFactory是在首次调用getBean时才进行Bean的创建，而ApplicationContext则是配置文件加载，容器一创建就将Bean都实例化并初始化好</li>
</ol>
<p>ApplicationContext除了继承了BeanFactory外，还继承了ApplicationEventPublisher（事件发布器）、 ResouresPatternResolver（资源解析器）、MessageSource（国际化功能）、EnvironmentCapable（环境配置管理）等。但是ApplicationContext的核心功能还是BeanFactory。</p>
<p><a class="glightbox" href="Spring/ApplicationContext.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/ApplicationContext.png" /></a></p>
<p>ApplicationContext的实现类：</p>
<table>
<thead>
<tr>
<th>实现类</th>
<th>简介</th>
</tr>
</thead>
<tbody>
<tr>
<td>ClassPathXmlApplicationContext</td>
<td>通过读取类路径下的 XML 格式的配置文件创建 IoC 容器对象</td>
</tr>
<tr>
<td>FileSystemXmlApplicationContext</td>
<td>通过文件系统路径读取 XML 格式的配置文件创建 IoC 容器对象</td>
</tr>
<tr>
<td>AnnotationConfigApplicationContext</td>
<td>通过读取Java配置类注解创建 IoC 容器对象</td>
</tr>
<tr>
<td>XmlWebApplicationContext</td>
<td>web环境下，加载类路径下的xml配置文件创建 IoC 容器对象</td>
</tr>
<tr>
<td>AnnotationConfigWebApplicationContext</td>
<td>web环境下，读取Java配置类注解创建 IoC 容器对象</td>
</tr>
</tbody>
</table>
<h3 id="基于xml的spring应用">基于XML的Spring应用<a class="headerlink" href="#基于xml的spring应用" title="Permanent link"></a></h3>
<h4 id="springbean-的配置">SpringBean 的配置<a class="headerlink" href="#springbean-的配置" title="Permanent link"></a></h4>
<h5 id="bean的常用配置">Bean的常用配置<a class="headerlink" href="#bean的常用配置" title="Permanent link"></a></h5>
<table>
<thead>
<tr>
<th>XML配置方式</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;bean id="" class=""&gt;</code></td>
<td>Bean的id和全限定名配置。唯一标识默认类名首字母小写</td>
</tr>
<tr>
<td><code>&lt;bean name=""&gt;</code></td>
<td>通过name设置Bean的别名，通过别名也能直接获取到Bean实例</td>
</tr>
<tr>
<td><code>&lt;bean scope=""&gt;</code></td>
<td>Bean的作用范围，BeanFactory作为容器时取值singleton和prototype</td>
</tr>
<tr>
<td><code>&lt;bean lazy-init=""&gt;</code></td>
<td>Bean的实例化时机，是否延迟加载。BeanFactory作为容器时无效</td>
</tr>
<tr>
<td><code>&lt;bean init-method=""&gt;</code></td>
<td>Bean实例化后自动执行的初始化方法，method指定方法名</td>
</tr>
<tr>
<td><code>&lt;bean destroy-method=""&gt;</code></td>
<td>Bean实例销毁前的方法，method指定方法名</td>
</tr>
<tr>
<td><code>&lt;bean autowire="byType"&gt;</code></td>
<td>设置自动注入模式，常用的有按照类型byType，按照名字byName</td>
</tr>
<tr>
<td><code>&lt;bean factory-bean="" factory-method=""/&gt;</code></td>
<td>指定哪个工厂Bean的哪个方法完成Bean的创建</td>
</tr>
</tbody>
</table>
<p>例如：配置UserDaoImpl由Spring容器负责管理</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-3-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userDao&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.itheima.dao.impl.UserDaoImpl&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>此时存储到Spring容器（singleObjects单例池）中的Bean的beanName是userDao，值是UserDaoImpl对象，可 以根据beanName获取Bean实例</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;userDao&quot;</span><span class="p">);</span><span class="w"> </span>
</span></code></pre></div></td></tr></table></div>
<p>如果不配置id，则Spring会把当前Bean实例的全限定名作为beanName </p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;com.itheima.dao.impl.UserDaoImpl&quot;</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p>Bean的作用域：</p>
<p>默认情况下，单纯的Spring环境Bean的作用范围有两个：Singleton和Prototype </p>
<ul>
<li>singleton：单例，默认值，Spring容器创建的时候，就会进行Bean的实例化，并存储到容器内部的单例池中 ，每次getBean时都是从单例池中获取相同的Bean实例； </li>
<li>prototype：原型，Spring容器初始化时不会创建Bean实例，当调用getBean时才会实例化Bean，每次 getBean都会创建一个新的Bean实例。</li>
</ul>
<p>Web环境下还有：request, session, application, websocket</p>
<p>Bean的延迟加载：</p>
<p>当lazy-init设置为true时为延迟加载，也就是当Spring容器创建的时候，不会立即创建Bean实例，等待用到时再创建Bean实例并存储到单例池中去，后续在使用该Bean直接从单例池获取即可，本质上该Bean还是单例的。</p>
<p>Bean的初始化和销毁方法配置：</p>
<p>Bean在被实例化后，可以执行指定的初始化方法完成一些初始化的操作，Bean在销毁之前也可以执行指定的销毁方法完成一些操作。</p>
<p>除此之外，我们还可以通过实现 InitializingBean 接口完成一些Bean的初始化操作；DisposableBean 接口完成在销毁bean时执行某些操作</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserDaoImpl</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">UserDao</span><span class="p">,</span><span class="w"> </span><span class="n">InitializingBean</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">UserDaoImpl</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;UserDaoImpl创建了...&quot;</span><span class="p">);}</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">(){</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;初始化方法...&quot;</span><span class="p">);}</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">destroy</span><span class="p">(){</span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;销毁方法...&quot;</span><span class="p">);}</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5"></a>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="w">    </span><span class="c1">//执行时机早于init-method配置的方法</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterPropertiesSet</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;InitializingBean...&quot;</span><span class="p">);</span><span class="w"> </span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h5 id="bean的实例化配置">Bean的实例化配置<a class="headerlink" href="#bean的实例化配置" title="Permanent link"></a></h5>
<p>Spring的实例化方式主要如下两种： </p>
<ul>
<li>构造方式实例化：底层通过构造函数对Bean进行实例化 </li>
<li>工厂方式实例化：底层通过调用自定义的工厂方法对Bean进行实例化</li>
</ul>
<p>构造函数实例化Bean又分为无参构造方法实例化和有参构造方法实例化，Spring中配置的几乎都是无参构造方式。</p>
<p>有参构造在实例化Bean时，需要参数的注入，通过标签嵌入在标签内部提供构造参数：</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1">1</a></span>
<span class="normal"><a href="#__codelineno-7-2">2</a></span>
<span class="normal"><a href="#__codelineno-7-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userDao&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.itheima.dao.impl.UserDaoImpl&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;haohao&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nt">&lt;/bean&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>工厂方式实例化Bean，又分为如下三种： </p>
<ol>
<li>
<p>静态工厂方法实例化Bean </p>
</li>
<li>
<p>实例工厂方法实例化Bean </p>
</li>
<li>
<p>实现FactoryBean规范延迟实例化Bean</p>
</li>
</ol>
<p>1）静态工厂方法实例化Bean，其实就是定义一个工厂类，提供一个静态方法用于生产Bean实例，class为工厂类，factory-method为工厂方法。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-8-1">1</a></span>
<span class="normal"><a href="#__codelineno-8-2">2</a></span>
<span class="normal"><a href="#__codelineno-8-3">3</a></span>
<span class="normal"><a href="#__codelineno-8-4">4</a></span>
<span class="normal"><a href="#__codelineno-8-5">5</a></span>
<span class="normal"><a href="#__codelineno-8-6">6</a></span>
<span class="normal"><a href="#__codelineno-8-7">7</a></span>
<span class="normal"><a href="#__codelineno-8-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c1">//工厂类</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserDaoFactoryBean</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">    </span><span class="c1">//非静态工厂方法</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="n">UserDao</span><span class="w"> </span><span class="nf">getUserDao</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">        </span><span class="c1">//可以在此编写一些其他逻辑代码</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserDaoImpl</span><span class="p">();</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userDao&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.itheima.factory.UserDaoFactoryBean&quot;</span><span class="w"> </span><span class="na">factory-method=</span><span class="s">&quot;getUserDao&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;haohao&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="nt">&lt;/bean&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>constructor-arg 标签不仅仅是为构造方法传递参数，只要是为了实例化对象而传递的参数都可以通过标签完成，例如上面通过静态工厂方法实例化Bean所传递的参数也是要通过 constructor-arg 进行传递的。</p>
<p>2）实例工厂方法，也就是非静态工厂方法产生Bean实例，与静态工厂方式比较，该方式需要先有工厂对象，再用工厂对象去调用非静态方法，所以在进行配置时，要先配置工厂Bean，再配置目标Bean。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-10-1">1</a></span>
<span class="normal"><a href="#__codelineno-10-2">2</a></span>
<span class="normal"><a href="#__codelineno-10-3">3</a></span>
<span class="normal"><a href="#__codelineno-10-4">4</a></span>
<span class="normal"><a href="#__codelineno-10-5">5</a></span>
<span class="normal"><a href="#__codelineno-10-6">6</a></span>
<span class="normal"><a href="#__codelineno-10-7">7</a></span>
<span class="normal"><a href="#__codelineno-10-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c1">//工厂类</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserDaoFactoryBean2</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">    </span><span class="c1">//非静态工厂方法</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">UserDao</span><span class="w"> </span><span class="nf">getUserDao</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">){</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">        </span><span class="c1">//可以在此编写一些其他逻辑代码</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserDaoImpl</span><span class="p">();</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1">1</a></span>
<span class="normal"><a href="#__codelineno-11-2">2</a></span>
<span class="normal"><a href="#__codelineno-11-3">3</a></span>
<span class="normal"><a href="#__codelineno-11-4">4</a></span>
<span class="normal"><a href="#__codelineno-11-5">5</a></span>
<span class="normal"><a href="#__codelineno-11-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="cm">&lt;!-- 配置实例工厂Bean --&gt;</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userDaoFactoryBean2&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.itheima.factory.UserDaoFactoryBean2&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="cm">&lt;!-- 配置实例工厂Bean的哪个方法作为工厂方法 --&gt;</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userDao&quot;</span><span class="w"> </span><span class="na">factory-bean=</span><span class="s">&quot;userDaoFactoryBean2&quot;</span><span class="w"> </span><span class="na">factory-method=</span><span class="s">&quot;getUserDao&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;haohao&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="nt">&lt;/bean&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>3）Spring提供了FactoryBean的接口规范，实现该接口产生Bean实例：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span>
<span class="normal"><a href="#__codelineno-12-11">11</a></span>
<span class="normal"><a href="#__codelineno-12-12">12</a></span>
<span class="normal"><a href="#__codelineno-12-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">FactoryBean</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">OBJECT_TYPE_ATTRIBUTE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;factoryBeanObjectType&quot;</span><span class="p">;</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3"></a>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="nd">@Nullable</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="n">T</span><span class="w"> </span><span class="nf">getObject</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="p">;</span><span class="w"> </span><span class="c1">//获得实例对象</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6"></a>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="nd">@Nullable</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="nf">getObjectType</span><span class="p">();</span><span class="w"> </span><span class="c1">//获得实例对象类型</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9"></a>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="nf">isSingleton</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Spring容器创建时，FactoryBean被实例化并存储到了单例池singletonObjects中，但是 getObject() 方法尚未被执行，UserDaoImpl也没被实例化，当首次用到UserDaoImpl时，才调用getObject() ， 此工厂方式产生的Bean实例不会存储到单例池singletonObjects中，会存储到 factoryBeanObjectCache 缓存池中，并且后期每次使用到userDao都从该缓存池中返回的是同一个userDao实例。</p>
<p><strong>FactoryBean和BeanFactory区别</strong>：</p>
<ul>
<li>
<p><strong>FactoryBean </strong>是 Spring 中一种特殊的 bean，可以在 getObject() 工厂方法自定义的逻辑创建Bean！是一种能够生产其他 Bean 的 Bean。FactoryBean 在容器启动时被创建，而在实际使用时则是通过调用 getObject() 方法来得到其所生产的 Bean。因此，FactoryBean 可以自定义任何所需的初始化逻辑，生产出一些定制化的 bean。一般情况下，整合第三方框架，都是通过定义FactoryBean实现。</p>
</li>
<li>
<p><strong>BeanFactory</strong> 是 Spring 框架的基础，其作为一个顶级接口定义了容器的基本行为，例如管理 bean 的生命周期、配置文件的加载和解析、bean 的装配和依赖注入等。BeanFactory 接口提供了访问 bean 的方式，例如 getBean() 方法获取指定的 bean 实例。它可以从不同的来源（例如 Mysql 数据库、XML 文件、Java 配置类等）获取 bean 定义，并将其转换为 bean 实例。同时，BeanFactory 还包含很多子类（例如，ApplicationContext 接口）提供了额外的强大功能。</p>
</li>
</ul>
<p>总的来说，FactoryBean 和 BeanFactory 的区别主要在于前者是用于创建 bean 的接口，它提供了更加灵活的初始化定制功能，而后者是用于管理 bean 的框架基础接口，提供了基本的容器功能和 bean 生命周期管理。</p>
<h5 id="bean的依赖注入配置">Bean的依赖注入配置<a class="headerlink" href="#bean的依赖注入配置" title="Permanent link"></a></h5>
<table>
<thead>
<tr>
<th>注入方式</th>
<th>配置方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>通过Bean的set方法注入</td>
<td><code>&lt;property name="userDao" ref="userDao"/&gt;</code><br/><code>&lt;property name="userDao" value="haohao"/&gt;</code></td>
</tr>
<tr>
<td>通过Bean的构造方法进行注入</td>
<td><code>&lt;constructor-arg name="name" ref="userDao"/&gt;</code><br/><code>&lt;constructor-arg name="name" value="haohao"/&gt;</code></td>
</tr>
</tbody>
</table>
<p>ref 用于引用其他Bean的id。value 用于注入普通属性值。</p>
<p>经验法则是使用构造方式注入强制依赖，使用set方式注入可选依赖，但是最好使用带有编程验证参数的构造函数注入。</p>
<p>依赖注入的数据类型有如下三种： </p>
<ul>
<li>普通数据类型，例如：String、int、boolean等，通过value属性指定。 </li>
<li>引用数据类型，例如：UserDaoImpl、DataSource等，通过ref属性指定。 </li>
<li>集合数据类型，例如：List、Map、Properties等。</li>
</ul>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-13-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-13-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-13-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-13-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-13-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-13-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-13-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-13-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-13-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-13-10">10</a></span>
<span class="normal"><a href="#__codelineno-13-11">11</a></span>
<span class="normal"><a href="#__codelineno-13-12">12</a></span>
<span class="normal"><a href="#__codelineno-13-13">13</a></span>
<span class="normal"><a href="#__codelineno-13-14">14</a></span>
<span class="normal"><a href="#__codelineno-13-15">15</a></span>
<span class="normal"><a href="#__codelineno-13-16">16</a></span>
<span class="normal"><a href="#__codelineno-13-17">17</a></span>
<span class="normal"><a href="#__codelineno-13-18">18</a></span>
<span class="normal"><a href="#__codelineno-13-19">19</a></span>
<span class="normal"><a href="#__codelineno-13-20">20</a></span>
<span class="normal"><a href="#__codelineno-13-21">21</a></span>
<span class="normal"><a href="#__codelineno-13-22">22</a></span>
<span class="normal"><a href="#__codelineno-13-23">23</a></span>
<span class="normal"><a href="#__codelineno-13-24">24</a></span>
<span class="normal"><a href="#__codelineno-13-25">25</a></span>
<span class="normal"><a href="#__codelineno-13-26">26</a></span>
<span class="normal"><a href="#__codelineno-13-27">27</a></span>
<span class="normal"><a href="#__codelineno-13-28">28</a></span>
<span class="normal"><a href="#__codelineno-13-29">29</a></span>
<span class="normal"><a href="#__codelineno-13-30">30</a></span>
<span class="normal"><a href="#__codelineno-13-31">31</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;moreComplexObject&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;example.ComplexObject&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">    </span><span class="cm">&lt;!-- results in a setAdminEmails(java.util.Properties) call --&gt;</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;adminEmails&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">        </span><span class="nt">&lt;props&gt;</span>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">            </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;administrator&quot;</span><span class="nt">&gt;</span>administrator@example.org<span class="nt">&lt;/prop&gt;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">            </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;support&quot;</span><span class="nt">&gt;</span>support@example.org<span class="nt">&lt;/prop&gt;</span>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">            </span><span class="nt">&lt;prop</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;development&quot;</span><span class="nt">&gt;</span>development@example.org<span class="nt">&lt;/prop&gt;</span>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">        </span><span class="nt">&lt;/props&gt;</span>
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">    </span><span class="nt">&lt;/property&gt;</span>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">    </span><span class="cm">&lt;!-- results in a setSomeList(java.util.List) call --&gt;</span>
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;someList&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">        </span><span class="nt">&lt;list&gt;</span>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">            </span><span class="nt">&lt;value&gt;</span>a<span class="w"> </span>list<span class="w"> </span>element<span class="w"> </span>followed<span class="w"> </span>by<span class="w"> </span>a<span class="w"> </span>reference<span class="nt">&lt;/value&gt;</span>
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14"></a><span class="w">            </span><span class="nt">&lt;ref</span><span class="w"> </span><span class="na">bean=</span><span class="s">&quot;myDataSource&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">        </span><span class="nt">&lt;/list&gt;</span>
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="w">    </span><span class="nt">&lt;/property&gt;</span>
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="w">    </span><span class="cm">&lt;!-- results in a setSomeMap(java.util.Map) call --&gt;</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;someMap&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="w">        </span><span class="nt">&lt;map&gt;</span>
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;an entry&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;just some string&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21"></a><span class="w">            </span><span class="nt">&lt;entry</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;a ref&quot;</span><span class="w"> </span><span class="na">value-ref=</span><span class="s">&quot;myDataSource&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="w">        </span><span class="nt">&lt;/map&gt;</span>
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="w">    </span><span class="nt">&lt;/property&gt;</span>
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="w">    </span><span class="cm">&lt;!-- results in a setSomeSet(java.util.Set) call --&gt;</span>
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;someSet&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26"></a><span class="w">        </span><span class="nt">&lt;set&gt;</span>
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27"></a><span class="w">            </span><span class="nt">&lt;value&gt;</span>just<span class="w"> </span>some<span class="w"> </span>string<span class="nt">&lt;/value&gt;</span>
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28"></a><span class="w">            </span><span class="nt">&lt;ref</span><span class="w"> </span><span class="na">bean=</span><span class="s">&quot;myDataSource&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29"></a><span class="w">        </span><span class="nt">&lt;/set&gt;</span>
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="w">    </span><span class="nt">&lt;/property&gt;</span>
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31"></a><span class="nt">&lt;/bean&gt;</span>
</span></code></pre></div></td></tr></table></div>
<h5 id="自动装配方式">自动装配方式<a class="headerlink" href="#自动装配方式" title="Permanent link"></a></h5>
<ul>
<li>no（默认）：不自动装配，需要显示定义依赖</li>
<li>byName：通过bean名称自动装配</li>
<li>byType：通过bean类型自动装配</li>
<li>constructor：通过构造函数自动装配</li>
</ul>
<h5 id="spring的其他配置标签">Spring的其他配置标签<a class="headerlink" href="#spring的其他配置标签" title="Permanent link"></a></h5>
<p><code>&lt;beans&gt;</code>标签，除了经常用的做为根标签外，还可以嵌套在根标签内，使用profile属性切换开发环境。指定被激活的环境：</p>
<ol>
<li>
<p>使用命令行动态参数，虚拟机参数位置加载 -Dspring.profiles.active=test </p>
</li>
<li>
<p>使用代码的方式设置环境变量 System.setProperty("spring.profiles.active","test")</p>
</li>
</ol>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-14-1">1</a></span>
<span class="normal"><a href="#__codelineno-14-2">2</a></span>
<span class="normal"><a href="#__codelineno-14-3">3</a></span>
<span class="normal"><a href="#__codelineno-14-4">4</a></span>
<span class="normal"><a href="#__codelineno-14-5">5</a></span>
<span class="normal"><a href="#__codelineno-14-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="cm">&lt;!-- 配置测试环境下，需要加载的Bean实例 --&gt;</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nt">&lt;beans</span><span class="w"> </span><span class="na">profile=</span><span class="s">&quot;test&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="nt">&lt;/beans&gt;</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="cm">&lt;!-- 配置开发环境下，需要加载的Bean实例 --&gt;</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="nt">&lt;beans</span><span class="w"> </span><span class="na">profile=</span><span class="s">&quot;dev&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="nt">&lt;/beans&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p><code>&lt;import&gt;</code>标签，用于导入其他配置文件</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="cm">&lt;!--导入用户模块配置文件--&gt;</span>
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nt">&lt;import</span><span class="w"> </span><span class="na">resource=</span><span class="s">&quot;classpath:UserModuleApplicationContext.xml&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p><code>&lt;alias&gt;</code>标签是为某个Bean添加别名，与在 标签上使用name属性添加别名的方式一样:</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-16-1">1</a></span>
<span class="normal"><a href="#__codelineno-16-2">2</a></span>
<span class="normal"><a href="#__codelineno-16-3">3</a></span>
<span class="normal"><a href="#__codelineno-16-4">4</a></span>
<span class="normal"><a href="#__codelineno-16-5">5</a></span>
<span class="normal"><a href="#__codelineno-16-6">6</a></span>
<span class="normal"><a href="#__codelineno-16-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="cm">&lt;!--配置UserService--&gt;</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;userService&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;aaa,bbb&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.itheima.service.impl.UserServiceImpl&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;userDao&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;userDao&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="nt">&lt;/bean&gt;</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="cm">&lt;!--指定别名--&gt;</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6"></a><span class="nt">&lt;alias</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;userService&quot;</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;xxx&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="nt">&lt;alias</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;userService&quot;</span><span class="w"> </span><span class="na">alias=</span><span class="s">&quot;yyy&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>在beanFactory中维护着一个名为aliasMap的Map集合，存储别名和 beanName 之间的映射关系.</p>
<h4 id="spring-的get方法">Spring 的get方法<a class="headerlink" href="#spring-的get方法" title="Permanent link"></a></h4>
<table>
<thead>
<tr>
<th>方法定义</th>
<th>返回值和参数</th>
</tr>
</thead>
<tbody>
<tr>
<td>Object getBean (String beanName)</td>
<td>根据beanName从容器中获取Bean实例，要求容器中Bean唯一，返回值为Object，需要强转</td>
</tr>
<tr>
<td>T getBean (Class type)</td>
<td>根据Class类型从容器中获取Bean实例，要求容器中Bean类型唯一，返回值为Class类型实例， 无需强转</td>
</tr>
<tr>
<td>T getBean (String beanName，Class type)</td>
<td>根据beanName从容器中获得Bean实例，返回值为Class类型实例，无需强转</td>
</tr>
</tbody>
</table>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span>
<span class="normal"><a href="#__codelineno-17-7">7</a></span>
<span class="normal"><a href="#__codelineno-17-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1">//根据beanName获取容器中的Bean实例，需要手动强转</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="n">UserService</span><span class="w"> </span><span class="n">userService</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">UserService</span><span class="p">)</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;userService&quot;</span><span class="p">);</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3"></a>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="c1">//根据Bean类型去容器中匹配对应的Bean实例，如存在多个匹配Bean则报错</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="n">UserService</span><span class="w"> </span><span class="n">userService2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">UserService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6"></a>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="c1">//根据beanName获取容器中的Bean实例，指定Bean的Type类型</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="n">UserService</span><span class="w"> </span><span class="n">userService3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="s">&quot;userService&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">UserService</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="spring-配置非自定义bean">Spring 配置非自定义Bean<a class="headerlink" href="#spring-配置非自定义bean" title="Permanent link"></a></h4>
<p>配置非自定义的Bean需要考虑如下两个问题： </p>
<ul>
<li>被配置的Bean的实例化方式是什么？无参构造、有参构造、静态工厂方式还是实例工厂方式；</li>
<li>被配置的Bean是否需要注入必要属性。</li>
</ul>
<p>例如，产生一个指定日期格式的对象，原始代码按如下：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1">1</a></span>
<span class="normal"><a href="#__codelineno-18-2">2</a></span>
<span class="normal"><a href="#__codelineno-18-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">String</span><span class="w"> </span><span class="n">currentTimeStr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;2023-08-27 07:20:00&quot;</span><span class="p">;</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2"></a><span class="n">SimpleDateFormat</span><span class="w"> </span><span class="n">simpleDateFormat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SimpleDateFormat</span><span class="p">(</span><span class="s">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="p">);</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="n">Date</span><span class="w"> </span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">simpleDateFormat</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="n">currentTimeStr</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p>可以看成是实例工厂方式，使用Spring配置方式产生Date实例:</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span>
<span class="normal"><a href="#__codelineno-19-3">3</a></span>
<span class="normal"><a href="#__codelineno-19-4">4</a></span>
<span class="normal"><a href="#__codelineno-19-5">5</a></span>
<span class="normal"><a href="#__codelineno-19-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;simpleDateFormat&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;java.text.SimpleDateFormat&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;pattern&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="nt">&lt;/bean&gt;</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;date&quot;</span><span class="w"> </span><span class="na">factory-bean=</span><span class="s">&quot;simpleDateFormat&quot;</span><span class="w"> </span><span class="na">factory-method=</span><span class="s">&quot;parse&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">    </span><span class="nt">&lt;constructor-arg</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;source&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;2023-08-27 07:20:00&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6"></a><span class="nt">&lt;/bean&gt;</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="bean-实例化的基本流程">Bean 实例化的基本流程<a class="headerlink" href="#bean-实例化的基本流程" title="Permanent link"></a></h4>
<p>1）加载xml配置文件，解析获取配置中的每个的信息，封装成一个个的BeanDefinition对象; </p>
<p>2）将BeanDefinition存储在一个名为beanDefinitionMap的Map中;</p>
<p>3）ApplicationContext底层遍历beanDefinitionMap，使用反射创建Bean实例对象; </p>
<p>4）创建好的Bean实例对象，被存储到一个名为singletonObjects的Map中; </p>
<p>5）当执行applicationContext.getBean(beanName)时，从singletonObjects去匹配Bean实例返回。</p>
<p><a class="glightbox" href="Spring/bean%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%B5%81%E7%A8%8B.jpeg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/bean%E5%AE%9E%E4%BE%8B%E5%8C%96%E6%B5%81%E7%A8%8B.jpeg" /></a></p>
<p>DefaultListableBeanFactory对象内部维护着一个Map用于存储封装好的BeanDefinitionMap：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1">1</a></span>
<span class="normal"><a href="#__codelineno-20-2">2</a></span>
<span class="normal"><a href="#__codelineno-20-3">3</a></span>
<span class="normal"><a href="#__codelineno-20-4">4</a></span>
<span class="normal"><a href="#__codelineno-20-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DefaultListableBeanFactory</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">    </span><span class="c1">//存储&lt;bean&gt;标签对应的BeanDefinition对象</span>
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">    </span><span class="c1">//key:是Bean的beanName，value:是Bean定义对象BeanDefinition</span>
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">BeanDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="n">beanDefinitionMap</span><span class="p">;</span>
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Spring框架会取出beanDefinitionMap中的每个BeanDefinition信息，反射构造方法或调用指定的工厂方法生成Bean实例对象，所以只要将BeanDefinition注册到beanDefinitionMap这个Map中，Spring就会进行对应的Bean的实例化操作。</p>
<p>Bean实例及单例池singletonObjects， beanDefinitionMap中的BeanDefinition会被转化成对应的Bean实例对象 ，存储到单例池singletonObjects中去，在DefaultListableBeanFactory的上四级父类 DefaultSingletonBeanRegistry中，维护着singletonObjects，源码如下：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-21-1">1</a></span>
<span class="normal"><a href="#__codelineno-21-2">2</a></span>
<span class="normal"><a href="#__codelineno-21-3">3</a></span>
<span class="normal"><a href="#__codelineno-21-4">4</a></span>
<span class="normal"><a href="#__codelineno-21-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DefaultSingletonBeanRegistry</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-21-2"><a id="__codelineno-21-2" name="__codelineno-21-2"></a><span class="w">    </span><span class="c1">//存储Bean实例的单例池</span>
</span><span id="__span-21-3"><a id="__codelineno-21-3" name="__codelineno-21-3"></a><span class="w">    </span><span class="c1">////key:是Bean的beanName，value:是Bean的实例对象</span>
</span><span id="__span-21-4"><a id="__codelineno-21-4" name="__codelineno-21-4"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">singletonObjects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
</span><span id="__span-21-5"><a id="__codelineno-21-5" name="__codelineno-21-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="spring的后处理器">Spring的后处理器<a class="headerlink" href="#spring的后处理器" title="Permanent link"></a></h4>
<p>Spring的后处理器是Spring对外开发的重要扩展点，允许我们介入到Bean的整个实例化流程中来，以达到动态注册 BeanDefinition，动态修改BeanDefinition，以及动态修改Bean的作用。Spring主要有两种后处理器： </p>
<ul>
<li>BeanFactoryPostProcessor：Bean工厂后处理器，在BeanDefinitionMap填充完毕，Bean实例化之前执行； </li>
<li>BeanPostProcessor：Bean后处理器，一般在Bean实例化之后，填充到单例池singletonObjects之前执行。</li>
</ul>
<h5 id="beanfactorypostprocessor">BeanFactoryPostProcessor<a class="headerlink" href="#beanfactorypostprocessor" title="Permanent link"></a></h5>
<p><a class="glightbox" href="Spring/bean%E5%B7%A5%E5%8E%82%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8.jpeg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/bean%E5%B7%A5%E5%8E%82%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8.jpeg" /></a></p>
<p>BeanFactoryPostProcessor是一个接口规范，实现了该接口的类只要交由Spring容器管理的话，那么Spring就会回调该接口的方法，用于对BeanDefinition注册和修改的功能。可以实现多个BeanPostProcessor并通过Ordered接口设置顺序。BeanFactoryPostProcessor 定义如下：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-22-1">1</a></span>
<span class="normal"><a href="#__codelineno-22-2">2</a></span>
<span class="normal"><a href="#__codelineno-22-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">BeanFactoryPostProcessor</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">postProcessBeanFactory</span><span class="p">(</span><span class="n">ConfigurableListableBeanFactory</span><span class="w"> </span><span class="n">beanFactory</span><span class="p">);</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>ConfigurableListableBeanFactory参数本质就是 DefaultListableBeanFactory，拿到BeanFactory的引用，自然就可以对beanDefinitionMap中的BeanDefinition进行操作了 ，例如对UserDaoImpl的BeanDefinition进行修改操作</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-23-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-23-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-23-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-23-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-23-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-23-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-23-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-23-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-23-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-23-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyBeanFactoryPostProcessor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BeanFactoryPostProcessor</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postProcessBeanFactory</span><span class="p">(</span><span class="n">ConfigurableListableBeanFactory</span><span class="w"> </span><span class="n">beanFactory</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3"></a><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4"></a><span class="w">        </span><span class="n">BeanDefinition</span><span class="w"> </span><span class="n">userDaoBD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">beanFactory</span><span class="p">.</span><span class="na">getBeanDefinition</span><span class="p">(</span><span class="s">&quot;userDao&quot;</span><span class="p">);</span><span class="c1">//获得UserDao定义对象</span>
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5"></a><span class="w">        </span><span class="n">userDaoBD</span><span class="p">.</span><span class="na">setBeanClassName</span><span class="p">(</span><span class="s">&quot;com.itheima.dao.impl.UserDaoImpl2&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">//修改class</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6"></a><span class="w">        </span><span class="c1">//userDaoBD.setInitMethodName(methodName); //修改初始化方法</span>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7"></a><span class="w">        </span><span class="c1">//userDaoBD.setLazyInit(true); //修改是否懒加载</span>
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8"></a><span class="w">        </span><span class="c1">//... 省略其他的设置方式 ...</span>
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Spring 提供了一个BeanFactoryPostProcessor的子接口BeanDefinitionRegistryPostProcessor专门用于注册 BeanDefinition操作。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-24-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-24-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-24-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-24-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-24-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-24-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-24-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-24-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-24-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-24-10">10</a></span>
<span class="normal"><a href="#__codelineno-24-11">11</a></span>
<span class="normal"><a href="#__codelineno-24-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyBeanFactoryPostProcessor2</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BeanDefinitionRegistryPostProcessor</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postProcessBeanFactory</span><span class="p">(</span><span class="n">ConfigurableListableBeanFactory</span><span class="w"> </span>
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4"></a><span class="w">                                       </span><span class="n">configurableListableBeanFactory</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postProcessBeanDefinitionRegistry</span><span class="p">(</span><span class="n">BeanDefinitionRegistry</span><span class="w"> </span><span class="n">beanDefinitionRegistry</span><span class="p">)</span><span class="w"> </span>
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7"></a><span class="w">        </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8"></a><span class="w">        </span><span class="n">BeanDefinition</span><span class="w"> </span><span class="n">beanDefinition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RootBeanDefinition</span><span class="p">();</span>
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9"></a><span class="w">        </span><span class="n">beanDefinition</span><span class="p">.</span><span class="na">setBeanClassName</span><span class="p">(</span><span class="s">&quot;com.itheima.dao.UserDaoImpl2&quot;</span><span class="p">);</span>
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10"></a><span class="w">        </span><span class="n">beanDefinitionRegistry</span><span class="p">.</span><span class="na">registerBeanDefinition</span><span class="p">(</span><span class="s">&quot;userDao2&quot;</span><span class="p">,</span><span class="n">beanDefinition</span><span class="p">);</span>
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>注解开发方式的基本原理就是通过扫描包下的注解，获取添加了注解的类的全类名，然后使用Bean工厂后置处理器注册 BeanDefinition。</p>
<p>常见的 BeanFactory 后处理器：</p>
<ul>
<li>
<p>ConfigurationClassPostProcessor：解析@ComponentScan，@Bean， @Import，@ImportResource</p>
</li>
<li>
<p>MapperScannerConfigurer：解析@MapperScanner</p>
</li>
</ul>
<h5 id="beanpostprocessor">BeanPostProcessor<a class="headerlink" href="#beanpostprocessor" title="Permanent link"></a></h5>
<p>Bean 后处理器的作用：为Bean生命周期各个阶段提供扩展</p>
<p><a class="glightbox" href="Spring/bean%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8.jpeg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/bean%E5%90%8E%E7%BD%AE%E5%A4%84%E7%90%86%E5%99%A8.jpeg" /></a></p>
<p>Bean被实例化后，到最终缓存到名为singletonObjects单例池之前，中间会经过Bean的初始化过程，例如：属性的填充、初始方法init的执行等，其中有一个对外进行扩展的点BeanPostProcessor，称为Bean后处理。跟 Bean工厂后处理器相似，它也是一个接口，实现了该接口并被容器管理的BeanPostProcessor，会在流程节点上被 Spring自动调用。可以实现多个BeanPostProcessor并通过Ordered接口设置顺序。</p>
<p>实现 BeanPostProcessor 接口的类也是一个bean，可以像其他bean一样依赖注入。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-25-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-25-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-25-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-25-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-25-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-25-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-25-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-25-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-25-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-25-10">10</a></span>
<span class="normal"><a href="#__codelineno-25-11">11</a></span>
<span class="normal"><a href="#__codelineno-25-12">12</a></span>
<span class="normal"><a href="#__codelineno-25-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">BeanPostProcessor</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2"></a><span class="w">    </span><span class="nd">@Nullable</span>
</span><span id="__span-25-3"><a id="__codelineno-25-3" name="__codelineno-25-3"></a><span class="w">    </span><span class="c1">// 在属性注入完毕，init初始化方法执行之前被回调</span>
</span><span id="__span-25-4"><a id="__codelineno-25-4" name="__codelineno-25-4"></a><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">postProcessBeforeInitialization</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beanName</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-5"><a id="__codelineno-25-5" name="__codelineno-25-5"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
</span><span id="__span-25-6"><a id="__codelineno-25-6" name="__codelineno-25-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-7"><a id="__codelineno-25-7" name="__codelineno-25-7"></a><span class="w">    </span><span class="nd">@Nullable</span>
</span><span id="__span-25-8"><a id="__codelineno-25-8" name="__codelineno-25-8"></a><span class="w">    </span><span class="c1">// 在初始化方法执行之后，被添加到单例池singletonObjects之前被回调</span>
</span><span id="__span-25-9"><a id="__codelineno-25-9" name="__codelineno-25-9"></a><span class="w">    </span><span class="c1">// 返回的对象会替换原本的bean，例如代理增强</span>
</span><span id="__span-25-10"><a id="__codelineno-25-10" name="__codelineno-25-10"></a><span class="w">    </span><span class="k">default</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beanName</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-25-11"><a id="__codelineno-25-11" name="__codelineno-25-11"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
</span><span id="__span-25-12"><a id="__codelineno-25-12" name="__codelineno-25-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-25-13"><a id="__codelineno-25-13" name="__codelineno-25-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>InstantiationAwareBeanPostProcessor，DestructionAwareBeanPostProcessor是BeanPostProcessor 的子接口，也提供了相应的扩展接口。</p>
<p>常见的Bean后处理器：</p>
<ul>
<li>AutowiredAnnotationBeanPostProcessor：依赖注入阶段解析@Autowired，@Value 注解</li>
<li>CommonAnnotationBeanPostProcessor：依赖注入阶段解析@Resource，初始化前解析@PostConstruct，销毁前@PreDestroy 注解</li>
<li>ConfigurationPropertiesBindingPostProcessor：初始化前解析@ConfigurationProperties 注解</li>
</ul>
<h4 id="bean的生命周期">Bean的生命周期<a class="headerlink" href="#bean的生命周期" title="Permanent link"></a></h4>
<p>Spring Bean的生命周期是从 Bean 实例化之后，即通过反射创建出对象之后，到Bean成为一个完整对象，最终存储到单例池中，这个过程被称为Spring Bean的生命周期。<strong>实例化 —&gt; 属性赋值 —&gt; 初始化 —&gt; 销毁。</strong></p>
<p><strong>1. 创建 Bean 的实例</strong>：Bean 容器首先会找到配置文件中的 Bean 定义，取出<strong>BeanDefinition</strong>信息，然后使用 Java 反射 API 来创建 Bean 的实例。</p>
<p><strong>2. Bean 属性赋值/填充</strong>：为 Bean 设置相关属性和依赖，例如<code>@Autowired</code> 等注解注入的对象、<code>@Value</code> 注入的值、<code>setter</code>方法或构造函数注入依赖和值、<code>@Resource</code>注入的各种资源。</p>
<p><strong>3. Bean 初始化</strong>： </p>
<ul>
<li>
<p>如果实现了 <code>Aware</code>接口，就调用相应的方法。如果 Bean 实现了 <code>BeanNameAware</code> 接口，调用 <code>setBeanName()</code>方法，传入 Bean 的名字。如果 Bean 实现了 <code>BeanClassLoaderAware</code> 接口，调用 <code>setBeanClassLoader()</code>方法，传入 <code>ClassLoader</code>对象的实例。如果 Bean 实现了 <code>BeanFactoryAware</code> 接口，调用 <code>setBeanFactory()</code>方法，传入 <code>BeanFactory</code>对象的实例。</p>
</li>
<li>
<p>如果有和加载这个 Bean 的 Spring 容器相关的 <code>BeanPostProcessor</code> 对象，执行<code>postProcessBeforeInitialization()</code> 方法</p>
</li>
<li>如果 Bean 实现了<code>InitializingBean</code>接口，执行<code>afterPropertiesSet()</code>方法。</li>
<li>如果 Bean 在配置文件中的定义包含 <code>init-method</code> 属性，执行指定的方法。</li>
<li>如果有和加载这个 Bean 的 Spring 容器相关的 <code>BeanPostProcessor</code> 对象，执行<code>postProcessAfterInitialization()</code> 方法。</li>
</ul>
<p><strong>4. 使用 Bean</strong></p>
<p><strong>5. 销毁 Bean</strong>：销毁并不是说要立马把 Bean 给销毁掉，而是把 Bean 的销毁方法先记录下来，将来需要销毁 Bean 或者销毁容器的时候，就调用这些方法去释放 Bean 所持有的资源。 </p>
<ul>
<li>如果 Bean 实现了 <code>DisposableBean</code> 接口，执行 <code>destroy()</code> 方法。</li>
<li>如果 Bean 在配置文件中的定义包含 <code>destroy-method</code> 属性，执行指定的 Bean 销毁方法。或者，也可以直接通过<code>@PreDestroy</code> 注解标记 Bean 销毁之前执行的方法。</li>
</ul>
<p><a class="glightbox" href="Spring/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/bean%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F.png" /></a></p>
<p>Spring在进行属性注入时，会分为如下几种情况： </p>
<ul>
<li>注入普通属性，String、int或存储基本类型的集合时，直接通过set方法的反射设置进去； </li>
<li>注入单向对象引用属性时，从容器中getBean获取后通过set方法反射设置进去，如果容器中没有，则先创建被注入对象Bean实例（完成整个生命周期）后，再进行注入操作； </li>
<li>注入双向对象引用属性时，就比较复杂了，涉及了循环引用（循环依赖）问题。</li>
</ul>
<h4 id="循环依赖">循环依赖<a class="headerlink" href="#循环依赖" title="Permanent link"></a></h4>
<p>Spring创建bean分三步：</p>
<ul>
<li>实例化，即new一个对象</li>
<li>属性注入，即调用setter设置属性值</li>
<li>初始化，执行一些Aware接口的方法，initMethod等</li>
</ul>
<p>两个或多个对象之间相互依赖，导致bean无法实例化。<strong>解决循环依赖问题的关键是提前暴露未完全创建完毕的对象</strong>，实例化之后，在三级缓存中保存一个bean工厂，通过该工厂可以对外暴露未完整的Bean。</p>
<p>循环依赖问题在Spring中主要有三种情况：</p>
<ul>
<li>第一种：通过构造方法进行依赖注入时产生的循环依赖问题。Spring 无法解决循环依赖，构造器注入在实例化时 UserService 就需要UserDao，而此时 UserService 的工厂并没有放入三级缓存，而UserDao依赖UserService 时无法得到。</li>
<li>第二种：通过setter方法进行依赖注入且是在多例（原型）模式下产生的循环依赖问题。Spring 无法解决循环依赖，因为每次都会创建新的实例，无法利用缓存机制。</li>
<li>第三种：通过setter方法进行依赖注入且是在单例模式下产生的循环依赖问题。<strong>三级缓存解决</strong>。</li>
</ul>
<p>Spring提供了三级缓存存储完整Bean实例 和 半成品Bean实例 ，用于解决循环引用问题。在DefaultListableBeanFactory的上四级父类DefaultSingletonBeanRegistry中提供如下三个Map：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-26-1">1</a></span>
<span class="normal"><a href="#__codelineno-26-2">2</a></span>
<span class="normal"><a href="#__codelineno-26-3">3</a></span>
<span class="normal"><a href="#__codelineno-26-4">4</a></span>
<span class="normal"><a href="#__codelineno-26-5">5</a></span>
<span class="normal"><a href="#__codelineno-26-6">6</a></span>
<span class="normal"><a href="#__codelineno-26-7">7</a></span>
<span class="normal"><a href="#__codelineno-26-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DefaultSingletonBeanRegistry</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-26-2"><a id="__codelineno-26-2" name="__codelineno-26-2"></a><span class="w">    </span><span class="c1">//1、存储实例化和初始化都完成的Bean，称之为&quot;一级缓存&quot;</span>
</span><span id="__span-26-3"><a id="__codelineno-26-3" name="__codelineno-26-3"></a><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">singletonObjects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="p">(</span><span class="mi">256</span><span class="p">);</span>
</span><span id="__span-26-4"><a id="__codelineno-26-4" name="__codelineno-26-4"></a><span class="w">    </span><span class="c1">//2、存储已经实例化但还未属性注入和初始化的bean，用于提前暴露对象，称之为&quot;二级缓存&quot;</span>
</span><span id="__span-26-5"><a id="__codelineno-26-5" name="__codelineno-26-5"></a><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">earlySingletonObjects</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ConcurrentHashMap</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
</span><span id="__span-26-6"><a id="__codelineno-26-6" name="__codelineno-26-6"></a><span class="w">    </span><span class="c1">//3、存储单例Bean的工厂，当需要时通过工厂创建早期Bean，称之为&quot;三级缓存&quot;</span>
</span><span id="__span-26-7"><a id="__codelineno-26-7" name="__codelineno-26-7"></a><span class="w">    </span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">ObjectFactory</span><span class="o">&lt;?&gt;&gt;</span><span class="w"> </span><span class="n">singletonFactories</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">HashMap</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
</span><span id="__span-26-8"><a id="__codelineno-26-8" name="__codelineno-26-8"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>Spring 创建 Bean 的流程：</p>
<ol>
<li>先去 <strong>一级缓存 <code>singletonObjects</code></strong> 中获取，存在就返回；</li>
<li>如果不存在或者对象正在创建中，于是去 <strong>二级缓存 <code>earlySingletonObjects</code></strong> 中获取；</li>
<li>如果还没有获取到，就去 <strong>三级缓存 <code>singletonFactories</code></strong> 中获取，通过执行 <code>ObjectFacotry</code> 的 <code>getObject()</code> 就可以获取该对象，获取成功之后，从三级缓存移除，并将该对象加入到二级缓存中。</li>
</ol>
<p>UserService和UserDao循环依赖的过程：</p>
<ol>
<li>
<p>UserService 实例化对象，但尚未初始化，将UserService的工厂存储到三级缓存； </p>
</li>
<li>
<p>UserService 属性注入，需要UserDao，从缓存中获取，没有UserDao； </p>
</li>
<li>
<p>UserDao实例化对象，但尚未初始化，将UserDao的工厂存储到到三级缓存； </p>
</li>
<li>
<p>UserDao属性注入，需要UserService，从三级缓存中通过工厂的 <code>getObject()</code> 获取不完整的UserService，然后UserService从三级缓存移入二级缓存； </p>
</li>
<li>
<p>UserDao执行其他生命周期过程，最终成为一个完整的Bean，存储到一级缓存，删除二三级缓存； </p>
</li>
<li>
<p>UserService 注入UserDao； </p>
</li>
<li>
<p>UserService执行其他生命周期过程，最终成为一个完成Bean，存储到一级缓存，删除二三级缓存。</p>
</li>
</ol>
<p><a class="glightbox" href="Spring/%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98.png" /></a></p>
<p>为什么需要三级缓存？二级缓存可以吗？</p>
<p>二级缓存也可以解决循环依赖问题，但是涉及到动态代理（AOP）时，会导致注入的Bean是未代理的原始对象。</p>
<p>代理对象的生成是基于后置处理器的，是在被代理对象初始化后调用生成的，Spring先在三级缓存中放置一个工厂，如果产生循环依赖，那么就调用这个工厂提早得到代理对象。</p>
<p><a class="glightbox" href="Spring/%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98-%E4%BB%A3%E7%90%86%E9%97%AE%E9%A2%98.jpg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/%E4%B8%89%E7%BA%A7%E7%BC%93%E5%AD%98-%E4%BB%A3%E7%90%86%E9%97%AE%E9%A2%98.jpg" /></a></p>
<blockquote>
<p>B进行属性注入时从三级缓存中获取A，此时如果有代理就会创建A的代理，然后将代理A放入二级缓存，完成B初始化，最后将B放入一级缓存。</p>
<p>A进行初始化时，A要创建代理对象时会首先到二级缓存中找，找到然后放入一级缓存。</p>
</blockquote>
<p>一级缓存可以吗？</p>
<p>理论上是可以的，只要在设计一级缓存时能准确标识当前bean是完整的还是未完整的即可；但是使用二级缓存可以简化开发、提高效率。</p>
<h4 id="spring-ioc-整体流程总结">Spring IoC 整体流程总结<a class="headerlink" href="#spring-ioc-整体流程总结" title="Permanent link"></a></h4>
<p>容器初始化流程分别是：</p>
<ol>
<li>启动：配置加载、创建容器</li>
<li>BeanDefinition 注册：读取解析配置中的Bean定义，形成BeanDefinition对象</li>
<li>实例化和依赖注入</li>
<li>初始化</li>
</ol>
<p><a class="glightbox" href="Spring/IoC%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.jpeg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/IoC%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.jpeg" /></a></p>
<h4 id="spring-xml方式整合第三方框架">Spring xml方式整合第三方框架<a class="headerlink" href="#spring-xml方式整合第三方框架" title="Permanent link"></a></h4>
<p>xml整合第三方框架有两种整合方案：</p>
<ul>
<li>不需要自定义名空间，不需要使用Spring的配置文件配置第三方框架本身内容，例如：MyBatis； </li>
<li>需要引入第三方框架命名空间，需要使用Spring的配置文件配置第三方框架本身内容，例如：Dubbo。</li>
</ul>
<h5 id="不需要自定义名空间">不需要自定义名空间<a class="headerlink" href="#不需要自定义名空间" title="Permanent link"></a></h5>
<p>Spring整合MyBatis的步骤如下： </p>
<ol>
<li>
<p>导入MyBatis整合Spring的相关坐标 mybatis-spring；</p>
</li>
<li>
<p>编写Mapper和Mapper.xml； </p>
</li>
</ol>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-27-1">1</a></span>
<span class="normal"><a href="#__codelineno-27-2">2</a></span>
<span class="normal"><a href="#__codelineno-27-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserMapper</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2"></a><span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">findAll</span><span class="p">();</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-28-1">1</a></span>
<span class="normal"><a href="#__codelineno-28-2">2</a></span>
<span class="normal"><a href="#__codelineno-28-3">3</a></span>
<span class="normal"><a href="#__codelineno-28-4">4</a></span>
<span class="normal"><a href="#__codelineno-28-5">5</a></span>
<span class="normal"><a href="#__codelineno-28-6">6</a></span>
<span class="normal"><a href="#__codelineno-28-7">7</a></span>
<span class="normal"><a href="#__codelineno-28-8">8</a></span>
<span class="normal"><a href="#__codelineno-28-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2"></a><span class="cp">&lt;!DOCTYPE mapper</span>
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3"></a><span class="cp">PUBLIC &quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4"></a><span class="cp">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;&gt;</span>
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5"></a><span class="nt">&lt;mapper</span><span class="w"> </span><span class="na">namespace=</span><span class="s">&quot;com.itheima.dao.UserMapper&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6"></a><span class="w">    </span><span class="nt">&lt;select</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;findAll&quot;</span><span class="w"> </span><span class="na">resultType=</span><span class="s">&quot;com.itheima.pojo.User&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7"></a><span class="w">        </span>select<span class="w"> </span>*<span class="w"> </span>from<span class="w"> </span>tb_user
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8"></a><span class="w">    </span><span class="nt">&lt;/select&gt;</span>
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9"></a><span class="nt">&lt;/mapper&gt;</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>配置SqlSessionFactoryBean和MapperScannerConfigurer； </li>
</ol>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-29-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-29-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-29-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-29-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-29-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-29-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-29-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-29-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-29-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-29-10">10</a></span>
<span class="normal"><a href="#__codelineno-29-11">11</a></span>
<span class="normal"><a href="#__codelineno-29-12">12</a></span>
<span class="normal"><a href="#__codelineno-29-13">13</a></span>
<span class="normal"><a href="#__codelineno-29-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span class="cm">&lt;!--配置数据源--&gt;</span>
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;url&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;jdbc:mysql://localhost:3306/mybatis&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;root&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;root&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span><span id="__span-29-6"><a id="__codelineno-29-6" name="__codelineno-29-6"></a><span class="nt">&lt;/bean&gt;</span>
</span><span id="__span-29-7"><a id="__codelineno-29-7" name="__codelineno-29-7"></a><span class="cm">&lt;!--配置SqlSessionFactoryBean--&gt;</span>
</span><span id="__span-29-8"><a id="__codelineno-29-8" name="__codelineno-29-8"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-29-9"><a id="__codelineno-29-9" name="__codelineno-29-9"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span><span id="__span-29-10"><a id="__codelineno-29-10" name="__codelineno-29-10"></a><span class="nt">&lt;/bean&gt;</span>
</span><span id="__span-29-11"><a id="__codelineno-29-11" name="__codelineno-29-11"></a><span class="cm">&lt;!--配置Mapper包扫描--&gt;</span>
</span><span id="__span-29-12"><a id="__codelineno-29-12" name="__codelineno-29-12"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-29-13"><a id="__codelineno-29-13" name="__codelineno-29-13"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;basePackage&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;com.itheima.dao&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span><span id="__span-29-14"><a id="__codelineno-29-14" name="__codelineno-29-14"></a><span class="nt">&lt;/bean&gt;</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>编写测试代码</li>
</ol>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-30-1">1</a></span>
<span class="normal"><a href="#__codelineno-30-2">2</a></span>
<span class="normal"><a href="#__codelineno-30-3">3</a></span>
<span class="normal"><a href="#__codelineno-30-4">4</a></span>
<span class="normal"><a href="#__codelineno-30-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span class="n">ClassPathxmlApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2"></a><span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">ClassPathxmlApplicationContext</span><span class="p">(</span><span class="s">&quot;applicationContext.xml&quot;</span><span class="p">);</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3"></a><span class="n">UserMapper</span><span class="w"> </span><span class="n">userMapper</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">UserMapper</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4"></a><span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userMapper</span><span class="p">.</span><span class="na">findAll</span><span class="p">();</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5"></a><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">all</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p>配置SqlSessionFactoryBean作用是向容器中提供SqlSessionFactory，SqlSessionFactoryBean实现了 FactoryBean 和 InitializingBean 两个接口，所以会自动执行 getObject() 和 afterPropertiesSet() 方法。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-31-1">1</a></span>
<span class="normal"><a href="#__codelineno-31-2">2</a></span>
<span class="normal"><a href="#__codelineno-31-3">3</a></span>
<span class="normal"><a href="#__codelineno-31-4">4</a></span>
<span class="normal"><a href="#__codelineno-31-5">5</a></span>
<span class="normal"><a href="#__codelineno-31-6">6</a></span>
<span class="normal"><a href="#__codelineno-31-7">7</a></span>
<span class="normal"><a href="#__codelineno-31-8">8</a></span>
<span class="normal"><a href="#__codelineno-31-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span class="n">SqlSessionFactoryBean</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">FactoryBean</span><span class="o">&lt;</span><span class="n">SqlSessionFactory</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">InitializingBean</span><span class="p">{</span>
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterPropertiesSet</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3"></a><span class="w">        </span><span class="c1">//创建SqlSessionFactory对象</span>
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">sqlSessionFactory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">buildSqlSessionFactory</span><span class="p">();</span>
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SqlSessionFactory</span><span class="w"> </span><span class="nf">getObject</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">sqlSessionFactory</span><span class="p">;</span>
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>配置MapperScannerConfigurer作用是扫描Mapper，向容器中注册Mapper对应的MapperFactoryBean， MapperScannerConfigurer实现了BeanDefinitionRegistryPostProcessor和InitializingBean两个接口，会在 postProcessBeanDefinitionRegistry方法中向容器中注册MapperFactoryBean</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-32-1">1</a></span>
<span class="normal"><a href="#__codelineno-32-2">2</a></span>
<span class="normal"><a href="#__codelineno-32-3">3</a></span>
<span class="normal"><a href="#__codelineno-32-4">4</a></span>
<span class="normal"><a href="#__codelineno-32-5">5</a></span>
<span class="normal"><a href="#__codelineno-32-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span class="kd">class</span> <span class="nc">MapperScannerConfigurer</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BeanDefinitionRegistryPostProcessor</span><span class="p">,</span><span class="w"> </span><span class="n">InitializingBean</span><span class="p">{</span>
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">postProcessBeanDefinitionRegistry</span><span class="p">(</span><span class="n">BeanDefinitionRegistry</span><span class="w"> </span><span class="n">registry</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3"></a><span class="w">        </span><span class="n">ClassPathMapperScanner</span><span class="w"> </span><span class="n">scanner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ClassPathMapperScanner</span><span class="p">(</span><span class="n">registry</span><span class="p">);</span>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4"></a><span class="w">        </span><span class="n">scanner</span><span class="p">.</span><span class="na">scan</span><span class="p">(</span><span class="n">StringUtils</span><span class="p">.</span><span class="na">tokenizeToStringArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">basePackage</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;,; \t\n&quot;</span><span class="p">));</span>
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-32-6"><a id="__codelineno-32-6" name="__codelineno-32-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-Java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-33-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-33-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-33-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-33-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-33-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-33-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-33-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-33-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-33-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-33-10">10</a></span>
<span class="normal"><a href="#__codelineno-33-11">11</a></span>
<span class="normal"><a href="#__codelineno-33-12">12</a></span>
<span class="normal"><a href="#__codelineno-33-13">13</a></span>
<span class="normal"><a href="#__codelineno-33-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-33-1"><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span class="kd">class</span> <span class="nc">ClassPathMapperScanner</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ClassPathBeanDefinitionScanner</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-2"><a id="__codelineno-33-2" name="__codelineno-33-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">doScan</span><span class="p">(</span><span class="n">String</span><span class="p">...</span><span class="w"> </span><span class="n">basePackages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-3"><a id="__codelineno-33-3" name="__codelineno-33-3"></a><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span><span class="w"> </span><span class="n">beanDefinitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">super</span><span class="p">.</span><span class="na">doScan</span><span class="p">(</span><span class="n">basePackages</span><span class="p">);</span>
</span><span id="__span-33-4"><a id="__codelineno-33-4" name="__codelineno-33-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">beanDefinitions</span><span class="p">.</span><span class="na">isEmpty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-5"><a id="__codelineno-33-5" name="__codelineno-33-5"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-6"><a id="__codelineno-33-6" name="__codelineno-33-6"></a><span class="w">            </span><span class="k">this</span><span class="p">.</span><span class="na">processBeanDefinitions</span><span class="p">(</span><span class="n">beanDefinitions</span><span class="p">);</span>
</span><span id="__span-33-7"><a id="__codelineno-33-7" name="__codelineno-33-7"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-33-8"><a id="__codelineno-33-8" name="__codelineno-33-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-9"><a id="__codelineno-33-9" name="__codelineno-33-9"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processBeanDefinitions</span><span class="p">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span><span class="w"> </span><span class="n">beanDefinitions</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-33-10"><a id="__codelineno-33-10" name="__codelineno-33-10"></a><span class="w">        </span><span class="c1">//设置Mapper的beanClass是org.mybatis.spring.mapper.MapperFactoryBean</span>
</span><span id="__span-33-11"><a id="__codelineno-33-11" name="__codelineno-33-11"></a><span class="w">        </span><span class="n">definition</span><span class="p">.</span><span class="na">setBeanClass</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">mapperFactoryBeanClass</span><span class="p">);</span>
</span><span id="__span-33-12"><a id="__codelineno-33-12" name="__codelineno-33-12"></a><span class="w">        </span><span class="n">definition</span><span class="p">.</span><span class="na">setAutowireMode</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">//设置MapperBeanFactory进行自动注入 1是根据名称自动装配，2是根据类型自动装配</span>
</span><span id="__span-33-13"><a id="__codelineno-33-13" name="__codelineno-33-13"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-33-14"><a id="__codelineno-33-14" name="__codelineno-33-14"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-34-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-34-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-34-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-34-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-34-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-34-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-34-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-34-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-34-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-34-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-34-1"><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span class="kd">class</span> <span class="nc">ClassPathBeanDefinitionScanner</span><span class="p">{</span>
</span><span id="__span-34-2"><a id="__codelineno-34-2" name="__codelineno-34-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">scan</span><span class="p">(</span><span class="n">String</span><span class="p">...</span><span class="w"> </span><span class="n">basePackages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-3"><a id="__codelineno-34-3" name="__codelineno-34-3"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">doScan</span><span class="p">(</span><span class="n">basePackages</span><span class="p">);</span>
</span><span id="__span-34-4"><a id="__codelineno-34-4" name="__codelineno-34-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-5"><a id="__codelineno-34-5" name="__codelineno-34-5"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">doScan</span><span class="p">(</span><span class="n">String</span><span class="p">...</span><span class="w"> </span><span class="n">basePackages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-34-6"><a id="__codelineno-34-6" name="__codelineno-34-6"></a><span class="w">        </span><span class="c1">//将扫描到的类注册到beanDefinitionMap中，此时beanClass是当前类全限定名</span>
</span><span id="__span-34-7"><a id="__codelineno-34-7" name="__codelineno-34-7"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinition</span><span class="p">(</span><span class="n">definitionHolder</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">registry</span><span class="p">);</span>
</span><span id="__span-34-8"><a id="__codelineno-34-8" name="__codelineno-34-8"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">beanDefinitions</span><span class="p">;</span>
</span><span id="__span-34-9"><a id="__codelineno-34-9" name="__codelineno-34-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-34-10"><a id="__codelineno-34-10" name="__codelineno-34-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-35-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-35-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-35-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-35-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-35-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-35-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-35-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-35-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-35-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-35-10">10</a></span>
<span class="normal"><a href="#__codelineno-35-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-35-1"><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MapperFactoryBean</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">SqlSessionDaoSupport</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">FactoryBean</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-2"><a id="__codelineno-35-2" name="__codelineno-35-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">MapperFactoryBean</span><span class="p">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">mapperInterface</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-3"><a id="__codelineno-35-3" name="__codelineno-35-3"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">mapperInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mapperInterface</span><span class="p">;</span>
</span><span id="__span-35-4"><a id="__codelineno-35-4" name="__codelineno-35-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-5"><a id="__codelineno-35-5" name="__codelineno-35-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setSqlSessionFactory</span><span class="p">(</span><span class="n">SqlSessionFactory</span><span class="w"> </span><span class="n">sqlSessionFactory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-6"><a id="__codelineno-35-6" name="__codelineno-35-6"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">sqlSessionTemplate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">createSqlSessionTemplate</span><span class="p">(</span><span class="n">sqlSessionFactory</span><span class="p">);</span>
</span><span id="__span-35-7"><a id="__codelineno-35-7" name="__codelineno-35-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-8"><a id="__codelineno-35-8" name="__codelineno-35-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">T</span><span class="w"> </span><span class="nf">getObject</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-35-9"><a id="__codelineno-35-9" name="__codelineno-35-9"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getSqlSession</span><span class="p">().</span><span class="na">getMapper</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">mapperInterface</span><span class="p">);</span>
</span><span id="__span-35-10"><a id="__codelineno-35-10" name="__codelineno-35-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-35-11"><a id="__codelineno-35-11" name="__codelineno-35-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><a class="glightbox" href="Spring/MapperScannerConfigurer%E5%8E%9F%E7%90%86.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/MapperScannerConfigurer%E5%8E%9F%E7%90%86.png" /></a></p>
<p>整合包里提供了一个SqlSessionFactoryBean和一个扫描Mapper的配置对象，SqlSessionFactoryBean一旦被实例化，就开始扫描Mapper并通过动态代理产生Mapper的实现类存储到Spring容器中。相关的有如下四个类： </p>
<ul>
<li>SqlSessionFactoryBean：需要进行配置，用于提供SqlSessionFactory； </li>
<li>MapperScannerConfigurer：需要进行配置，用于扫描指定mapper注册BeanDefinition；</li>
<li>MapperFactoryBean：Mapper的FactoryBean，获得指定Mapper时调用getObject方法；</li>
<li>ClassPathMapperScanner：definition.setAutowireMode(2) 修改了自动注入状态，所以 MapperFactoryBean中的setSqlSessionFactory会自动注入进去</li>
</ul>
<h5 id="需要引入第三方框架命名空间">需要引入第三方框架命名空间<a class="headerlink" href="#需要引入第三方框架命名空间" title="Permanent link"></a></h5>
<p>Spring 的 context 是命名空间扩展方式：</p>
<p>引入context命名空间，在使用context命名空间的标签，使用SpEL表达式在xml或注解中根据key获得value</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-36-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-36-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-36-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-36-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-36-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-36-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-36-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-36-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-36-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-36-10">10</a></span>
<span class="normal"><a href="#__codelineno-36-11">11</a></span>
<span class="normal"><a href="#__codelineno-36-12">12</a></span>
<span class="normal"><a href="#__codelineno-36-13">13</a></span>
<span class="normal"><a href="#__codelineno-36-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-36-1"><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span class="nt">&lt;beans</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.springframework.org/schema/beans&quot;</span>
</span><span id="__span-36-2"><a id="__codelineno-36-2" name="__codelineno-36-2"></a><span class="w">       </span><span class="na">xmlns:context=</span><span class="s">&quot;http://www.springframework.org/schema/context&quot;</span>
</span><span id="__span-36-3"><a id="__codelineno-36-3" name="__codelineno-36-3"></a><span class="w">       </span><span class="na">xmlns:xsi=</span><span class="s">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
</span><span id="__span-36-4"><a id="__codelineno-36-4" name="__codelineno-36-4"></a><span class="w">       </span><span class="na">xsi:schemaLocation=</span><span class="s">&quot;http://www.springframework.org/schema/beans </span>
</span><span id="__span-36-5"><a id="__codelineno-36-5" name="__codelineno-36-5"></a><span class="s">                           http://www.springframework.org/schema/beans/spring-beans.xsd</span>
</span><span id="__span-36-6"><a id="__codelineno-36-6" name="__codelineno-36-6"></a><span class="s">                           http://www.springframework.org/schema/context </span>
</span><span id="__span-36-7"><a id="__codelineno-36-7" name="__codelineno-36-7"></a><span class="s">                           http://www.springframework.org/schema/context/spring-context.xsd&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-36-8"><a id="__codelineno-36-8" name="__codelineno-36-8"></a><span class="w">    </span><span class="nt">&lt;context:property-placeholder</span><span class="w"> </span><span class="na">location=</span><span class="s">&quot;classpath:jdbc.properties&quot;</span><span class="w"> </span><span class="nt">/&gt;</span>
</span><span id="__span-36-9"><a id="__codelineno-36-9" name="__codelineno-36-9"></a><span class="w">    </span><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-36-10"><a id="__codelineno-36-10" name="__codelineno-36-10"></a><span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;url&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${jdbc.url}&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span><span id="__span-36-11"><a id="__codelineno-36-11" name="__codelineno-36-11"></a><span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;username&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${jdbc.username}&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span><span id="__span-36-12"><a id="__codelineno-36-12" name="__codelineno-36-12"></a><span class="w">        </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;${jdbc.password}&quot;</span><span class="nt">&gt;&lt;/property&gt;</span>
</span><span id="__span-36-13"><a id="__codelineno-36-13" name="__codelineno-36-13"></a><span class="w">    </span><span class="nt">&lt;/bean&gt;</span>
</span><span id="__span-36-14"><a id="__codelineno-36-14" name="__codelineno-36-14"></a><span class="nt">&lt;beans&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>1）在创建DefaultNamespaceHandlerResolver时，为处理器映射地址handlerMappingsLocation属性赋值，并加载命名空间处理器到handlerMappings 中去，Map集合handlerMappings就被填充了很多XxxNamespaceHandler。</p>
<p>2）在DefaultBeanDefinitionDocumentReader的parseBeanDefinitions方法中：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-37-1">1</a></span>
<span class="normal"><a href="#__codelineno-37-2">2</a></span>
<span class="normal"><a href="#__codelineno-37-3">3</a></span>
<span class="normal"><a href="#__codelineno-37-4">4</a></span>
<span class="normal"><a href="#__codelineno-37-5">5</a></span>
<span class="normal"><a href="#__codelineno-37-6">6</a></span>
<span class="normal"><a href="#__codelineno-37-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-37-1"><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span class="c1">//如果是默认命名空间</span>
</span><span id="__span-37-2"><a id="__codelineno-37-2" name="__codelineno-37-2"></a><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">delegate</span><span class="p">.</span><span class="na">isDefaultNamespace</span><span class="p">(</span><span class="n">ele</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-3"><a id="__codelineno-37-3" name="__codelineno-37-3"></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">parseDefaultElement</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span><span class="w"> </span><span class="n">delegate</span><span class="p">);</span>
</span><span id="__span-37-4"><a id="__codelineno-37-4" name="__codelineno-37-4"></a><span class="w">    </span><span class="c1">//否则是自定义命名空间</span>
</span><span id="__span-37-5"><a id="__codelineno-37-5" name="__codelineno-37-5"></a><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-37-6"><a id="__codelineno-37-6" name="__codelineno-37-6"></a><span class="w">    </span><span class="n">delegate</span><span class="p">.</span><span class="na">parseCustomElement</span><span class="p">(</span><span class="n">ele</span><span class="p">);</span>
</span><span id="__span-37-7"><a id="__codelineno-37-7" name="__codelineno-37-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-38-1">1</a></span>
<span class="normal"><a href="#__codelineno-38-2">2</a></span>
<span class="normal"><a href="#__codelineno-38-3">3</a></span>
<span class="normal"><a href="#__codelineno-38-4">4</a></span>
<span class="normal"><a href="#__codelineno-38-5">5</a></span>
<span class="normal"><a href="#__codelineno-38-6">6</a></span>
<span class="normal"><a href="#__codelineno-38-7">7</a></span>
<span class="normal"><a href="#__codelineno-38-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-38-1"><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span class="kd">public</span><span class="w"> </span><span class="n">BeanDefinition</span><span class="w"> </span><span class="nf">parseCustomElement</span><span class="p">(</span><span class="n">Element</span><span class="w"> </span><span class="n">ele</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">BeanDefinition</span><span class="w"> </span><span class="n">containingBd</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-38-2"><a id="__codelineno-38-2" name="__codelineno-38-2"></a><span class="w">    </span><span class="c1">//解析命名空间</span>
</span><span id="__span-38-3"><a id="__codelineno-38-3" name="__codelineno-38-3"></a><span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">namespaceUri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getNamespaceURI</span><span class="p">(</span><span class="n">ele</span><span class="p">);</span>
</span><span id="__span-38-4"><a id="__codelineno-38-4" name="__codelineno-38-4"></a><span class="w">    </span><span class="c1">//获得命名空间解析器</span>
</span><span id="__span-38-5"><a id="__codelineno-38-5" name="__codelineno-38-5"></a><span class="w">    </span><span class="n">NamespaceHandler</span><span class="w"> </span><span class="n">handler</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">readerContext</span><span class="p">.</span><span class="na">getNamespaceHandlerResolver</span><span class="p">().</span><span class="na">resolve</span><span class="p">(</span><span class="n">namespaceUri</span><span class="p">);</span>
</span><span id="__span-38-6"><a id="__codelineno-38-6" name="__codelineno-38-6"></a><span class="w">    </span><span class="c1">//解析执行的标签</span>
</span><span id="__span-38-7"><a id="__codelineno-38-7" name="__codelineno-38-7"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">handler</span><span class="p">.</span><span class="na">parse</span><span class="p">(</span><span class="n">ele</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ParserContext</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">readerContext</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">containingBd</span><span class="p">));</span>
</span><span id="__span-38-8"><a id="__codelineno-38-8" name="__codelineno-38-8"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>在执行resovle方法时，就是从handlerMappings中根据命名空间名称获得对应的处理器对象，此处是ContextNamespaceHandler，最终执行NamespaceHandler的parse方法。</p>
<p>ContextNamespaceHandler源码如下，间接实现了NamespaceHandler接口，初始化方法init会被自动调用。由于 context命名空间下有多个标签，所以每个标签又单独注册了对应的解析器，注册到了其父类 NamespaceHandlerSupport的parsers中去了。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-39-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-39-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-39-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-39-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-39-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-39-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-39-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-39-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-39-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-39-10">10</a></span>
<span class="normal"><a href="#__codelineno-39-11">11</a></span>
<span class="normal"><a href="#__codelineno-39-12">12</a></span>
<span class="normal"><a href="#__codelineno-39-13">13</a></span>
<span class="normal"><a href="#__codelineno-39-14">14</a></span>
<span class="normal"><a href="#__codelineno-39-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-39-1"><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ContextNamespaceHandler</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">NamespaceHandlerSupport</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-2"><a id="__codelineno-39-2" name="__codelineno-39-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="nf">ContextNamespaceHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-3"><a id="__codelineno-39-3" name="__codelineno-39-3"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-4"><a id="__codelineno-39-4" name="__codelineno-39-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-39-5"><a id="__codelineno-39-5" name="__codelineno-39-5"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;property-placeholder&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span>
</span><span id="__span-39-6"><a id="__codelineno-39-6" name="__codelineno-39-6"></a><span class="w">                                          </span><span class="n">PropertyPlaceholderBeanDefinitionParser</span><span class="p">());</span>
</span><span id="__span-39-7"><a id="__codelineno-39-7" name="__codelineno-39-7"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;property-override&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PropertyOverrideBeanDefinitionParser</span><span class="p">());</span>
</span><span id="__span-39-8"><a id="__codelineno-39-8" name="__codelineno-39-8"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;annotation-config&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AnnotationConfigBeanDefinitionParser</span><span class="p">());</span>
</span><span id="__span-39-9"><a id="__codelineno-39-9" name="__codelineno-39-9"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;component-scan&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ComponentScanBeanDefinitionParser</span><span class="p">());</span>
</span><span id="__span-39-10"><a id="__codelineno-39-10" name="__codelineno-39-10"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;load-time-weaver&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">LoadTimeWeaverBeanDefinitionParser</span><span class="p">());</span>
</span><span id="__span-39-11"><a id="__codelineno-39-11" name="__codelineno-39-11"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;spring-configured&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SpringConfiguredBeanDefinitionParser</span><span class="p">());</span>
</span><span id="__span-39-12"><a id="__codelineno-39-12" name="__codelineno-39-12"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;mbean-export&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MBeanExportBeanDefinitionParser</span><span class="p">());</span>
</span><span id="__span-39-13"><a id="__codelineno-39-13" name="__codelineno-39-13"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;mbean-server&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MBeanServerBeanDefinitionParser</span><span class="p">());</span>
</span><span id="__span-39-14"><a id="__codelineno-39-14" name="__codelineno-39-14"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-39-15"><a id="__codelineno-39-15" name="__codelineno-39-15"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>外部命名空间标签的执行流程，如下:</p>
<ol>
<li>将自定义标签的约束与 物理约束文件与网络约束名称的约束 以键值对形式存储到一个spring.schemas文件里 ，该文件存储在类加载路径的 META-INF里，Spring会自动加载到; </li>
<li>将自定义命名空间的名称 与 自定义命名空间的处理器映射关系 以键值对形式存在到一个叫spring.handlers文件里，该文件存储在类加载路径的 META-INF里，Spring会自动加载到; </li>
<li>准备好NamespaceHandler，如果命名空间只有一个标签，那么直接在parse方法中进行解析即可，一般解析结果就是注册该标签对应的BeanDefinition。如果命名空间里有多个标签，那么可以在init方法中为每个标签都注册一个BeanDefinitionParser，在执行NamespaceHandler的parse方法时在分流给不同的 BeanDefinitionParser进行解析(重写doParse方法即可)。</li>
</ol>
<p>Spring xml方式整合第三方框架步骤分析： </p>
<ol>
<li>
<p>确定命名空间名称、schema虚拟路径、标签名称； </p>
</li>
<li>
<p>编写schema约束文件xxx.xsd </p>
</li>
<li>
<p>在类加载路径下创建META目录，编写约束映射文件spring.schemas和处理器映射文件spring.handlers </p>
</li>
<li>
<p>编写命名空间处理器 XxxNamespaceHandler，在init方法中注册XxxBeanDefinitionParser</p>
</li>
</ol>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-40-1">1</a></span>
<span class="normal"><a href="#__codelineno-40-2">2</a></span>
<span class="normal"><a href="#__codelineno-40-3">3</a></span>
<span class="normal"><a href="#__codelineno-40-4">4</a></span>
<span class="normal"><a href="#__codelineno-40-5">5</a></span>
<span class="normal"><a href="#__codelineno-40-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-40-1"><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">XxxNamespaceHandler</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">NamespaceHandlerSupport</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-2"><a id="__codelineno-40-2" name="__codelineno-40-2"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-40-3"><a id="__codelineno-40-3" name="__codelineno-40-3"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-40-4"><a id="__codelineno-40-4" name="__codelineno-40-4"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;annotation-driven&quot;</span><span class="p">,</span><span class="k">new</span><span class="w"> </span><span class="n">XxxBeanDefinitionParser</span><span class="p">());</span>
</span><span id="__span-40-5"><a id="__codelineno-40-5" name="__codelineno-40-5"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-40-6"><a id="__codelineno-40-6" name="__codelineno-40-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>编写标签的解析器 XxxBeanDefinitionParser，在parse方法中编写实现 </li>
</ol>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-41-1">1</a></span>
<span class="normal"><a href="#__codelineno-41-2">2</a></span>
<span class="normal"><a href="#__codelineno-41-3">3</a></span>
<span class="normal"><a href="#__codelineno-41-4">4</a></span>
<span class="normal"><a href="#__codelineno-41-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-41-1"><a id="__codelineno-41-1" name="__codelineno-41-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">XxxBeanDefinitionParser</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BeanDefinitionParser</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-2"><a id="__codelineno-41-2" name="__codelineno-41-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BeanDefinition</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">Element</span><span class="w"> </span><span class="n">element</span><span class="p">,</span><span class="w"> </span><span class="n">ParserContext</span><span class="w"> </span><span class="n">parserContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-41-3"><a id="__codelineno-41-3" name="__codelineno-41-3"></a>
</span><span id="__span-41-4"><a id="__codelineno-41-4" name="__codelineno-41-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-41-5"><a id="__codelineno-41-5" name="__codelineno-41-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>使用步骤：</p>
<ol>
<li>在applicationContext.xml配置文件中引入命名空间 </li>
<li>在applicationContext.xml配置文件中使用自定义的标</li>
</ol>
<h3 id="基于注解的spring应用">基于注解的Spring应用<a class="headerlink" href="#基于注解的spring应用" title="Permanent link"></a></h3>
<h4 id="bean基本注解开发">Bean基本注解开发<a class="headerlink" href="#bean基本注解开发" title="Permanent link"></a></h4>
<p>使用@Component 注解替代<code>&lt;bean&gt;</code>标签，被该注解标识的类，会在指定扫描范围内被Spring加载并实例化。可以通过@Component注解的value属性指定当前Bean实例的beanName，也可以省略不写，不写的情况下为当前类名首字母小写。</p>
<p>由于JavaEE开发是分层的，为了每层Bean标识的注解语义化更加明确，@Component又衍生出如下三个注解：</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Component</td>
<td>该注解用于描述 Spring 中的 Bean，它是一个泛化的概念，仅仅表示容器中的一个组件（Bean），并且可以作用在应用的任何层次，例如 Service 层、Dao 层等。 使用时只需将该注解标注在相应类上即可。</td>
</tr>
<tr>
<td>@Repository</td>
<td>该注解用于将数据访问层（Dao 层）的类标识为 Spring 中的 Bean，其功能与 @Component 相同。</td>
</tr>
<tr>
<td>@Service</td>
<td>该注解通常作用在业务层（Service 层），用于将业务层的类标识为 Spring 中的 Bean，其功能与 @Component 相同。</td>
</tr>
<tr>
<td>@Controller</td>
<td>该注解通常作用在控制层（如SpringMVC 的 Controller），用于将控制层的类标识为 Spring 中的 Bean，其功能与 @Component 相同。</td>
</tr>
</tbody>
</table>
<p>使用注解对需要被Spring实例化的Bean进行标注，但是需要告诉Spring去哪找这些Bean，要配置组件扫描路径：</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-42-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-42-1"><a id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="nt">&lt;context:component-scan</span><span class="w"> </span><span class="na">base-package=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>其他基础注解：</p>
<table>
<thead>
<tr>
<th>xml配置</th>
<th>注解</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;bean scope=""&gt;</code></td>
<td>@Scope</td>
<td>在类上或使用了@Bean标注的方法上，标注Bean的作用范围，取值为 singleton或prototype</td>
</tr>
<tr>
<td><code>&lt;bean lazy-init=""&gt;</code></td>
<td>@Lazy</td>
<td>在类上或使用了@Bean标注的方法上，标注Bean是否延迟加载，取值为 true和false</td>
</tr>
<tr>
<td><code>&lt;bean init-method=""&gt;</code></td>
<td>@PostConstruct</td>
<td>在方法上使用，标注Bean的初始化化后执行的方法</td>
</tr>
<tr>
<td><code>&lt;bean destroy-method=""&gt;</code></td>
<td>@PreDestroy</td>
<td>在方法上使用，标注Bean的销毁前执行方法</td>
</tr>
</tbody>
</table>
<h4 id="bean依赖注入注解开发">Bean依赖注入注解开发<a class="headerlink" href="#bean依赖注入注解开发" title="Permanent link"></a></h4>
<p>Bean依赖注入的注解，主要是使用注解的方式替代xml的 标签完成属性的注入操作：</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-43-1">1</a></span>
<span class="normal"><a href="#__codelineno-43-2">2</a></span>
<span class="normal"><a href="#__codelineno-43-3">3</a></span>
<span class="normal"><a href="#__codelineno-43-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-43-1"><a id="__codelineno-43-1" name="__codelineno-43-1"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-43-2"><a id="__codelineno-43-2" name="__codelineno-43-2"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-43-3"><a id="__codelineno-43-3" name="__codelineno-43-3"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-43-4"><a id="__codelineno-43-4" name="__codelineno-43-4"></a><span class="nt">&lt;/bean&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>Spring主要提供如下注解，用于在Bean内部进行属性注入的：</p>
<table>
<thead>
<tr>
<th>属性注入注解</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Value</td>
<td>使用在字段或方法上，用于注入普通数据</td>
</tr>
<tr>
<td>@Autowired</td>
<td>使用在字段或方法上，根据类型注入</td>
</tr>
<tr>
<td>@Qualifier</td>
<td>使用在字段或方法上，结合@Autowired，根据名称注入</td>
</tr>
<tr>
<td>@Resource</td>
<td>使用在字段或方法上，根据类型或名称进行注入</td>
</tr>
</tbody>
</table>
<p>@Autowired注解，当容器中同一类型的Bean实例有多个时，会尝试自动根据名字进行匹配；当容器中同一类型的Bean实例有多个时，且名字与被注入Bean名称不匹配时会报错。</p>
<p>@Qualifier配合@Autowired可以完成根据名称注入Bean实例，使用@Qualifier指定名称。</p>
<p>@Resource注解既可以根据类型注入，也可以根据名称注入，无参就是根据类型注入，有参数就是根据名称注入。</p>
<p>依赖注入方式：</p>
<ol>
<li>属性注入：属性上加上注解完成注入，不需要生成setter()方法</li>
<li>set注入：setter()方法之上加上注解</li>
<li>构造方法注入：构造方法之上加上注解</li>
<li>普通方法注入：普通方法之上加上注解，可以注入单个属性、集合和<code>Map&lt;String, T&gt;</code></li>
<li>形参注入：<code>public UserServiceImpl(@Autowired UserDao userDao) {this.userDao = userDao;}</code></li>
<li>只有一个构造器，无注解：当有参数的构造方法只有一个时，注解可以省略。</li>
</ol>
<blockquote>
<p><strong>构造函数注入还是 Setter 注入？</strong></p>
</blockquote>
<p><strong>Spring 官方推荐构造函数注入</strong>，这种注入方式的优势如下：</p>
<ol>
<li>依赖完整性：确保所有必需依赖在对象创建时就被注入，避免了空指针异常的风险。</li>
<li>不可变性：有助于创建不可变对象，提高了线程安全性。</li>
<li>初始化保证：组件在使用前已完全初始化，减少了潜在的错误。</li>
<li>测试便利性：在单元测试中，可以直接通过构造函数传入模拟的依赖项，而不必依赖 Spring 容器进行注入。</li>
</ol>
<p>构造函数注入适合处理<strong>必需的依赖项</strong>，而 <strong>Setter 注入</strong> 则更适合<strong>可选的依赖项</strong>，这些依赖项可以有默认值或在对象生命周期中动态设置。虽然 <code>@Autowired</code> 可以用于 Setter 方法来处理必需的依赖项，但构造函数注入仍然是更好的选择。</p>
<p>在某些情况下（例如第三方类不提供 Setter 方法），构造函数注入可能是<strong>唯一的选择</strong></p>
<p>@Resource和@Autowired注解有什么区别？</p>
<ol>
<li>
<p>@Resource注解是JDK扩展包中的，也就是说属于JDK的一部分。所以该注解是标准注解，更加具有通用性。@Autowired注解是Spring框架自己的。</p>
</li>
<li>
<p>@Resource注解既可以根据类型注入，也可以根据名称注入，无参就是根据类型注入，有参数就是根据名称注入。@Autowired注解默认根据类型装配byType，如果想根据名称装配，需要配合@Qualifier注解一起用。</p>
</li>
<li>
<p>@Autowired 支持在构造函数、方法、字段和参数上使用。@Resource 主要用于字段和方法上的注入，不支持在构造函数或参数上使用。</p>
</li>
</ol>
<p>@Resource注解属于JDK扩展包，所以不在JDK当中，需要额外引入以下依赖：【如果是JDK8的话不需要额外引入依赖。高于JDK11或低于JDK8需要引入以下依赖。】</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-44-1">1</a></span>
<span class="normal"><a href="#__codelineno-44-2">2</a></span>
<span class="normal"><a href="#__codelineno-44-3">3</a></span>
<span class="normal"><a href="#__codelineno-44-4">4</a></span>
<span class="normal"><a href="#__codelineno-44-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-44-1"><a id="__codelineno-44-1" name="__codelineno-44-1"></a><span class="nt">&lt;dependency&gt;</span>
</span><span id="__span-44-2"><a id="__codelineno-44-2" name="__codelineno-44-2"></a><span class="w">    </span><span class="nt">&lt;groupId&gt;</span>jakarta.annotation<span class="nt">&lt;/groupId&gt;</span>
</span><span id="__span-44-3"><a id="__codelineno-44-3" name="__codelineno-44-3"></a><span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>jakarta.annotation-api<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="__span-44-4"><a id="__codelineno-44-4" name="__codelineno-44-4"></a><span class="w">    </span><span class="nt">&lt;version&gt;</span>2.1.1<span class="nt">&lt;/version&gt;</span>
</span><span id="__span-44-5"><a id="__codelineno-44-5" name="__codelineno-44-5"></a><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="非自定义bean注解开发">非自定义Bean注解开发<a class="headerlink" href="#非自定义bean注解开发" title="Permanent link"></a></h4>
<p>非自定义Bean不能像自定义Bean一样使用@Component进行管理，非自定义Bean要通过工厂的方式进行实例化， 使用@Bean标注方法即可，@Bean的属性为beanName，如不指定为当前工厂方法名称。</p>
<p>工厂方法所在类必须要被Spring管理。</p>
<p>如果@Bean工厂方法需要参数的话，则有如下几种注入方式： </p>
<ul>
<li>使用@Autowired 根据类型自动进行Bean的匹配，@Autowired可以省略 ； </li>
<li>使用@Qualifier 根据名称进行Bean的匹配；</li>
<li>使用@Value 根据名称进行普通数据类型匹配。</li>
</ul>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-45-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-45-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-45-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-45-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-45-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-45-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-45-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-45-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-45-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-45-10">10</a></span>
<span class="normal"><a href="#__codelineno-45-11">11</a></span>
<span class="normal"><a href="#__codelineno-45-12">12</a></span>
<span class="normal"><a href="#__codelineno-45-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-45-1"><a id="__codelineno-45-1" name="__codelineno-45-1"></a><span class="nd">@Bean</span>
</span><span id="__span-45-2"><a id="__codelineno-45-2" name="__codelineno-45-2"></a><span class="nd">@Autowired</span><span class="w"> </span><span class="c1">//根据类型匹配参数</span>
</span><span id="__span-45-3"><a id="__codelineno-45-3" name="__codelineno-45-3"></a><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">objectDemo01</span><span class="p">(</span><span class="n">UserDao</span><span class="w"> </span><span class="n">userDao</span><span class="p">){</span>
</span><span id="__span-45-4"><a id="__codelineno-45-4" name="__codelineno-45-4"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">userDao</span><span class="p">);</span>
</span><span id="__span-45-5"><a id="__codelineno-45-5" name="__codelineno-45-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">();</span>
</span><span id="__span-45-6"><a id="__codelineno-45-6" name="__codelineno-45-6"></a><span class="p">}</span>
</span><span id="__span-45-7"><a id="__codelineno-45-7" name="__codelineno-45-7"></a><span class="nd">@Bean</span>
</span><span id="__span-45-8"><a id="__codelineno-45-8" name="__codelineno-45-8"></a><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">objectDemo02</span><span class="p">(</span><span class="nd">@Qualifier</span><span class="p">(</span><span class="s">&quot;userDao&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">UserDao</span><span class="w"> </span><span class="n">userDao</span><span class="p">,</span>
</span><span id="__span-45-9"><a id="__codelineno-45-9" name="__codelineno-45-9"></a><span class="w">                           </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${jdbc.username}&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">){</span>
</span><span id="__span-45-10"><a id="__codelineno-45-10" name="__codelineno-45-10"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">userDao</span><span class="p">);</span>
</span><span id="__span-45-11"><a id="__codelineno-45-11" name="__codelineno-45-11"></a><span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
</span><span id="__span-45-12"><a id="__codelineno-45-12" name="__codelineno-45-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Object</span><span class="p">();</span>
</span><span id="__span-45-13"><a id="__codelineno-45-13" name="__codelineno-45-13"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="bean配置类的注解开发">Bean配置类的注解开发<a class="headerlink" href="#bean配置类的注解开发" title="Permanent link"></a></h4>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-46-1">1</a></span>
<span class="normal"><a href="#__codelineno-46-2">2</a></span>
<span class="normal"><a href="#__codelineno-46-3">3</a></span>
<span class="normal"><a href="#__codelineno-46-4">4</a></span>
<span class="normal"><a href="#__codelineno-46-5">5</a></span>
<span class="normal"><a href="#__codelineno-46-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-46-1"><a id="__codelineno-46-1" name="__codelineno-46-1"></a><span class="cm">&lt;!-- 加载properties文件 --&gt;</span>
</span><span id="__span-46-2"><a id="__codelineno-46-2" name="__codelineno-46-2"></a><span class="nt">&lt;context:property-placeholder</span><span class="w"> </span><span class="na">location=</span><span class="s">&quot;classpath:jdbc.properties&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-46-3"><a id="__codelineno-46-3" name="__codelineno-46-3"></a><span class="cm">&lt;!-- 组件扫描 --&gt;</span>
</span><span id="__span-46-4"><a id="__codelineno-46-4" name="__codelineno-46-4"></a><span class="nt">&lt;context:component-scan</span><span class="w"> </span><span class="na">base-package=</span><span class="s">&quot;com.itheima&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-46-5"><a id="__codelineno-46-5" name="__codelineno-46-5"></a><span class="cm">&lt;!-- 引入其他xml文件 --&gt;</span>
</span><span id="__span-46-6"><a id="__codelineno-46-6" name="__codelineno-46-6"></a><span class="nt">&lt;import</span><span class="w"> </span><span class="na">resource=</span><span class="s">&quot;classpath:beans.xml&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>定义一个配置类替代原有的xml配置文件，一般都是在配置类上使用注解完成的：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-47-1">1</a></span>
<span class="normal"><a href="#__codelineno-47-2">2</a></span>
<span class="normal"><a href="#__codelineno-47-3">3</a></span>
<span class="normal"><a href="#__codelineno-47-4">4</a></span>
<span class="normal"><a href="#__codelineno-47-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-47-1"><a id="__codelineno-47-1" name="__codelineno-47-1"></a><span class="nd">@Configuration</span>
</span><span id="__span-47-2"><a id="__codelineno-47-2" name="__codelineno-47-2"></a><span class="nd">@ComponentScan</span><span class="p">(</span><span class="s">&quot;com.itheima&quot;</span><span class="p">)</span>
</span><span id="__span-47-3"><a id="__codelineno-47-3" name="__codelineno-47-3"></a><span class="nd">@PropertySource</span><span class="p">(</span><span class="s">&quot;classpath:jdbc.properties&quot;</span><span class="p">)</span>
</span><span id="__span-47-4"><a id="__codelineno-47-4" name="__codelineno-47-4"></a><span class="nd">@Import</span><span class="p">(</span><span class="n">OtherConfig</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span><span id="__span-47-5"><a id="__codelineno-47-5" name="__codelineno-47-5"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ApplicationContextConfig</span><span class="w"> </span><span class="p">{}</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>
<p>@Configuration注解标识的类为配置类，替代原有xml配置文件，该注解第一个作用是标识该类是一个配置类，第二个作用是具备@Component作用。这个注解还有一个更加强大的功能，它可以保障配置类中使用方法创建的bean的唯一性，为@Configuration注解设置proxyBeanMethods属性值为true即可，此属性默认值为true。注意，必须使用spring容器对象调用此方法才有保持bean唯一性的特性。</p>
</li>
<li>
<p>@ComponentScan 组件扫描配置，替代原有xml文件中的 <code>&lt;component-scan&gt;</code></p>
</li>
</ul>
<p>base-package的配置方式： </p>
<ul>
<li>
<p>指定一个或多个包名：扫描指定包及其子包下使用注解的类 </p>
</li>
<li>
<p>不配置包名：扫描当前@componentScan注解配置类所在包及其子包下的类</p>
</li>
<li>
<p>@PropertySource 注解用于加载外部properties资源配置，替代原有xml中<code>&lt;property-placeholder&gt;</code>的配置</p>
</li>
<li>
<p>@Import 用于加载其他配置类，替代原有xml中的<code>&lt;import&gt;</code>配置</p>
</li>
</ul>
<h4 id="spring-配置其他注解">Spring 配置其他注解<a class="headerlink" href="#spring-配置其他注解" title="Permanent link"></a></h4>
<p>@Primary注解用于标注相同类型的Bean优先被使用权，@Primary 是Spring3.0引入的，与@Component 和@Bean一起使用，标注该注解的Bean的优先级更高，在通过类型获取Bean或通过@Autowired根据类型进行注入时， 会选用优先级更高的。</p>
<p>@Profile 标注在类或方法上，标注当前产生的Bean从属于哪个环境，只有激活了当前环境，被标注的Bean才 能被注册到Spring容器里，不指定环境的Bean，任何环境下都能注册到Spring容器里。可以使用以下两种方式指定被激活的环境： </p>
<ul>
<li>使用命令行动态参数，虚拟机参数位置加载 -Dspring.profiles.active=test </li>
<li>使用代码的方式设置环境变量 System.setProperty("spring.profiles.active","test")</li>
</ul>
<h4 id="spring注解的解析原理">Spring注解的解析原理<a class="headerlink" href="#spring注解的解析原理" title="Permanent link"></a></h4>
<p>Spring注解的解析原理使用@Component等注解配置完毕后，要配置组件扫描才能使注解生效</p>
<ul>
<li>xml配置组件扫描：</li>
</ul>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-48-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-48-1"><a id="__codelineno-48-1" name="__codelineno-48-1"></a><span class="nt">&lt;context:component-scan</span><span class="w"> </span><span class="na">base-package=</span><span class="s">&quot;com.itheima&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></div></td></tr></table></div>
<ul>
<li>配置类配置组件扫描：</li>
</ul>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-49-1">1</a></span>
<span class="normal"><a href="#__codelineno-49-2">2</a></span>
<span class="normal"><a href="#__codelineno-49-3">3</a></span>
<span class="normal"><a href="#__codelineno-49-4">4</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-49-1"><a id="__codelineno-49-1" name="__codelineno-49-1"></a><span class="nd">@Configuration</span>
</span><span id="__span-49-2"><a id="__codelineno-49-2" name="__codelineno-49-2"></a><span class="nd">@ComponentScan</span><span class="p">(</span><span class="s">&quot;com.itheima&quot;</span><span class="p">)</span>
</span><span id="__span-49-3"><a id="__codelineno-49-3" name="__codelineno-49-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AppConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-49-4"><a id="__codelineno-49-4" name="__codelineno-49-4"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>xml方式配置组件扫描，component-scan的原理是context命名空间下的自定义标签：</p>
<p>1）找到对应的命名空间处理器NamespaceHandler 和解析器，查看spring-context包下的spring.handlers文件</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-50-1">1</a></span>
<span class="normal"><a href="#__codelineno-50-2">2</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-50-1"><a id="__codelineno-50-1" name="__codelineno-50-1"></a>http\://www.springframework.org/schema/context=org.springframework.context.config.ContextNames
</span><span id="__span-50-2"><a id="__codelineno-50-2" name="__codelineno-50-2"></a>paceHandler
</span></code></pre></div></td></tr></table></div>
<p>2）查看 ContextNamespaceHandler 类:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-51-1">1</a></span>
<span class="normal"><a href="#__codelineno-51-2">2</a></span>
<span class="normal"><a href="#__codelineno-51-3">3</a></span>
<span class="normal"><a href="#__codelineno-51-4">4</a></span>
<span class="normal"><a href="#__codelineno-51-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-51-1"><a id="__codelineno-51-1" name="__codelineno-51-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ContextNamespaceHandler</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">NamespaceHandlerSupport</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-2"><a id="__codelineno-51-2" name="__codelineno-51-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-51-3"><a id="__codelineno-51-3" name="__codelineno-51-3"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;component-scan&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ComponentScanBeanDefinitionParser</span><span class="p">());</span>
</span><span id="__span-51-4"><a id="__codelineno-51-4" name="__codelineno-51-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-51-5"><a id="__codelineno-51-5" name="__codelineno-51-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>3）ComponentScanBeanDefinitionParser#parse 扫描标注了@Component的类，生成对应的BeanDefiition并进行注册</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-52-1">1</a></span>
<span class="normal"><a href="#__codelineno-52-2">2</a></span>
<span class="normal"><a href="#__codelineno-52-3">3</a></span>
<span class="normal"><a href="#__codelineno-52-4">4</a></span>
<span class="normal"><a href="#__codelineno-52-5">5</a></span>
<span class="normal"><a href="#__codelineno-52-6">6</a></span>
<span class="normal"><a href="#__codelineno-52-7">7</a></span>
<span class="normal"><a href="#__codelineno-52-8">8</a></span>
<span class="normal"><a href="#__codelineno-52-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-52-1"><a id="__codelineno-52-1" name="__codelineno-52-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ComponentScanBeanDefinitionParser</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BeanDefinitionParser</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-2"><a id="__codelineno-52-2" name="__codelineno-52-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BeanDefinition</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">Element</span><span class="w"> </span><span class="n">element</span><span class="p">,</span><span class="w"> </span><span class="n">ParserContext</span><span class="w"> </span><span class="n">parserContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-52-3"><a id="__codelineno-52-3" name="__codelineno-52-3"></a><span class="w">        </span><span class="c1">// ...</span>
</span><span id="__span-52-4"><a id="__codelineno-52-4" name="__codelineno-52-4"></a><span class="w">        </span><span class="c1">// Actually scan for bean definitions and register them.</span>
</span><span id="__span-52-5"><a id="__codelineno-52-5" name="__codelineno-52-5"></a><span class="w">        </span><span class="n">ClassPathBeanDefinitionScanner</span><span class="w"> </span><span class="n">scanner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configureScanner</span><span class="p">(</span><span class="n">parserContext</span><span class="p">,</span><span class="w"> </span><span class="n">element</span><span class="p">);</span>
</span><span id="__span-52-6"><a id="__codelineno-52-6" name="__codelineno-52-6"></a><span class="w">        </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span><span class="w"> </span><span class="n">beanDefinitions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">scanner</span><span class="p">.</span><span class="na">doScan</span><span class="p">(</span><span class="n">basePackages</span><span class="p">);</span>
</span><span id="__span-52-7"><a id="__codelineno-52-7" name="__codelineno-52-7"></a><span class="w">        </span><span class="c1">// ...</span>
</span><span id="__span-52-8"><a id="__codelineno-52-8" name="__codelineno-52-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-52-9"><a id="__codelineno-52-9" name="__codelineno-52-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-53-1">1</a></span>
<span class="normal"><a href="#__codelineno-53-2">2</a></span>
<span class="normal"><a href="#__codelineno-53-3">3</a></span>
<span class="normal"><a href="#__codelineno-53-4">4</a></span>
<span class="normal"><a href="#__codelineno-53-5">5</a></span>
<span class="normal"><a href="#__codelineno-53-6">6</a></span>
<span class="normal"><a href="#__codelineno-53-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-53-1"><a id="__codelineno-53-1" name="__codelineno-53-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ClassPathBeanDefinitionScanner</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ClassPathScanningCandidateComponentProvider</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-2"><a id="__codelineno-53-2" name="__codelineno-53-2"></a><span class="w">    </span><span class="kd">protected</span><span class="w"> </span><span class="n">Set</span><span class="o">&lt;</span><span class="n">BeanDefinitionHolder</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">doScan</span><span class="p">(</span><span class="n">String</span><span class="p">...</span><span class="w"> </span><span class="n">basePackages</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-53-3"><a id="__codelineno-53-3" name="__codelineno-53-3"></a><span class="w">        </span><span class="c1">// ...</span>
</span><span id="__span-53-4"><a id="__codelineno-53-4" name="__codelineno-53-4"></a><span class="w">        </span><span class="n">registerBeanDefinition</span><span class="p">(</span><span class="n">definitionHolder</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">registry</span><span class="p">);</span>
</span><span id="__span-53-5"><a id="__codelineno-53-5" name="__codelineno-53-5"></a><span class="w">        </span><span class="c1">// ...</span>
</span><span id="__span-53-6"><a id="__codelineno-53-6" name="__codelineno-53-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-53-7"><a id="__codelineno-53-7" name="__codelineno-53-7"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>使用配置类配置组件扫描，使用AnnotationConfigApplicationContext容器在进行创建时，内部调用了如下代码， 该工具注册了几个Bean后处理器:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-54-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-54-1"><a id="__codelineno-54-1" name="__codelineno-54-1"></a><span class="n">AnnotationConfigUtils</span><span class="p">.</span><span class="na">registerAnnotationConfigProcessors</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">registry</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p><a class="glightbox" href="Spring/%E9%85%8D%E7%BD%AE%E7%B1%BB%E7%BB%84%E4%BB%B6%E6%89%AB%E6%8F%8F.jpeg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/%E9%85%8D%E7%BD%AE%E7%B1%BB%E7%BB%84%E4%BB%B6%E6%89%AB%E6%8F%8F.jpeg" /></a></p>
<p>其中，ConfigurationClassPostProcessor 是 一个 BeanDefinitionRegistryPostProcessor ，经过一系列源码调用，最终也别指定到了 ClassPathBeanDefinitionScanner 的 doScan 方法（与xml方式最终终点一致）</p>
<p><a class="glightbox" href="Spring/%E6%B3%A8%E8%A7%A3%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86.jpeg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/%E6%B3%A8%E8%A7%A3%E8%A7%A3%E6%9E%90%E5%8E%9F%E7%90%86.jpeg" /></a></p>
<h4 id="spring注解方式整合第三方框架">Spring注解方式整合第三方框架<a class="headerlink" href="#spring注解方式整合第三方框架" title="Permanent link"></a></h4>
<p>整合MyBatis：</p>
<p>使用@Bean将DataSource和SqlSessionFactoryBean存储到Spring容器中，而MapperScannerConfigurer使用注解@MapperScan进行指明需要扫描的Mapper在哪个包下，使用注解整合MyBatis配置方式如下：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-55-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-55-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-55-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-55-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-55-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-55-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-55-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-55-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-55-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-55-10">10</a></span>
<span class="normal"><a href="#__codelineno-55-11">11</a></span>
<span class="normal"><a href="#__codelineno-55-12">12</a></span>
<span class="normal"><a href="#__codelineno-55-13">13</a></span>
<span class="normal"><a href="#__codelineno-55-14">14</a></span>
<span class="normal"><a href="#__codelineno-55-15">15</a></span>
<span class="normal"><a href="#__codelineno-55-16">16</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-55-1"><a id="__codelineno-55-1" name="__codelineno-55-1"></a><span class="nd">@Configuration</span>
</span><span id="__span-55-2"><a id="__codelineno-55-2" name="__codelineno-55-2"></a><span class="nd">@ComponentScan</span><span class="p">(</span><span class="s">&quot;com.itheima&quot;</span><span class="p">)</span>
</span><span id="__span-55-3"><a id="__codelineno-55-3" name="__codelineno-55-3"></a><span class="nd">@MapperScan</span><span class="p">(</span><span class="s">&quot;com.itheima.mapper&quot;</span><span class="p">)</span>
</span><span id="__span-55-4"><a id="__codelineno-55-4" name="__codelineno-55-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ApplicationContextConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-55-5"><a id="__codelineno-55-5" name="__codelineno-55-5"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-55-6"><a id="__codelineno-55-6" name="__codelineno-55-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">DataSource</span><span class="w"> </span><span class="nf">dataSource</span><span class="p">(){</span>
</span><span id="__span-55-7"><a id="__codelineno-55-7" name="__codelineno-55-7"></a><span class="w">        </span><span class="n">DruidDataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DruidDataSource</span><span class="p">();</span>
</span><span id="__span-55-8"><a id="__codelineno-55-8" name="__codelineno-55-8"></a><span class="w">        </span><span class="c1">//省略部分代码</span>
</span><span id="__span-55-9"><a id="__codelineno-55-9" name="__codelineno-55-9"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dataSource</span><span class="p">;}</span>
</span><span id="__span-55-10"><a id="__codelineno-55-10" name="__codelineno-55-10"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-55-11"><a id="__codelineno-55-11" name="__codelineno-55-11"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SqlSessionFactoryBean</span><span class="w"> </span><span class="nf">sqlSessionFactoryBean</span><span class="p">(</span><span class="n">DataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="p">){</span>
</span><span id="__span-55-12"><a id="__codelineno-55-12" name="__codelineno-55-12"></a><span class="w">        </span><span class="n">SqlSessionFactoryBean</span><span class="w"> </span><span class="n">sqlSessionFactoryBean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SqlSessionFactoryBean</span><span class="p">();</span>
</span><span id="__span-55-13"><a id="__codelineno-55-13" name="__codelineno-55-13"></a><span class="w">        </span><span class="n">sqlSessionFactoryBean</span><span class="p">.</span><span class="na">setDataSource</span><span class="p">(</span><span class="n">dataSource</span><span class="p">);</span>
</span><span id="__span-55-14"><a id="__codelineno-55-14" name="__codelineno-55-14"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sqlSessionFactoryBean</span><span class="p">;</span>
</span><span id="__span-55-15"><a id="__codelineno-55-15" name="__codelineno-55-15"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-55-16"><a id="__codelineno-55-16" name="__codelineno-55-16"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>@MapperScan 源码：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-56-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-56-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-56-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-56-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-56-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-56-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-56-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-56-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-56-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-56-10">10</a></span>
<span class="normal"><a href="#__codelineno-56-11">11</a></span>
<span class="normal"><a href="#__codelineno-56-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-56-1"><a id="__codelineno-56-1" name="__codelineno-56-1"></a><span class="nd">@Retention</span><span class="p">(</span><span class="n">RetentionPolicy</span><span class="p">.</span><span class="na">RUNTIME</span><span class="p">)</span>
</span><span id="__span-56-2"><a id="__codelineno-56-2" name="__codelineno-56-2"></a><span class="nd">@Target</span><span class="p">({</span><span class="n">ElementType</span><span class="p">.</span><span class="na">TYPE</span><span class="p">})</span>
</span><span id="__span-56-3"><a id="__codelineno-56-3" name="__codelineno-56-3"></a><span class="nd">@Documented</span>
</span><span id="__span-56-4"><a id="__codelineno-56-4" name="__codelineno-56-4"></a><span class="nd">@Import</span><span class="p">({</span><span class="n">MapperScannerRegistrar</span><span class="p">.</span><span class="na">class</span><span class="p">})</span>
</span><span id="__span-56-5"><a id="__codelineno-56-5" name="__codelineno-56-5"></a><span class="nd">@Repeatable</span><span class="p">(</span><span class="n">MapperScans</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</span><span id="__span-56-6"><a id="__codelineno-56-6" name="__codelineno-56-6"></a><span class="kd">public</span><span class="w"> </span><span class="nd">@interface</span><span class="w"> </span><span class="n">MapperScan</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-56-7"><a id="__codelineno-56-7" name="__codelineno-56-7"></a><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="nf">value</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-56-8"><a id="__codelineno-56-8" name="__codelineno-56-8"></a><span class="w">    </span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="nf">basePackages</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-56-9"><a id="__codelineno-56-9" name="__codelineno-56-9"></a><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?&gt;[]</span><span class="w"> </span><span class="nf">basePackageClasses</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="p">{};</span>
</span><span id="__span-56-10"><a id="__codelineno-56-10" name="__codelineno-56-10"></a><span class="w">    </span><span class="n">Class</span><span class="o">&lt;?</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">Annotation</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">annotationClass</span><span class="p">()</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">Annotation</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
</span><span id="__span-56-11"><a id="__codelineno-56-11" name="__codelineno-56-11"></a><span class="w">    </span><span class="c1">// ... ...</span>
</span><span id="__span-56-12"><a id="__codelineno-56-12" name="__codelineno-56-12"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>当@MapperScan被扫描加载时，会解析@Import注解，从而加载指定的类，此处就是加载了MapperScannerRegistrar。</p>
<p>MapperScannerRegistrar 实现了 ImportBeanDefinitionRegistrar 接口，Spring会自动调用 registerBeanDefinitions方法，该方法中又注册MapperScannerConfigurer类，而MapperScannerConfigurer类作用是扫描Mapper，向容器中注册Mapper对应的MapperFactoryBean，...</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-57-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-57-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-57-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-57-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-57-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-57-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-57-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-57-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-57-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-57-10">10</a></span>
<span class="normal"><a href="#__codelineno-57-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-57-1"><a id="__codelineno-57-1" name="__codelineno-57-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MapperScannerRegistrar</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ImportBeanDefinitionRegistrar</span><span class="p">,</span><span class="w"> </span><span class="n">ResourceLoaderAware</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-2"><a id="__codelineno-57-2" name="__codelineno-57-2"></a><span class="w">    </span><span class="c1">//默认执行registerBeanDefinitions方法</span>
</span><span id="__span-57-3"><a id="__codelineno-57-3" name="__codelineno-57-3"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">registerBeanDefinitions</span><span class="p">(</span><span class="n">AnnotationMetadata</span><span class="w"> </span><span class="n">annoMeta</span><span class="p">,</span><span class="w"> </span><span class="n">AnnotationAttributes</span><span class="w"> </span><span class="n">annoAttrs</span><span class="p">,</span><span class="w"> </span>
</span><span id="__span-57-4"><a id="__codelineno-57-4" name="__codelineno-57-4"></a><span class="w">                                 </span><span class="n">BeanDefinitionRegistry</span><span class="w"> </span><span class="n">registry</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beanName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-57-5"><a id="__codelineno-57-5" name="__codelineno-57-5"></a><span class="w">        </span><span class="n">BeanDefinitionBuilder</span><span class="w"> </span><span class="n">builder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
</span><span id="__span-57-6"><a id="__codelineno-57-6" name="__codelineno-57-6"></a><span class="w">            </span><span class="n">BeanDefinitionBuilder</span><span class="p">.</span><span class="na">genericBeanDefinition</span><span class="p">(</span><span class="n">MapperScannerConfigurer</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-57-7"><a id="__codelineno-57-7" name="__codelineno-57-7"></a><span class="w">        </span><span class="c1">//... 省略其他代码 ...</span>
</span><span id="__span-57-8"><a id="__codelineno-57-8" name="__codelineno-57-8"></a><span class="w">        </span><span class="c1">//注册BeanDefinition</span>
</span><span id="__span-57-9"><a id="__codelineno-57-9" name="__codelineno-57-9"></a><span class="w">        </span><span class="n">registry</span><span class="p">.</span><span class="na">registerBeanDefinition</span><span class="p">(</span><span class="n">beanName</span><span class="p">,</span><span class="w"> </span><span class="n">builder</span><span class="p">.</span><span class="na">getBeanDefinition</span><span class="p">());</span>
</span><span id="__span-57-10"><a id="__codelineno-57-10" name="__codelineno-57-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-57-11"><a id="__codelineno-57-11" name="__codelineno-57-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>@Import可以导入如下三种类： </p>
<ul>
<li>普通的配置类 </li>
<li>实现ImportSelector接口的类：返回一个字符串数组，其中每个字符串都是需要被导入的配置类的全限定类名。</li>
<li>实现ImportBeanDefinitionRegistrar接口的类：可以注册BeanDefinition</li>
</ul>
<h2 id="aop">AOP<a class="headerlink" href="#aop" title="Permanent link"></a></h2>
<p>AOP能够将那些与业务无关，却为业务模块所共同调用的逻辑或责任（例如事务处理、日志管理、权限控制等）封装起来，便于减少系统的重复代码，降低模块间的耦合度，并有利于未来的可拓展性和可维护性。</p>
<p>Spring AOP 就是基于动态代理的，如果要代理的对象，实现了某个接口，那么 Spring AOP 会使用 JDK动态代理去创建代理对象，而对于没有实现接口的对象，Spring AOP 会使用 Cglib 生成一个被代理对象的子类来作为代理。</p>
<p>AOP思想的实现方案：</p>
<p><a class="glightbox" href="Spring/AOP%E6%80%9D%E6%83%B3%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88.jpeg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/AOP%E6%80%9D%E6%83%B3%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88.jpeg" /></a></p>
<p>AOP的其他实现：</p>
<ol>
<li>
<p>通过修改字节码实现，AspectJ 通过在编译阶段修改字节码的方式将切面逻辑直接织入到目标类中，是静态代理。</p>
</li>
<li>
<p>在类加载时通过特殊的类加载器将切面织入目标类。Java Agent通过在类加载时织入的方式动态增强现有类的行为。</p>
</li>
</ol>
<p>可以在BeanPostProcessor的after方法中使用动态代理对Bean进行增强，实际存储到单例池singleObjects中的不是当前目标对象本身，而是当前目标对象的代理对象Proxy，这样在调用目标对象方法时，实际调用的是代理对象Proxy的同名方法，起到了目标方法前后都进行增强的功能。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-58-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-58-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-58-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-58-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-58-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-58-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-58-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-58-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-58-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-58-10">10</a></span>
<span class="normal"><a href="#__codelineno-58-11">11</a></span>
<span class="normal"><a href="#__codelineno-58-12">12</a></span>
<span class="normal"><a href="#__codelineno-58-13">13</a></span>
<span class="normal"><a href="#__codelineno-58-14">14</a></span>
<span class="normal"><a href="#__codelineno-58-15">15</a></span>
<span class="normal"><a href="#__codelineno-58-16">16</a></span>
<span class="normal"><a href="#__codelineno-58-17">17</a></span>
<span class="normal"><a href="#__codelineno-58-18">18</a></span>
<span class="normal"><a href="#__codelineno-58-19">19</a></span>
<span class="normal"><a href="#__codelineno-58-20">20</a></span>
<span class="normal"><a href="#__codelineno-58-21">21</a></span>
<span class="normal"><a href="#__codelineno-58-22">22</a></span>
<span class="normal"><a href="#__codelineno-58-23">23</a></span>
<span class="normal"><a href="#__codelineno-58-24">24</a></span>
<span class="normal"><a href="#__codelineno-58-25">25</a></span>
<span class="normal"><a href="#__codelineno-58-26">26</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-58-1"><a id="__codelineno-58-1" name="__codelineno-58-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MockAopBeanPostProcessor</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">BeanPostProcessor</span><span class="p">,</span><span class="w"> </span><span class="n">ApplicationContextAware</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-2"><a id="__codelineno-58-2" name="__codelineno-58-2"></a><span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">;</span><span class="c1">//注入Spring容器对象</span>
</span><span id="__span-58-3"><a id="__codelineno-58-3" name="__codelineno-58-3"></a>
</span><span id="__span-58-4"><a id="__codelineno-58-4" name="__codelineno-58-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beanName</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-5"><a id="__codelineno-58-5" name="__codelineno-58-5"></a><span class="w">        </span><span class="n">MyAdvice</span><span class="w"> </span><span class="n">myAdvice</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">MyAdvice</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="c1">//获得Advice对象</span>
</span><span id="__span-58-6"><a id="__codelineno-58-6" name="__codelineno-58-6"></a><span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">packageName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getPackage</span><span class="p">().</span><span class="na">getName</span><span class="p">();</span>
</span><span id="__span-58-7"><a id="__codelineno-58-7" name="__codelineno-58-7"></a><span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="s">&quot;com.itheima.service.impl&quot;</span><span class="p">.</span><span class="na">equals</span><span class="p">(</span><span class="n">packageName</span><span class="p">)){</span>
</span><span id="__span-58-8"><a id="__codelineno-58-8" name="__codelineno-58-8"></a><span class="w">            </span><span class="c1">//对Bean进行动态代理，返回的是Proxy代理对象</span>
</span><span id="__span-58-9"><a id="__codelineno-58-9" name="__codelineno-58-9"></a><span class="w">            </span><span class="n">Object</span><span class="w"> </span><span class="n">proxyBean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span>
</span><span id="__span-58-10"><a id="__codelineno-58-10" name="__codelineno-58-10"></a><span class="w">                </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getClassLoader</span><span class="p">(),</span>
</span><span id="__span-58-11"><a id="__codelineno-58-11" name="__codelineno-58-11"></a><span class="w">                </span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">().</span><span class="na">getInterfaces</span><span class="p">(),</span>
</span><span id="__span-58-12"><a id="__codelineno-58-12" name="__codelineno-58-12"></a><span class="w">                </span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">proxy</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-13"><a id="__codelineno-58-13" name="__codelineno-58-13"></a><span class="w">                    </span><span class="n">myAdvice</span><span class="p">.</span><span class="na">beforeAdvice</span><span class="p">();</span><span class="c1">//执行Advice的before方法</span>
</span><span id="__span-58-14"><a id="__codelineno-58-14" name="__codelineno-58-14"></a><span class="w">                    </span><span class="n">Object</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">method</span><span class="p">.</span><span class="na">invoke</span><span class="p">(</span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">);</span><span class="c1">//执行目标</span>
</span><span id="__span-58-15"><a id="__codelineno-58-15" name="__codelineno-58-15"></a><span class="w">                    </span><span class="n">myAdvice</span><span class="p">.</span><span class="na">afterAdvice</span><span class="p">();</span><span class="c1">//执行Advice的after方法</span>
</span><span id="__span-58-16"><a id="__codelineno-58-16" name="__codelineno-58-16"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"> </span><span class="p">});</span>
</span><span id="__span-58-17"><a id="__codelineno-58-17" name="__codelineno-58-17"></a><span class="w">            </span><span class="c1">//返回代理对象</span>
</span><span id="__span-58-18"><a id="__codelineno-58-18" name="__codelineno-58-18"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">proxyBean</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-58-19"><a id="__codelineno-58-19" name="__codelineno-58-19"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-58-20"><a id="__codelineno-58-20" name="__codelineno-58-20"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-58-21"><a id="__codelineno-58-21" name="__codelineno-58-21"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-58-22"><a id="__codelineno-58-22" name="__codelineno-58-22"></a>
</span><span id="__span-58-23"><a id="__codelineno-58-23" name="__codelineno-58-23"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setApplicationContext</span><span class="p">(</span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-58-24"><a id="__codelineno-58-24" name="__codelineno-58-24"></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="na">applicationContext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">;</span><span class="w"> </span>
</span><span id="__span-58-25"><a id="__codelineno-58-25" name="__codelineno-58-25"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-58-26"><a id="__codelineno-58-26" name="__codelineno-58-26"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>相关概念：</p>
<p><a class="glightbox" href="Spring/AOP%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5.jpeg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/AOP%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5.jpeg" /></a></p>
<h3 id="基于xml配置的aop">基于xml配置的AOP<a class="headerlink" href="#基于xml配置的aop" title="Permanent link"></a></h3>
<p>xml方式配置AOP的步骤： </p>
<ol>
<li>导入AOP相关坐标: Spring-aop (Spring Context下包含spring aop) 和 aspectjweaver</li>
<li>准备目标类、准备增强类，并配置给Spring管理； </li>
<li>配置切点表达式（哪些方法被增强）； </li>
<li>配置织入（切点被哪些通知方法增强，是前置增强还是后置增强）</li>
</ol>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-59-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-59-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-59-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-59-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-59-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-59-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-59-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-59-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-59-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-59-10">10</a></span>
<span class="normal"><a href="#__codelineno-59-11">11</a></span>
<span class="normal"><a href="#__codelineno-59-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-59-1"><a id="__codelineno-59-1" name="__codelineno-59-1"></a><span class="nt">&lt;aop:config&gt;</span>
</span><span id="__span-59-2"><a id="__codelineno-59-2" name="__codelineno-59-2"></a><span class="w">    </span><span class="cm">&lt;!--配置切点表达式,对哪些方法进行增强--&gt;</span>
</span><span id="__span-59-3"><a id="__codelineno-59-3" name="__codelineno-59-3"></a><span class="w">    </span><span class="nt">&lt;aop:pointcut</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;myPointcut&quot;</span><span class="w"> </span><span class="na">expression=</span><span class="s">&quot;execution(void </span>
</span><span id="__span-59-4"><a id="__codelineno-59-4" name="__codelineno-59-4"></a><span class="s">                                              com.itheima.service.impl.UserServiceImpl.show1())&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-59-5"><a id="__codelineno-59-5" name="__codelineno-59-5"></a><span class="w">    </span><span class="cm">&lt;!--切面=切点+通知--&gt;</span>
</span><span id="__span-59-6"><a id="__codelineno-59-6" name="__codelineno-59-6"></a><span class="w">    </span><span class="nt">&lt;aop:aspect</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;myAdvice&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-59-7"><a id="__codelineno-59-7" name="__codelineno-59-7"></a><span class="w">        </span><span class="cm">&lt;!--指定前置通知方法是beforeAdvice--&gt;</span>
</span><span id="__span-59-8"><a id="__codelineno-59-8" name="__codelineno-59-8"></a><span class="w">        </span><span class="nt">&lt;aop:before</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;beforeAdvice&quot;</span><span class="w"> </span><span class="na">pointcut-ref=</span><span class="s">&quot;myPointcut&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-59-9"><a id="__codelineno-59-9" name="__codelineno-59-9"></a><span class="w">        </span><span class="cm">&lt;!--指定后置通知方法是afterAdvice--&gt;</span>
</span><span id="__span-59-10"><a id="__codelineno-59-10" name="__codelineno-59-10"></a><span class="w">        </span><span class="nt">&lt;aop:after-returning</span><span class="w"> </span><span class="na">method=</span><span class="s">&quot;afterAdvice&quot;</span><span class="w"> </span><span class="na">pointcut=</span><span class="s">&quot;execution(void                                                                                  com.itheima.service.impl.UserServiceImpl.show1())&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-59-11"><a id="__codelineno-59-11" name="__codelineno-59-11"></a><span class="w">    </span><span class="nt">&lt;/aop:aspect&gt;</span>
</span><span id="__span-59-12"><a id="__codelineno-59-12" name="__codelineno-59-12"></a><span class="nt">&lt;/aop:config&gt;</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="切入点表达式">切入点表达式<a class="headerlink" href="#切入点表达式" title="Permanent link"></a></h4>
<p>切点表达式是配置要对哪些连接点（哪些类的哪些方法）进行通知的增强。</p>
<p><a class="glightbox" href="Spring/%E5%88%87%E5%85%A5%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/%E5%88%87%E5%85%A5%E7%82%B9%E8%A1%A8%E8%BE%BE%E5%BC%8F.png" /></a></p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-60-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-60-1"><a id="__codelineno-60-1" name="__codelineno-60-1"></a>execution([访问修饰符]返回值类型 包名.类名.方法名(参数))
</span></code></pre></div></td></tr></table></div>
<ul>
<li>访问修饰符可以省略不写； </li>
<li>返回值类型、某一级包名、类名、方法名可以使用 * 表示任意； </li>
<li>包名与类名之间使用单点 . 表示该包下的类，使用双点 .. 表示该包及其子包下的类； </li>
<li>参数列表可以使用两个点 .. 表示任意参数</li>
</ul>
<h4 id="通知类型">通知类型<a class="headerlink" href="#通知类型" title="Permanent link"></a></h4>
<table>
<thead>
<tr>
<th>通知名称</th>
<th>配置方式</th>
<th>执行时机</th>
</tr>
</thead>
<tbody>
<tr>
<td>前置通知</td>
<td><code>&lt; aop:before &gt;</code></td>
<td>目标方法执行之前执行</td>
</tr>
<tr>
<td>后置通知</td>
<td><code>&lt; aop:after-returning &gt;</code></td>
<td>目标方法执行之后执行，目标方法异常时不再执行</td>
</tr>
<tr>
<td>环绕通知</td>
<td><code>&lt; aop:around &gt;</code></td>
<td>目标方法执行前后执行，目标方法异常时，环绕后方法不再执行</td>
</tr>
<tr>
<td>异常通知</td>
<td><code>&lt; aop:after-throwing &gt;</code></td>
<td>目标方法抛出异常时执行</td>
</tr>
<tr>
<td>最终通知</td>
<td><code>&lt; aop:after &gt;</code></td>
<td>不管目标方法是否有异常，最终都会执行</td>
</tr>
</tbody>
</table>
<p>通知方法在被调用时，Spring可以为其传递一些必要的参数：</p>
<table>
<thead>
<tr>
<th>参数类型</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>JoinPoint</td>
<td>连接点对象，任何通知都可使用，可以获得当前目标对象、目标方法参数等信息</td>
</tr>
<tr>
<td>ProceedingJoinPoint</td>
<td>JoinPoint子类对象，主要是在环绕通知中执行proceed()，进而执行目标方法</td>
</tr>
<tr>
<td>Throwable</td>
<td>异常对象，使用在异常通知中，需要在配置文件中指出异常对象名称</td>
</tr>
</tbody>
</table>
<h4 id="advice配置方式">Advice配置方式<a class="headerlink" href="#advice配置方式" title="Permanent link"></a></h4>
<p>AOP的另一种配置方式，该方式需要通知类实现Advice的子功能接口</p>
<p><a class="glightbox" href="Spring/advice%E6%8E%A5%E5%8F%A3.jpeg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/advice%E6%8E%A5%E5%8F%A3.jpeg" /></a></p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-61-1">1</a></span>
<span class="normal"><a href="#__codelineno-61-2">2</a></span>
<span class="normal"><a href="#__codelineno-61-3">3</a></span>
<span class="normal"><a href="#__codelineno-61-4">4</a></span>
<span class="normal"><a href="#__codelineno-61-5">5</a></span>
<span class="normal"><a href="#__codelineno-61-6">6</a></span>
<span class="normal"><a href="#__codelineno-61-7">7</a></span>
<span class="normal"><a href="#__codelineno-61-8">8</a></span>
<span class="normal"><a href="#__codelineno-61-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-61-1"><a id="__codelineno-61-1" name="__codelineno-61-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Advices</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">MethodBeforeAdvice</span><span class="p">,</span><span class="w"> </span><span class="n">AfterReturningAdvice</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-2"><a id="__codelineno-61-2" name="__codelineno-61-2"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">before</span><span class="p">(</span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-3"><a id="__codelineno-61-3" name="__codelineno-61-3"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;This is before Advice ...&quot;</span><span class="p">);</span>
</span><span id="__span-61-4"><a id="__codelineno-61-4" name="__codelineno-61-4"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-5"><a id="__codelineno-61-5" name="__codelineno-61-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterReturning</span><span class="p">(</span><span class="n">Object</span><span class="w"> </span><span class="n">o</span><span class="p">,</span><span class="w"> </span><span class="n">Method</span><span class="w"> </span><span class="n">method</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="o">[]</span><span class="w"> </span><span class="n">objects</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">o1</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span>
</span><span id="__span-61-6"><a id="__codelineno-61-6" name="__codelineno-61-6"></a><span class="w">        </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-61-7"><a id="__codelineno-61-7" name="__codelineno-61-7"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;This is afterReturn Advice ...&quot;</span><span class="p">);</span>
</span><span id="__span-61-8"><a id="__codelineno-61-8" name="__codelineno-61-8"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-61-9"><a id="__codelineno-61-9" name="__codelineno-61-9"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-62-1">1</a></span>
<span class="normal"><a href="#__codelineno-62-2">2</a></span>
<span class="normal"><a href="#__codelineno-62-3">3</a></span>
<span class="normal"><a href="#__codelineno-62-4">4</a></span>
<span class="normal"><a href="#__codelineno-62-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-62-1"><a id="__codelineno-62-1" name="__codelineno-62-1"></a><span class="nt">&lt;aop:config&gt;</span>
</span><span id="__span-62-2"><a id="__codelineno-62-2" name="__codelineno-62-2"></a><span class="w">    </span><span class="cm">&lt;!-- 将通知和切点进行结合 --&gt;</span>
</span><span id="__span-62-3"><a id="__codelineno-62-3" name="__codelineno-62-3"></a><span class="w">    </span><span class="nt">&lt;aop:advisor</span><span class="w"> </span><span class="na">advice-ref=</span><span class="s">&quot;advices&quot;</span><span class="w"> </span><span class="na">pointcut=</span><span class="s">&quot;execution(void </span>
</span><span id="__span-62-4"><a id="__codelineno-62-4" name="__codelineno-62-4"></a><span class="s">                                                com.itheima.aop.TargetImpl.show())&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-62-5"><a id="__codelineno-62-5" name="__codelineno-62-5"></a><span class="nt">&lt;/aop:config&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>使用aspect和advisor配置区别如下：</p>
<ol>
<li>配置语法不同：advisor通过实现接口来确定通知类型；aspect通过配置确定通知类型，更灵活。</li>
<li>可配置的切面数量不同： 一个advisor只能配置一个固定通知和一个切点表达式； 一个aspect可以配置多个通知和多个切点表达式任意组合，粒度更细。</li>
<li>使用场景不同：如果通知类型多、允许随意搭配情况下可以使用aspect进行配置； 如果通知类型单一、且通知类中通知方法一次性都会使用到的情况下可以使用advisor进行配置； 在通知类型已经固定，不用人为指定通知类型时，可以使用advisor进行配置，例如Spring事务控制的配置；</li>
</ol>
<h4 id="xml方式aop原理">xml方式AOP原理<a class="headerlink" href="#xml方式aop原理" title="Permanent link"></a></h4>
<p>1）通过xml方式配置AOP时，引入了AOP的命名空间，spring-aop包下的META-INF中的spring.handlers文件含命名空间处理器AopNamespaceHandler</p>
<p>2）AopNamespaceHandler的init方法中注册了config标签对应的解析器ConfigBeanDefinitionParser</p>
<p>3）以ConfigBeanDefinitionParser作为入口进行源码剖析，最终会注册一个AspectJAwareAdvisorAutoProxyCreator 进入到Spring容器中</p>
<p><a class="glightbox" href="Spring/AspectJAwareAdvisorAutoProxyCreator.png" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/AspectJAwareAdvisorAutoProxyCreator.png" /></a></p>
<p>AspectJAwareAdvisorAutoProxyCreator 的上上级父类AbstractAutoProxyCreator中的 postProcessAfterInitialization方法返回一个代理对象。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-63-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-63-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-63-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-63-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-63-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-63-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-63-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-63-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-63-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-63-10">10</a></span>
<span class="normal"><a href="#__codelineno-63-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-63-1"><a id="__codelineno-63-1" name="__codelineno-63-1"></a><span class="c1">//参数bean：为目标对象</span>
</span><span id="__span-63-2"><a id="__codelineno-63-2" name="__codelineno-63-2"></a><span class="kd">public</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="nf">postProcessAfterInitialization</span><span class="p">(</span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">beanName</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-3"><a id="__codelineno-63-3" name="__codelineno-63-3"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bean</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-4"><a id="__codelineno-63-4" name="__codelineno-63-4"></a><span class="w">        </span><span class="n">Object</span><span class="w"> </span><span class="n">cacheKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getCacheKey</span><span class="p">(</span><span class="n">bean</span><span class="p">.</span><span class="na">getClass</span><span class="p">(),</span><span class="w"> </span><span class="n">beanName</span><span class="p">);</span>
</span><span id="__span-63-5"><a id="__codelineno-63-5" name="__codelineno-63-5"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">earlyProxyReferences</span><span class="p">.</span><span class="na">remove</span><span class="p">(</span><span class="n">cacheKey</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">bean</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-63-6"><a id="__codelineno-63-6" name="__codelineno-63-6"></a><span class="w">            </span><span class="c1">//如果需要被增强，则wrapIfNecessary方法最终返回的就是一个Proxy对象</span>
</span><span id="__span-63-7"><a id="__codelineno-63-7" name="__codelineno-63-7"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">wrapIfNecessary</span><span class="p">(</span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">beanName</span><span class="p">,</span><span class="w"> </span><span class="n">cacheKey</span><span class="p">);</span>
</span><span id="__span-63-8"><a id="__codelineno-63-8" name="__codelineno-63-8"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-63-9"><a id="__codelineno-63-9" name="__codelineno-63-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-63-10"><a id="__codelineno-63-10" name="__codelineno-63-10"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean</span><span class="p">;</span>
</span><span id="__span-63-11"><a id="__codelineno-63-11" name="__codelineno-63-11"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>最终通过JDK动态代理或Cglib代理创建代理对象放入单例池中。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-64-1">1</a></span>
<span class="normal"><a href="#__codelineno-64-2">2</a></span>
<span class="normal"><a href="#__codelineno-64-3">3</a></span>
<span class="normal"><a href="#__codelineno-64-4">4</a></span>
<span class="normal"><a href="#__codelineno-64-5">5</a></span>
<span class="normal"><a href="#__codelineno-64-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-64-1"><a id="__codelineno-64-1" name="__codelineno-64-1"></a><span class="o">==&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">wrapIfNecessary</span><span class="p">(</span><span class="n">bean</span><span class="p">,</span><span class="w"> </span><span class="n">beanName</span><span class="p">,</span><span class="w"> </span><span class="n">cacheKey</span><span class="p">)</span>
</span><span id="__span-64-2"><a id="__codelineno-64-2" name="__codelineno-64-2"></a><span class="o">==&gt;</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">proxy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">createProxy</span><span class="p">(</span><span class="n">参数省略</span><span class="p">)</span>
</span><span id="__span-64-3"><a id="__codelineno-64-3" name="__codelineno-64-3"></a><span class="o">==&gt;</span><span class="w"> </span><span class="n">proxyFactory</span><span class="p">.</span><span class="na">getProxy</span><span class="p">(</span><span class="n">classLoader</span><span class="p">)</span>
</span><span id="__span-64-4"><a id="__codelineno-64-4" name="__codelineno-64-4"></a><span class="o">==&gt;</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">createAopProxy</span><span class="p">().</span><span class="na">getProxy</span><span class="p">(</span><span class="n">classLoader</span><span class="p">)</span>
</span><span id="__span-64-5"><a id="__codelineno-64-5" name="__codelineno-64-5"></a><span class="o">==&gt;</span><span class="w"> </span><span class="n">getProxy</span><span class="p">()</span><span class="n">是一个接口方法</span><span class="err">，</span><span class="n">实现类有两个JdkDynamicAopProxy和CglibAopProxy</span>
</span><span id="__span-64-6"><a id="__codelineno-64-6" name="__codelineno-64-6"></a><span class="o">==&gt;</span><span class="w"> </span><span class="n">Proxy</span><span class="p">.</span><span class="na">newProxyInstance</span><span class="p">(</span><span class="n">classLoader</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">proxiedInterfaces</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="基于注解配置的aop">基于注解配置的AOP<a class="headerlink" href="#基于注解配置的aop" title="Permanent link"></a></h3>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-65-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-65-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-65-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-65-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-65-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-65-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-65-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-65-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-65-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-65-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-65-1"><a id="__codelineno-65-1" name="__codelineno-65-1"></a><span class="nd">@Component</span>
</span><span id="__span-65-2"><a id="__codelineno-65-2" name="__codelineno-65-2"></a><span class="nd">@Aspect</span><span class="w"> </span><span class="c1">//第一步</span>
</span><span id="__span-65-3"><a id="__codelineno-65-3" name="__codelineno-65-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AnnoAdvice</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-4"><a id="__codelineno-65-4" name="__codelineno-65-4"></a><span class="w">    </span><span class="nd">@Around</span><span class="p">(</span><span class="s">&quot;execution(* com.itheima.aop.*.*(..))&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">//第二步</span>
</span><span id="__span-65-5"><a id="__codelineno-65-5" name="__codelineno-65-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">around</span><span class="p">(</span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-65-6"><a id="__codelineno-65-6" name="__codelineno-65-6"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;环绕前通知...&quot;</span><span class="p">);</span>
</span><span id="__span-65-7"><a id="__codelineno-65-7" name="__codelineno-65-7"></a><span class="w">        </span><span class="n">joinPoint</span><span class="p">.</span><span class="na">proceed</span><span class="p">();</span>
</span><span id="__span-65-8"><a id="__codelineno-65-8" name="__codelineno-65-8"></a><span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;环绕后通知...&quot;</span><span class="p">);</span>
</span><span id="__span-65-9"><a id="__codelineno-65-9" name="__codelineno-65-9"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-65-10"><a id="__codelineno-65-10" name="__codelineno-65-10"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>注解@Aspect、@Around需要被Spring解析，所以在Spring核心配置文件中需要配置aspectj的自动代理:</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-66-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-66-1"><a id="__codelineno-66-1" name="__codelineno-66-1"></a><span class="nt">&lt;aop:aspectj-autoproxy/&gt;</span><span class="w"> </span><span class="cm">&lt;!--第三步--&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>如果核心配置使用的是配置类的话，需要配置注解方式的aop自动代理:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-67-1">1</a></span>
<span class="normal"><a href="#__codelineno-67-2">2</a></span>
<span class="normal"><a href="#__codelineno-67-3">3</a></span>
<span class="normal"><a href="#__codelineno-67-4">4</a></span>
<span class="normal"><a href="#__codelineno-67-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-67-1"><a id="__codelineno-67-1" name="__codelineno-67-1"></a><span class="nd">@Configuration</span>
</span><span id="__span-67-2"><a id="__codelineno-67-2" name="__codelineno-67-2"></a><span class="nd">@ComponentScan</span><span class="p">(</span><span class="s">&quot;com.itheima.aop&quot;</span><span class="p">)</span>
</span><span id="__span-67-3"><a id="__codelineno-67-3" name="__codelineno-67-3"></a><span class="nd">@EnableAspectJAutoProxy</span><span class="w"> </span><span class="c1">//第三步</span>
</span><span id="__span-67-4"><a id="__codelineno-67-4" name="__codelineno-67-4"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ApplicationContextConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-67-5"><a id="__codelineno-67-5" name="__codelineno-67-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>通知类型：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-68-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-68-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-68-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-68-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-68-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-68-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-68-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-68-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-68-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-68-10">10</a></span>
<span class="normal"><a href="#__codelineno-68-11">11</a></span>
<span class="normal"><a href="#__codelineno-68-12">12</a></span>
<span class="normal"><a href="#__codelineno-68-13">13</a></span>
<span class="normal"><a href="#__codelineno-68-14">14</a></span>
<span class="normal"><a href="#__codelineno-68-15">15</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-68-1"><a id="__codelineno-68-1" name="__codelineno-68-1"></a><span class="c1">//前置通知</span>
</span><span id="__span-68-2"><a id="__codelineno-68-2" name="__codelineno-68-2"></a><span class="nd">@Before</span><span class="p">(</span><span class="s">&quot;execution(* com.itheima.aop.*.*(..))&quot;</span><span class="p">)</span>
</span><span id="__span-68-3"><a id="__codelineno-68-3" name="__codelineno-68-3"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">before</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">){}</span>
</span><span id="__span-68-4"><a id="__codelineno-68-4" name="__codelineno-68-4"></a><span class="c1">//后置通知</span>
</span><span id="__span-68-5"><a id="__codelineno-68-5" name="__codelineno-68-5"></a><span class="nd">@AfterReturning</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s">&quot;execution(* com.itheima.aop.*.*(..))&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;retValue&quot;</span><span class="p">)</span>
</span><span id="__span-68-6"><a id="__codelineno-68-6" name="__codelineno-68-6"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">AfterReturning</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">,</span><span class="w"> </span><span class="n">Object</span><span class="w"> </span><span class="n">retValue</span><span class="p">){}</span>
</span><span id="__span-68-7"><a id="__codelineno-68-7" name="__codelineno-68-7"></a><span class="c1">//环绕通知</span>
</span><span id="__span-68-8"><a id="__codelineno-68-8" name="__codelineno-68-8"></a><span class="nd">@Around</span><span class="p">(</span><span class="s">&quot;execution(* com.itheima.aop.*.*(..))&quot;</span><span class="p">)</span>
</span><span id="__span-68-9"><a id="__codelineno-68-9" name="__codelineno-68-9"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">around</span><span class="p">(</span><span class="n">ProceedingJoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="p">{}</span>
</span><span id="__span-68-10"><a id="__codelineno-68-10" name="__codelineno-68-10"></a><span class="c1">//异常通知</span>
</span><span id="__span-68-11"><a id="__codelineno-68-11" name="__codelineno-68-11"></a><span class="nd">@AfterThrowing</span><span class="p">(</span><span class="n">pointcnt</span><span class="o">=</span><span class="s">&quot;execution(* com.itheima.aop.*.*(..))&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">throwing</span><span class="o">=</span><span class="s">&quot;e&quot;</span><span class="p">)</span>
</span><span id="__span-68-12"><a id="__codelineno-68-12" name="__codelineno-68-12"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">AfterThrowing</span><span class="p">(</span><span class="n">Throwable</span><span class="w"> </span><span class="n">e</span><span class="p">){}</span>
</span><span id="__span-68-13"><a id="__codelineno-68-13" name="__codelineno-68-13"></a><span class="c1">//最终通知</span>
</span><span id="__span-68-14"><a id="__codelineno-68-14" name="__codelineno-68-14"></a><span class="nd">@After</span><span class="p">(</span><span class="s">&quot;execution(* com.itheima.aop.*.*(..))&quot;</span><span class="p">)</span>
</span><span id="__span-68-15"><a id="__codelineno-68-15" name="__codelineno-68-15"></a><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">After</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">){}</span>
</span></code></pre></div></td></tr></table></div>
<p>切点表达式的抽取，使用一个空方法，将切点表达式标注在空方法上，其他通知方法引用即可:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-69-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-69-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-69-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-69-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-69-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-69-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-69-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-69-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-69-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-69-10">10</a></span>
<span class="normal"><a href="#__codelineno-69-11">11</a></span>
<span class="normal"><a href="#__codelineno-69-12">12</a></span>
<span class="normal"><a href="#__codelineno-69-13">13</a></span>
<span class="normal"><a href="#__codelineno-69-14">14</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-69-1"><a id="__codelineno-69-1" name="__codelineno-69-1"></a><span class="nd">@Component</span>
</span><span id="__span-69-2"><a id="__codelineno-69-2" name="__codelineno-69-2"></a><span class="nd">@Aspect</span>
</span><span id="__span-69-3"><a id="__codelineno-69-3" name="__codelineno-69-3"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AnnoAdvice</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-69-4"><a id="__codelineno-69-4" name="__codelineno-69-4"></a><span class="w">    </span><span class="c1">//切点表达式抽取</span>
</span><span id="__span-69-5"><a id="__codelineno-69-5" name="__codelineno-69-5"></a><span class="w">    </span><span class="nd">@Pointcut</span><span class="p">(</span><span class="s">&quot;execution(* com.itheima.aop.*.*(..))&quot;</span><span class="p">)</span>
</span><span id="__span-69-6"><a id="__codelineno-69-6" name="__codelineno-69-6"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pointcut</span><span class="p">(){}</span>
</span><span id="__span-69-7"><a id="__codelineno-69-7" name="__codelineno-69-7"></a><span class="w">    </span><span class="c1">//前置通知</span>
</span><span id="__span-69-8"><a id="__codelineno-69-8" name="__codelineno-69-8"></a><span class="w">    </span><span class="nd">@Before</span><span class="p">(</span><span class="s">&quot;pointcut()&quot;</span><span class="p">)</span>
</span><span id="__span-69-9"><a id="__codelineno-69-9" name="__codelineno-69-9"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">before</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">){}</span>
</span><span id="__span-69-10"><a id="__codelineno-69-10" name="__codelineno-69-10"></a><span class="w">    </span><span class="c1">//后置通知</span>
</span><span id="__span-69-11"><a id="__codelineno-69-11" name="__codelineno-69-11"></a><span class="w">    </span><span class="nd">@AfterReturning</span><span class="p">(</span><span class="s">&quot;AnnoAdvice.pointcut()&quot;</span><span class="p">)</span>
</span><span id="__span-69-12"><a id="__codelineno-69-12" name="__codelineno-69-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">AfterReturning</span><span class="p">(</span><span class="n">JoinPoint</span><span class="w"> </span><span class="n">joinPoint</span><span class="p">){}</span>
</span><span id="__span-69-13"><a id="__codelineno-69-13" name="__codelineno-69-13"></a><span class="w">    </span><span class="c1">// ... 省略其他代码 ...</span>
</span><span id="__span-69-14"><a id="__codelineno-69-14" name="__codelineno-69-14"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h4 id="注解方式aop原理">注解方式AOP原理<a class="headerlink" href="#注解方式aop原理" title="Permanent link"></a></h4>
<p>在使用xml配置AOP时，是借助的Spring的外部命名空间的加载方式完成的，该标签最终加载了名为AspectJAwareAdvisorAutoProxyCreator 的 BeanPostProcessor ，最终在该BeanPostProcessor中完成了代理对象的生成。</p>
<p>如果使用 <code>&lt;aop:aspectj-autoproxy/&gt;</code> 标签开启aop aspectj的自动代理，同样从aspectj-autoproxy标签的解析器入手：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-70-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-70-1"><a id="__codelineno-70-1" name="__codelineno-70-1"></a><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;aspectj-autoproxy&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">AspectJAutoProxyBeanDefinitionParser</span><span class="p">());</span>
</span></code></pre></div></td></tr></table></div>
<p>而AspectJAutoProxyBeanDefinitionParser代码内部，最终也是执行了和xml方式AOP一样的代码: </p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-71-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-71-1"><a id="__codelineno-71-1" name="__codelineno-71-1"></a><span class="n">registerOrEscalateApcAsRequired</span><span class="p">(</span><span class="n">AnnotationAwareAspectJAutoProxyCreator</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">registry</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p>注册一个AnnotationAwareAspectJAutoProxyCreator（是AspectJAwareAdvisorAutoProxyCreator的子类） 进入到Spring容器中，然后postProcessAfterInitialization 方法返回一个代理对象放入单例池。</p>
<p>如果使用的是核心配置类的话，查看@EnableAspectJAutoProxy源码，使用的是@Import导入相关解析类AspectJAutoProxyRegistrar，而AspectJAutoProxyRegistrar类最终也是注册了 AnnotationAwareAspectJAutoProxyCreator 这个类：</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-72-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-72-1"><a id="__codelineno-72-1" name="__codelineno-72-1"></a><span class="n">registerOrEscalateApcAsRequired</span><span class="p">(</span><span class="n">AnnotationAwareAspectJAutoProxyCreator</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">registry</span><span class="p">,</span><span class="w"> </span><span class="n">source</span><span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<p><a class="glightbox" href="Spring/AOP%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90.jpeg" data-type="image" data-width="auto" data-height="auto" data-desc-position="bottom"><img alt="" src="Spring/AOP%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90.jpeg" /></a></p>
<h3 id="基于aop的声明式事务控制">基于AOP的声明式事务控制<a class="headerlink" href="#基于aop的声明式事务控制" title="Permanent link"></a></h3>
<p>Spring事务编程相关的类主要有如下三个:</p>
<table>
<thead>
<tr>
<th>事务控制相关类</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>平台事务管理器 PlatformTransactionManager</td>
<td>是一个接口标准，实现类都具备事务提交、回滚和获得事务对象的功能，不同持久层框架可能会有不同实现方案</td>
</tr>
<tr>
<td>事务定义 TransactionDefinition</td>
<td>封装事务的隔离级别、传播行为、过期时间等属性信息</td>
</tr>
<tr>
<td>事务状态 TransactionStatus</td>
<td>存储当前事务的状态信息，如果事务是否提交、是否回滚、是否有回滚点等</td>
</tr>
</tbody>
</table>
<h4 id="基于xml声明式事务控制">基于xml声明式事务控制<a class="headerlink" href="#基于xml声明式事务控制" title="Permanent link"></a></h4>
<p>结合AOP技术，很容易就可以想到，可以使用AOP对Service的方法进行事务的增强：</p>
<ul>
<li>目标类：自己定义的类</li>
<li>切点：业务类中的所有业务方法 </li>
<li>通知类：Spring提供的，通知方法已经定义好，只需要配置即可</li>
</ul>
<p>步骤： </p>
<ol>
<li>通知类是Spring提供的，需要导入Spring事务的相关的坐标：导入Spring事务的相关的坐标，spring-jdbc坐标已经引入的spring-tx坐标</li>
<li>配置目标类放入Spring容器 </li>
<li>使用advisor标签配置切面。</li>
</ol>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-73-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-73-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-73-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-73-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-73-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-73-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-73-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-73-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-73-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-73-10">10</a></span>
<span class="normal"><a href="#__codelineno-73-11">11</a></span>
<span class="normal"><a href="#__codelineno-73-12">12</a></span>
<span class="normal"><a href="#__codelineno-73-13">13</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-73-1"><a id="__codelineno-73-1" name="__codelineno-73-1"></a><span class="cm">&lt;!--平台事务管理器--&gt;</span>
</span><span id="__span-73-2"><a id="__codelineno-73-2" name="__codelineno-73-2"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-73-3"><a id="__codelineno-73-3" name="__codelineno-73-3"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-73-4"><a id="__codelineno-73-4" name="__codelineno-73-4"></a><span class="nt">&lt;/bean&gt;</span>
</span><span id="__span-73-5"><a id="__codelineno-73-5" name="__codelineno-73-5"></a><span class="cm">&lt;!--Spring提供的事务通知--&gt;</span>
</span><span id="__span-73-6"><a id="__codelineno-73-6" name="__codelineno-73-6"></a><span class="nt">&lt;tx:advice</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;txAdvice&quot;</span><span class="w"> </span><span class="na">transaction-manager=</span><span class="s">&quot;transactionManager&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-73-7"><a id="__codelineno-73-7" name="__codelineno-73-7"></a><span class="w">    </span><span class="nt">&lt;tx:attributes&gt;</span>
</span><span id="__span-73-8"><a id="__codelineno-73-8" name="__codelineno-73-8"></a><span class="w">        </span><span class="nt">&lt;tx:method</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;transferMoney&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-73-9"><a id="__codelineno-73-9" name="__codelineno-73-9"></a><span class="w">    </span><span class="nt">&lt;/tx:attributes&gt;</span>
</span><span id="__span-73-10"><a id="__codelineno-73-10" name="__codelineno-73-10"></a><span class="nt">&lt;/tx:advice&gt;</span>
</span><span id="__span-73-11"><a id="__codelineno-73-11" name="__codelineno-73-11"></a><span class="nt">&lt;aop:config&gt;</span>
</span><span id="__span-73-12"><a id="__codelineno-73-12" name="__codelineno-73-12"></a><span class="w">    </span><span class="nt">&lt;aop:advisor</span><span class="w"> </span><span class="na">advice-ref=</span><span class="s">&quot;txAdvice&quot;</span><span class="w"> </span><span class="na">pointcut=</span><span class="s">&quot;execution(* com.itheima.service.impl.*.*(..))&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-73-13"><a id="__codelineno-73-13" name="__codelineno-73-13"></a><span class="nt">&lt;/aop:config&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>平台事务管理器PlatformTransactionManager是Spring提供的封装事务具体操作的规范接口，封装了事 务的提交和回滚方法。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-74-1">1</a></span>
<span class="normal"><a href="#__codelineno-74-2">2</a></span>
<span class="normal"><a href="#__codelineno-74-3">3</a></span>
<span class="normal"><a href="#__codelineno-74-4">4</a></span>
<span class="normal"><a href="#__codelineno-74-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-74-1"><a id="__codelineno-74-1" name="__codelineno-74-1"></a><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">PlatformTransactionManager</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">TransactionManager</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-74-2"><a id="__codelineno-74-2" name="__codelineno-74-2"></a><span class="w">    </span><span class="n">TransactionStatus</span><span class="w"> </span><span class="nf">getTransaction</span><span class="p">(</span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">TransactionDefinition</span><span class="w"> </span><span class="n">var1</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransactionException</span><span class="p">;</span>
</span><span id="__span-74-3"><a id="__codelineno-74-3" name="__codelineno-74-3"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">commit</span><span class="p">(</span><span class="n">TransactionStatus</span><span class="w"> </span><span class="n">var1</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransactionException</span><span class="p">;</span>
</span><span id="__span-74-4"><a id="__codelineno-74-4" name="__codelineno-74-4"></a><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">rollback</span><span class="p">(</span><span class="n">TransactionStatus</span><span class="w"> </span><span class="n">var1</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">TransactionException</span><span class="p">;</span>
</span><span id="__span-74-5"><a id="__codelineno-74-5" name="__codelineno-74-5"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>不同的持久层框架事务操作的方式有可能不同，所以不同的持久层框架有可能会有不同的平台事务管理器实现， 例如，MyBatis作为持久层框架时，使用的平台事务管理器实现是DataSourceTransactionManager。 Hibernate作为持久层框架时，使用的平台事务管理器是HibernateTransactionManager。</p>
<p>每个事务有很多特性，例如：隔离级别、只读状态、超时时间等，这些信息在开发时可以通过connection进行指定，而此处要通过配置文件进行配置.</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-75-1">1</a></span>
<span class="normal"><a href="#__codelineno-75-2">2</a></span>
<span class="normal"><a href="#__codelineno-75-3">3</a></span>
<span class="normal"><a href="#__codelineno-75-4">4</a></span>
<span class="normal"><a href="#__codelineno-75-5">5</a></span>
<span class="normal"><a href="#__codelineno-75-6">6</a></span>
<span class="normal"><a href="#__codelineno-75-7">7</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-75-1"><a id="__codelineno-75-1" name="__codelineno-75-1"></a><span class="nt">&lt;tx:attributes&gt;</span>
</span><span id="__span-75-2"><a id="__codelineno-75-2" name="__codelineno-75-2"></a><span class="w">    </span><span class="nt">&lt;tx:method</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;方法名称&quot;</span>
</span><span id="__span-75-3"><a id="__codelineno-75-3" name="__codelineno-75-3"></a><span class="w">               </span><span class="na">isolation=</span><span class="s">&quot;隔离级别&quot;</span>
</span><span id="__span-75-4"><a id="__codelineno-75-4" name="__codelineno-75-4"></a><span class="w">               </span><span class="na">propagation=</span><span class="s">&quot;传播行为&quot;</span>
</span><span id="__span-75-5"><a id="__codelineno-75-5" name="__codelineno-75-5"></a><span class="w">               </span><span class="na">read-only=</span><span class="s">&quot;只读状态&quot;</span>
</span><span id="__span-75-6"><a id="__codelineno-75-6" name="__codelineno-75-6"></a><span class="w">               </span><span class="na">timeout=</span><span class="s">&quot;超时时间&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-75-7"><a id="__codelineno-75-7" name="__codelineno-75-7"></a><span class="nt">&lt;/tx:attributes&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>name属性：指定哪个方法要进行哪些事务的属性配置，此处需要区分的是切点表达式指定的方法与此处指定的方法的区别？切点表达式，是过滤哪些方法可以进行事务增强；事务属性信息的name，是指定哪个方法要进行哪些事务属性的配置。</p>
<p>read-only属性：设置当前的只读状态，如果是查询则设置为true，可以提高查询性能，如果是更新（增删改）操作则设置为false</p>
<p>timeout属性：设置事务执行的超时时间，单位是秒，如果超过该时间限制但事务还没有完成，则自动回滚事务 ，不在继续执行。默认值是-1，即没有超时时间限制。</p>
<p><strong>隔离级别</strong>：</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEFAULT</td>
<td>默认隔离级别，取决于当前数据库隔离级别，例如MySQL默认隔离级别是REPEATABLE_READ</td>
</tr>
<tr>
<td>READ_UNCOMMITTED 读未提交</td>
<td>A事务可以读取到B事务尚未提交的事务记录，会导致脏读、不可重读读、幻读</td>
</tr>
<tr>
<td>READ_COMMITTED 读已提交</td>
<td>A事务只能读取到其他事务已经提交的记录。可以解决脏读问题，但是不能解决不可重复读和幻读</td>
</tr>
<tr>
<td>REPEATABLE_READ 可重复读</td>
<td>A事务多次从数据库读取某条记录结果一致，可以解决脏读、不可重复读，不可以解决幻读</td>
</tr>
<tr>
<td>SERIALIZABLE 串行化</td>
<td>强制事务按顺序执行</td>
</tr>
</tbody>
</table>
<p>数据库是可以控制事务的传播和隔离级别的，Spring在之上又进一步进行了封装，可以在不同的项目、不同的操作中再次对事务的传播行为和隔离级别进行策略控制；
项目中Spring 的事务隔离级别与数据库的隔离级别不一致时，以 Spring 事务为准，因为他重写了数据库的隔离级别，但没有直接修改数据库的隔离级别；
项目中，如果 Spring 事务隔离级别设置为（isolation = Isolation.DEFAULT）默认，则以数据库的隔离级别为准。</p>
<p><strong>传播行为</strong>：</p>
<p>指在多个事务方法相互调用时，控制事务如何传播和影响彼此的行为的规则</p>
<table>
<thead>
<tr>
<th>传播行为</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>REQUIRED（默认值）</td>
<td>A调用B，B需要事务，如果A有事务B就加入A的事务中，如果A没有事务，B就自己创建一个事务。<strong>没有就新建，有就加入</strong></td>
</tr>
<tr>
<td>REQUIRED_NEW</td>
<td>A调用B，B需要新事务，如果A有事务就挂起，B自己创建一个新的事务。<strong>挂起之前事务，开启新事务</strong></td>
</tr>
<tr>
<td>SUPPORTS</td>
<td>A调用B，B有无事务无所谓，A有事务就加入到A事务中，A无事务B就以非事务方式执行。<strong>有无事务无所谓</strong></td>
</tr>
<tr>
<td>NOT_SUPPORTS</td>
<td>A调用B，B以无事务方式执行，A如有事务则挂起。<strong>挂起之前事务，无事务方式执行</strong></td>
</tr>
<tr>
<td>NEVER</td>
<td>A调用B，B以无事务方式执行，A如有事务则抛出异常。<strong>有抛出异常，无事务方式执行</strong></td>
</tr>
<tr>
<td>MANDATORY</td>
<td>A调用B，B要加入A的事务中，如果A无事务就抛出异常。<strong>有就加入，没有就抛异常</strong></td>
</tr>
<tr>
<td>NESTED</td>
<td>A调用B，B创建一个新事务，A有事务就作为嵌套事务存在，A没事务就以创建的新事务执行。</td>
</tr>
</tbody>
</table>
<p>xml方式声明式事务控制的原理：</p>
<p><code>&lt;tx:advice&gt;</code> 标签使用的命名空间处理器是TxNamespaceHandler，内部注册的是解析器是 TxAdviceBeanDefinitionParser</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-76-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-76-1"><a id="__codelineno-76-1" name="__codelineno-76-1"></a><span class="k">this</span><span class="p">.</span><span class="na">registerBeanDefinitionParser</span><span class="p">(</span><span class="s">&quot;advice&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">TxAdviceBeanDefinitionParser</span><span class="p">());</span>
</span></code></pre></div></td></tr></table></div>
<p>TxAdviceBeanDefinitionParser中指定了要注册的BeanDefinition:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-77-1">1</a></span>
<span class="normal"><a href="#__codelineno-77-2">2</a></span>
<span class="normal"><a href="#__codelineno-77-3">3</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-77-1"><a id="__codelineno-77-1" name="__codelineno-77-1"></a><span class="kd">protected</span><span class="w"> </span><span class="n">Class</span><span class="o">&lt;?&gt;</span><span class="w"> </span><span class="nf">getBeanClass</span><span class="p">(</span><span class="n">Element</span><span class="w"> </span><span class="n">element</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-77-2"><a id="__codelineno-77-2" name="__codelineno-77-2"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">TransactionInterceptor</span><span class="p">.</span><span class="na">class</span><span class="p">;</span>
</span><span id="__span-77-3"><a id="__codelineno-77-3" name="__codelineno-77-3"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>TxAdviceBeanDefinitionParser二级父类AbstractBeanDefinitionParser的parse方法将TransactionInterceptor 以配置的名称注册到了Spring容器中</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-78-1">1</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-78-1"><a id="__codelineno-78-1" name="__codelineno-78-1"></a><span class="n">parserContext</span><span class="p">.</span><span class="na">registerComponent</span><span class="p">(</span><span class="n">componentDefinition</span><span class="p">);</span>
</span></code></pre></div></td></tr></table></div>
<p>TransactionInterceptor中的invoke方法会被执行，跟踪invoke方法，最终会看到事务的开启和提交。</p>
<h4 id="基于注解声明式事务控制">基于注解声明式事务控制<a class="headerlink" href="#基于注解声明式事务控制" title="Permanent link"></a></h4>
<p>@Transactional 可用在方法或者类上，同样，使用的事务的注解，平台事务管理器仍然需要配置，还需要进行事务注解开关的开启</p>
<div class="language-xml highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-79-1">1</a></span>
<span class="normal"><a href="#__codelineno-79-2">2</a></span>
<span class="normal"><a href="#__codelineno-79-3">3</a></span>
<span class="normal"><a href="#__codelineno-79-4">4</a></span>
<span class="normal"><a href="#__codelineno-79-5">5</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-79-1"><a id="__codelineno-79-1" name="__codelineno-79-1"></a><span class="nt">&lt;bean</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;transactionManager&quot;</span><span class="w"> </span><span class="na">class=</span><span class="s">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span><span class="nt">&gt;</span>
</span><span id="__span-79-2"><a id="__codelineno-79-2" name="__codelineno-79-2"></a><span class="w">    </span><span class="nt">&lt;property</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;dataSource&quot;</span><span class="w"> </span><span class="na">ref=</span><span class="s">&quot;dataSource&quot;</span><span class="nt">/&gt;</span>
</span><span id="__span-79-3"><a id="__codelineno-79-3" name="__codelineno-79-3"></a><span class="nt">&lt;/bean&gt;</span>
</span><span id="__span-79-4"><a id="__codelineno-79-4" name="__codelineno-79-4"></a><span class="cm">&lt;!--配置事务的注解驱动--&gt;</span>
</span><span id="__span-79-5"><a id="__codelineno-79-5" name="__codelineno-79-5"></a><span class="nt">&lt;tx:annotation-driven</span><span class="w"> </span><span class="na">transaction-manager=</span><span class="s">&quot;transactionManager&quot;</span><span class="nt">/&gt;</span>
</span></code></pre></div></td></tr></table></div>
<p>如果使用全注解的话，使用如下配置类的形式代替配置文件:</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-80-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-80-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-80-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-80-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-80-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-80-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-80-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-80-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-80-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-80-10">10</a></span>
<span class="normal"><a href="#__codelineno-80-11">11</a></span>
<span class="normal"><a href="#__codelineno-80-12">12</a></span>
<span class="normal"><a href="#__codelineno-80-13">13</a></span>
<span class="normal"><a href="#__codelineno-80-14">14</a></span>
<span class="normal"><a href="#__codelineno-80-15">15</a></span>
<span class="normal"><a href="#__codelineno-80-16">16</a></span>
<span class="normal"><a href="#__codelineno-80-17">17</a></span>
<span class="normal"><a href="#__codelineno-80-18">18</a></span>
<span class="normal"><a href="#__codelineno-80-19">19</a></span>
<span class="normal"><a href="#__codelineno-80-20">20</a></span>
<span class="normal"><a href="#__codelineno-80-21">21</a></span>
<span class="normal"><a href="#__codelineno-80-22">22</a></span>
<span class="normal"><a href="#__codelineno-80-23">23</a></span>
<span class="normal"><a href="#__codelineno-80-24">24</a></span>
<span class="normal"><a href="#__codelineno-80-25">25</a></span>
<span class="normal"><a href="#__codelineno-80-26">26</a></span>
<span class="normal"><a href="#__codelineno-80-27">27</a></span>
<span class="normal"><a href="#__codelineno-80-28">28</a></span>
<span class="normal"><a href="#__codelineno-80-29">29</a></span>
<span class="normal"><a href="#__codelineno-80-30">30</a></span>
<span class="normal"><a href="#__codelineno-80-31">31</a></span>
<span class="normal"><a href="#__codelineno-80-32">32</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-80-1"><a id="__codelineno-80-1" name="__codelineno-80-1"></a><span class="nd">@Configuration</span>
</span><span id="__span-80-2"><a id="__codelineno-80-2" name="__codelineno-80-2"></a><span class="nd">@ComponentScan</span><span class="p">(</span><span class="s">&quot;com.itheima.service&quot;</span><span class="p">)</span>
</span><span id="__span-80-3"><a id="__codelineno-80-3" name="__codelineno-80-3"></a><span class="nd">@PropertySource</span><span class="p">(</span><span class="s">&quot;classpath:jdbc.properties&quot;</span><span class="p">)</span>
</span><span id="__span-80-4"><a id="__codelineno-80-4" name="__codelineno-80-4"></a><span class="nd">@MapperScan</span><span class="p">(</span><span class="s">&quot;com.itheima.mapper&quot;</span><span class="p">)</span>
</span><span id="__span-80-5"><a id="__codelineno-80-5" name="__codelineno-80-5"></a><span class="nd">@EnableTransactionManagement</span>
</span><span id="__span-80-6"><a id="__codelineno-80-6" name="__codelineno-80-6"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">ApplicationContextConfig</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-80-7"><a id="__codelineno-80-7" name="__codelineno-80-7"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-80-8"><a id="__codelineno-80-8" name="__codelineno-80-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">DataSource</span><span class="w"> </span><span class="nf">dataSource</span><span class="p">(</span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${atguigu.url}&quot;</span><span class="p">)</span><span class="n">String</span><span class="w"> </span><span class="n">url</span><span class="p">,</span>
</span><span id="__span-80-9"><a id="__codelineno-80-9" name="__codelineno-80-9"></a><span class="w">                                 </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${atguigu.driver}&quot;</span><span class="p">)</span><span class="n">String</span><span class="w"> </span><span class="n">driver</span><span class="p">,</span>
</span><span id="__span-80-10"><a id="__codelineno-80-10" name="__codelineno-80-10"></a><span class="w">                                 </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${atguigu.username}&quot;</span><span class="p">)</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">,</span>
</span><span id="__span-80-11"><a id="__codelineno-80-11" name="__codelineno-80-11"></a><span class="w">                                 </span><span class="nd">@Value</span><span class="p">(</span><span class="s">&quot;${atguigu.password}&quot;</span><span class="p">)</span><span class="n">String</span><span class="w"> </span><span class="n">password</span><span class="p">){</span>
</span><span id="__span-80-12"><a id="__codelineno-80-12" name="__codelineno-80-12"></a><span class="w">        </span><span class="n">DruidDataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DruidDataSource</span><span class="p">();</span>
</span><span id="__span-80-13"><a id="__codelineno-80-13" name="__codelineno-80-13"></a><span class="w">        </span><span class="n">dataSource</span><span class="p">.</span><span class="na">setDriverClassName</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
</span><span id="__span-80-14"><a id="__codelineno-80-14" name="__codelineno-80-14"></a><span class="w">        </span><span class="n">dataSource</span><span class="p">.</span><span class="na">setUrl</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
</span><span id="__span-80-15"><a id="__codelineno-80-15" name="__codelineno-80-15"></a><span class="w">        </span><span class="n">dataSource</span><span class="p">.</span><span class="na">setUsername</span><span class="p">(</span><span class="n">username</span><span class="p">);</span>
</span><span id="__span-80-16"><a id="__codelineno-80-16" name="__codelineno-80-16"></a><span class="w">        </span><span class="n">dataSource</span><span class="p">.</span><span class="na">setPassword</span><span class="p">(</span><span class="n">password</span><span class="p">);</span>
</span><span id="__span-80-17"><a id="__codelineno-80-17" name="__codelineno-80-17"></a>
</span><span id="__span-80-18"><a id="__codelineno-80-18" name="__codelineno-80-18"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">dataSource</span><span class="p">;</span>
</span><span id="__span-80-19"><a id="__codelineno-80-19" name="__codelineno-80-19"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-80-20"><a id="__codelineno-80-20" name="__codelineno-80-20"></a>
</span><span id="__span-80-21"><a id="__codelineno-80-21" name="__codelineno-80-21"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-80-22"><a id="__codelineno-80-22" name="__codelineno-80-22"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">SqlSessionFactoryBean</span><span class="w"> </span><span class="nf">sqlSessionFactoryBean</span><span class="p">(</span><span class="n">DataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-80-23"><a id="__codelineno-80-23" name="__codelineno-80-23"></a><span class="w">        </span><span class="n">SqlSessionFactoryBean</span><span class="w"> </span><span class="n">sqlSessionFactoryBean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">SqlSessionFactoryBean</span><span class="p">();</span>
</span><span id="__span-80-24"><a id="__codelineno-80-24" name="__codelineno-80-24"></a><span class="w">        </span><span class="n">sqlSessionFactoryBean</span><span class="p">.</span><span class="na">setDataSource</span><span class="p">(</span><span class="n">dataSource</span><span class="p">);</span>
</span><span id="__span-80-25"><a id="__codelineno-80-25" name="__codelineno-80-25"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">sqlSessionFactoryBean</span><span class="p">;</span>
</span><span id="__span-80-26"><a id="__codelineno-80-26" name="__codelineno-80-26"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-80-27"><a id="__codelineno-80-27" name="__codelineno-80-27"></a>
</span><span id="__span-80-28"><a id="__codelineno-80-28" name="__codelineno-80-28"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-80-29"><a id="__codelineno-80-29" name="__codelineno-80-29"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">TransactionManager</span><span class="w"> </span><span class="nf">transactionManager</span><span class="p">(</span><span class="n">DataSource</span><span class="w"> </span><span class="n">dataSource</span><span class="p">){</span>
</span><span id="__span-80-30"><a id="__codelineno-80-30" name="__codelineno-80-30"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">DataSourceTransactionManager</span><span class="p">(</span><span class="n">dataSource</span><span class="p">);</span>
</span><span id="__span-80-31"><a id="__codelineno-80-31" name="__codelineno-80-31"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-80-32"><a id="__codelineno-80-32" name="__codelineno-80-32"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p><strong>Spring事务什么情况下会失效？</strong></p>
<ol>
<li><code>@Transactional</code> 注解默认回滚策略是只有在遇到<code>RuntimeException</code>(运行时异常) 或者 <code>Error</code> 时才会回滚事务，而不会回滚 <code>Checked Exception</code>（受检查异常）。</li>
<li>spring的事务在抛异常的时候会回滚，如果是catch捕获了，事务无效。可以在catch里面加上throw new RuntimeException();</li>
<li>同一个类中的方法调用事务会失效。同一个类的实例方法中直接调用另一个带有<code>@Transactional</code>注解的方法时，调用是通过<code>this</code>引用直接完成的，这样就绕过了代理，不会经过事务处理。</li>
<li>@Transactional应用在非public方法上，事务失效</li>
<li>@Transactional应用在final和static方法上，事务失效。AOP（Spring默认JDK动态代理，SpringBoot默认CGLIB）默认CGLIB，无法对final方法子类化，static属于类，无法被代理。</li>
<li>传播机制配置错误</li>
<li>多线程环境，@Transactional是基于ThreadLocal存储上下文的，多线程环境下每个线程都有自己的上下文，事务失效</li>
<li>存储引擎不支持</li>
</ol>
<p><a href="https://www.marcobehler.com/guides/spring-transaction-management-transactional-in-depth">Spring Transaction Management: @Transactional In-Depth</a></p>
<h4 id="原理">原理<a class="headerlink" href="#原理" title="Permanent link"></a></h4>
<p><code>@Transactional</code> 的工作机制是基于 AOP 实现的。如果目标对象实现了接口，默认情况下会采用 JDK 的动态代理，如果目标对象没有实现了接口,会使用 CGLIB 动态代理。</p>
<p>如果一个类或者一个类中的 public 方法上被标注<code>@Transactional</code> 注解的话，Spring 容器就会在启动的时候为其创建一个代理类，在调用被<code>@Transactional</code> 注解的 public 方法的时候，实际调用的是，<code>TransactionInterceptor</code> 类中的 <code>invoke()</code>方法。这个方法的作用就是在目标方法之前开启事务，方法执行过程中如果遇到异常的时候回滚事务，方法调用完成之后提交事务。</p>
<h2 id="其他">其他<a class="headerlink" href="#其他" title="Permanent link"></a></h2>
<h3 id="autowired-失效">@Autowired 失效<a class="headerlink" href="#autowired-失效" title="Permanent link"></a></h3>
<p>Java配置类在添加了 BeanFactory 后处理器后，传统接口方式的注入和初始化仍然成功，而@Autowired 和 @PostConstruct 的注入和初始化失败</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-81-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-81-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-81-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-81-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-81-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-81-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-81-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-81-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-81-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-81-10">10</a></span>
<span class="normal"><a href="#__codelineno-81-11">11</a></span>
<span class="normal"><a href="#__codelineno-81-12">12</a></span>
<span class="normal"><a href="#__codelineno-81-13">13</a></span>
<span class="normal"><a href="#__codelineno-81-14">14</a></span>
<span class="normal"><a href="#__codelineno-81-15">15</a></span>
<span class="normal"><a href="#__codelineno-81-16">16</a></span>
<span class="normal"><a href="#__codelineno-81-17">17</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-81-1"><a id="__codelineno-81-1" name="__codelineno-81-1"></a><span class="nd">@Configuration</span>
</span><span id="__span-81-2"><a id="__codelineno-81-2" name="__codelineno-81-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyConfig1</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-3"><a id="__codelineno-81-3" name="__codelineno-81-3"></a><span class="w">    </span><span class="nd">@Autowired</span>
</span><span id="__span-81-4"><a id="__codelineno-81-4" name="__codelineno-81-4"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setApplicationContext</span><span class="p">(</span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-5"><a id="__codelineno-81-5" name="__codelineno-81-5"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;注入 ApplicationContext&quot;</span><span class="p">)</span>
</span><span id="__span-81-6"><a id="__codelineno-81-6" name="__codelineno-81-6"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-81-7"><a id="__codelineno-81-7" name="__codelineno-81-7"></a><span class="w">    </span><span class="nd">@PostConstruct</span>
</span><span id="__span-81-8"><a id="__codelineno-81-8" name="__codelineno-81-8"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-9"><a id="__codelineno-81-9" name="__codelineno-81-9"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;初始化&quot;</span><span class="p">);</span>
</span><span id="__span-81-10"><a id="__codelineno-81-10" name="__codelineno-81-10"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-81-11"><a id="__codelineno-81-11" name="__codelineno-81-11"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-81-12"><a id="__codelineno-81-12" name="__codelineno-81-12"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BeanFactoryPostProcessor</span><span class="w"> </span><span class="nf">processor1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-13"><a id="__codelineno-81-13" name="__codelineno-81-13"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">beanFactory</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-81-14"><a id="__codelineno-81-14" name="__codelineno-81-14"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;执行processor1&quot;</span><span class="p">);</span>
</span><span id="__span-81-15"><a id="__codelineno-81-15" name="__codelineno-81-15"></a><span class="w">        </span><span class="p">};</span>
</span><span id="__span-81-16"><a id="__codelineno-81-16" name="__codelineno-81-16"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-81-17"><a id="__codelineno-81-17" name="__codelineno-81-17"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<p>配置类@Autowired失效分析：</p>
<p>Java配置类不包含BeanFactoryPostProcessor的情况：</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-82-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-82-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-82-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-82-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-82-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-82-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-82-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-82-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-82-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-82-10">10</a></span>
<span class="normal"><a href="#__codelineno-82-11">11</a></span>
<span class="normal"><a href="#__codelineno-82-12">12</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-82-1"><a id="__codelineno-82-1" name="__codelineno-82-1"></a>sequenceDiagram
</span><span id="__span-82-2"><a id="__codelineno-82-2" name="__codelineno-82-2"></a>    participant ApplicationContext
</span><span id="__span-82-3"><a id="__codelineno-82-3" name="__codelineno-82-3"></a>    participant BeanFactoryPostProcessor
</span><span id="__span-82-4"><a id="__codelineno-82-4" name="__codelineno-82-4"></a>    participant BeanPostProcessor
</span><span id="__span-82-5"><a id="__codelineno-82-5" name="__codelineno-82-5"></a>    participant Java配置类
</span><span id="__span-82-6"><a id="__codelineno-82-6" name="__codelineno-82-6"></a>    ApplicationContext -&gt;&gt; BeanFactoryPostProcessor: 1.执行BeanFactoryPostProcessor
</span><span id="__span-82-7"><a id="__codelineno-82-7" name="__codelineno-82-7"></a>    ApplicationContext -&gt;&gt; BeanPostProcessor: 2. 注册BeanPostProcessor
</span><span id="__span-82-8"><a id="__codelineno-82-8" name="__codelineno-82-8"></a>    ApplicationContext -&gt;&gt; Java配置类: 3. 创建和初始化
</span><span id="__span-82-9"><a id="__codelineno-82-9" name="__codelineno-82-9"></a>    BeanPostProcessor -&gt;&gt; Java配置类: 3.1 依赖注入扩展（如@Value @Autowired）
</span><span id="__span-82-10"><a id="__codelineno-82-10" name="__codelineno-82-10"></a>    BeanPostProcessor -&gt;&gt; Java配置类: 3.2 初始化扩展（如@PostConstruct）
</span><span id="__span-82-11"><a id="__codelineno-82-11" name="__codelineno-82-11"></a>    ApplicationContext -&gt;&gt; Java配置类: 3.3 执行Aware 及 InitializationBean
</span><span id="__span-82-12"><a id="__codelineno-82-12" name="__codelineno-82-12"></a>    Java配置类 --&gt;&gt; ApplicationContext: 4. 创建成功
</span></code></pre></div></td></tr></table></div>
<p>Java配置类中包含BeanFactoryPostProcessor的情况，要创建BeanFactoryPostProcessor必须提前创建Java配置类，而此时的BeanPostProcessor 还未准备好，导致@Autowired等注解失效。</p>
<div class="language-text highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-83-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-83-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-83-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-83-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-83-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-83-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-83-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-83-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-83-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-83-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-83-1"><a id="__codelineno-83-1" name="__codelineno-83-1"></a>sequenceDiagram
</span><span id="__span-83-2"><a id="__codelineno-83-2" name="__codelineno-83-2"></a>    participant ApplicationContext
</span><span id="__span-83-3"><a id="__codelineno-83-3" name="__codelineno-83-3"></a>    participant BeanFactoryPostProcessor
</span><span id="__span-83-4"><a id="__codelineno-83-4" name="__codelineno-83-4"></a>    participant BeanPostProcessor
</span><span id="__span-83-5"><a id="__codelineno-83-5" name="__codelineno-83-5"></a>    participant Java配置类
</span><span id="__span-83-6"><a id="__codelineno-83-6" name="__codelineno-83-6"></a>    ApplicationContext -&gt;&gt; Java配置类: 3. 创建和初始化
</span><span id="__span-83-7"><a id="__codelineno-83-7" name="__codelineno-83-7"></a>    ApplicationContext -&gt;&gt; Java配置类: 3.1 执行Aware 及 InitializationBean
</span><span id="__span-83-8"><a id="__codelineno-83-8" name="__codelineno-83-8"></a>    Java配置类 --&gt;&gt; ApplicationContext: 3.2 创建成功
</span><span id="__span-83-9"><a id="__codelineno-83-9" name="__codelineno-83-9"></a>    ApplicationContext -&gt;&gt; BeanFactoryPostProcessor: 1.执行BeanFactoryPostProcessor
</span><span id="__span-83-10"><a id="__codelineno-83-10" name="__codelineno-83-10"></a>    ApplicationContext -&gt;&gt; BeanPostProcessor: 2. 注册BeanPostProcessor
</span></code></pre></div></td></tr></table></div>
<p>解决方法：使用内置的接口方式的注入和初始化，内置的注入和初始化不受扩展功能影响，总会被执行。</p>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-84-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-84-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-84-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-84-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-84-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-84-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-84-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-84-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-84-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-84-10">10</a></span>
<span class="normal"><a href="#__codelineno-84-11">11</a></span>
<span class="normal"><a href="#__codelineno-84-12">12</a></span>
<span class="normal"><a href="#__codelineno-84-13">13</a></span>
<span class="normal"><a href="#__codelineno-84-14">14</a></span>
<span class="normal"><a href="#__codelineno-84-15">15</a></span>
<span class="normal"><a href="#__codelineno-84-16">16</a></span>
<span class="normal"><a href="#__codelineno-84-17">17</a></span>
<span class="normal"><a href="#__codelineno-84-18">18</a></span>
<span class="normal"><a href="#__codelineno-84-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-84-1"><a id="__codelineno-84-1" name="__codelineno-84-1"></a><span class="nd">@Configuration</span>
</span><span id="__span-84-2"><a id="__codelineno-84-2" name="__codelineno-84-2"></a><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Config2</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">InitializingBean</span><span class="p">,</span><span class="w"> </span><span class="n">ApplicationContextAware</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-3"><a id="__codelineno-84-3" name="__codelineno-84-3"></a>
</span><span id="__span-84-4"><a id="__codelineno-84-4" name="__codelineno-84-4"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-84-5"><a id="__codelineno-84-5" name="__codelineno-84-5"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterPropertiesSet</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-6"><a id="__codelineno-84-6" name="__codelineno-84-6"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;初始化&quot;</span><span class="p">);</span>
</span><span id="__span-84-7"><a id="__codelineno-84-7" name="__codelineno-84-7"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-84-8"><a id="__codelineno-84-8" name="__codelineno-84-8"></a>
</span><span id="__span-84-9"><a id="__codelineno-84-9" name="__codelineno-84-9"></a><span class="w">    </span><span class="nd">@Override</span>
</span><span id="__span-84-10"><a id="__codelineno-84-10" name="__codelineno-84-10"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">setApplicationContext</span><span class="p">(</span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">applicationContext</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">BeansException</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-11"><a id="__codelineno-84-11" name="__codelineno-84-11"></a><span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;注入 ApplicationContext&quot;</span><span class="p">)</span>
</span><span id="__span-84-12"><a id="__codelineno-84-12" name="__codelineno-84-12"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-84-13"><a id="__codelineno-84-13" name="__codelineno-84-13"></a><span class="w">    </span><span class="nd">@Bean</span>
</span><span id="__span-84-14"><a id="__codelineno-84-14" name="__codelineno-84-14"></a><span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">BeanFactoryPostProcessor</span><span class="w"> </span><span class="nf">processor1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-15"><a id="__codelineno-84-15" name="__codelineno-84-15"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">beanFactory</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-84-16"><a id="__codelineno-84-16" name="__codelineno-84-16"></a><span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">debug</span><span class="p">(</span><span class="s">&quot;执行processor1&quot;</span><span class="p">);</span>
</span><span id="__span-84-17"><a id="__codelineno-84-17" name="__codelineno-84-17"></a><span class="w">        </span><span class="p">};</span>
</span><span id="__span-84-18"><a id="__codelineno-84-18" name="__codelineno-84-18"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-84-19"><a id="__codelineno-84-19" name="__codelineno-84-19"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="scope-失效">@Scope 失效<a class="headerlink" href="#scope-失效" title="Permanent link"></a></h3>
<p>单例注入多例时会失效</p>
<p>因为对于单例对象来讲，依赖注入只会发生一次，使用的始终是第一次注入的多例对象。</p>
<p>解决：理念都是相同的，都是推迟其他 scope bean 的获取</p>
<ol>
<li>
<p>仍然使用 @Lazy 生成代理。代理对象虽然还是同一个，但当每次使用代理对象的任意方法时，由代理创建新的对象</p>
</li>
<li>
<p><code>@Scope(value="prototype", proxyMode="ScopedProxyMode.TARGET_CLASS")</code></p>
</li>
<li>
<p>使用对象工厂</p>
</li>
</ol>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-85-1">1</a></span>
<span class="normal"><a href="#__codelineno-85-2">2</a></span>
<span class="normal"><a href="#__codelineno-85-3">3</a></span>
<span class="normal"><a href="#__codelineno-85-4">4</a></span>
<span class="normal"><a href="#__codelineno-85-5">5</a></span>
<span class="normal"><a href="#__codelineno-85-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-85-1"><a id="__codelineno-85-1" name="__codelineno-85-1"></a><span class="nd">@Autowired</span>
</span><span id="__span-85-2"><a id="__codelineno-85-2" name="__codelineno-85-2"></a><span class="kd">private</span><span class="w"> </span><span class="n">ObjectFactory</span><span class="o">&lt;</span><span class="n">Bean1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bean1</span><span class="p">;</span>
</span><span id="__span-85-3"><a id="__codelineno-85-3" name="__codelineno-85-3"></a>
</span><span id="__span-85-4"><a id="__codelineno-85-4" name="__codelineno-85-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">Bean1</span><span class="w"> </span><span class="nf">getBean1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-85-5"><a id="__codelineno-85-5" name="__codelineno-85-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">bean1</span><span class="p">.</span><span class="na">getObject</span><span class="p">();</span>
</span><span id="__span-85-6"><a id="__codelineno-85-6" name="__codelineno-85-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<ol>
<li>注入Spring容器</li>
</ol>
<div class="language-java highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-86-1">1</a></span>
<span class="normal"><a href="#__codelineno-86-2">2</a></span>
<span class="normal"><a href="#__codelineno-86-3">3</a></span>
<span class="normal"><a href="#__codelineno-86-4">4</a></span>
<span class="normal"><a href="#__codelineno-86-5">5</a></span>
<span class="normal"><a href="#__codelineno-86-6">6</a></span></pre></div></td><td class="code"><div><pre><span></span><code><span id="__span-86-1"><a id="__codelineno-86-1" name="__codelineno-86-1"></a><span class="nd">@Autowired</span>
</span><span id="__span-86-2"><a id="__codelineno-86-2" name="__codelineno-86-2"></a><span class="kd">private</span><span class="w"> </span><span class="n">ApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="p">;</span>
</span><span id="__span-86-3"><a id="__codelineno-86-3" name="__codelineno-86-3"></a>
</span><span id="__span-86-4"><a id="__codelineno-86-4" name="__codelineno-86-4"></a><span class="kd">public</span><span class="w"> </span><span class="n">Bean1</span><span class="w"> </span><span class="nf">getBean1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-86-5"><a id="__codelineno-86-5" name="__codelineno-86-5"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="na">getBean</span><span class="p">(</span><span class="n">Bean1</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</span><span id="__span-86-6"><a id="__codelineno-86-6" name="__codelineno-86-6"></a><span class="p">}</span>
</span></code></pre></div></td></tr></table></div>
<h3 id="设计模式">设计模式<a class="headerlink" href="#设计模式" title="Permanent link"></a></h3>
<p>工厂模式：核心容器使用了工厂模式，通过BeanFactory和ApplicationContext实现对对象的创建和管理。</p>
<p>单例模式：默认情况下Spring bean都是单例的。</p>
<p>代理模式：AOP通过JDK动态代理或者CGLIB字节码生成技术来创建目标对象的代理。</p>
<p>模板方法模式：JdbcTemplate为数据库操作提供一个模板，可以重写定制具体的操作逻辑。</p>
<p>观察者模式：Spring的事件发布/订阅机制，ApplicationContext可以发布事件，而任何实现了ApplicationListenner接口的bean都可以注册为监听器来接收这些事件。</p>
<p>责任链模式：SpringMVC中的拦截器，多个拦截器串联起来就形成责任链。</p>







  
  



  


  


  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              
              
                
                
              
              Thanks for your feedback! Help us improve this page by using our <a href="..." target="_blank" rel="noopener">feedback form</a>.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2019 - 2024 wang
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["content.action.edit", "content.code.copy", "content.code.select", "content.tabs.link", "navigation.tabs", "navigation.instant", "navigation.path", "toc.follow"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>